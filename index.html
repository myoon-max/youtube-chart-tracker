<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <style>
        :root { --bg-color: #F5F7FA; --card-bg: #FFFFFF; --text-main: #1A1A1A; --text-sub: #5F6368; --primary: #E62117; --blue: #1A73E8; --green: #1E8E3E; --border: #E0E0E0; --shadow: 0 2px 12px rgba(0,0,0,0.04); }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; min-height: 100vh; }
        .container { max-width: 1800px; margin: 0 auto; padding: 80px 20px 100px; }
        header { display: flex; flex-direction: column; align-items: center; margin-bottom: 60px; border-bottom: 1px solid #eee; padding-bottom: 40px; position: relative; }
        h1 { margin: 0 0 15px 0; font-weight: 900; font-size: 3rem; letter-spacing: -1px; color: var(--text-main); text-transform: uppercase; }
        h1 span { color: var(--primary); }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .date-badge { display: inline-block; background: #fff; padding: 8px 20px; border-radius: 30px; border: 1px solid var(--border); color: var(--text-sub); font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow); }
        .toggle-wrapper { display: flex; align-items: center; background: #fff; border: 1px solid var(--border); padding: 5px 10px 5px 5px; border-radius: 30px; box-shadow: var(--shadow); cursor: pointer; }
        .toggle-wrapper label { font-size: 0.9rem; font-weight: 700; color: #333; margin-left: 8px; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; text-align: center; background: #f9f9f9; }
        .login-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #app-content { display: none; opacity: 0; transition: opacity 0.5s; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; transition: all 0.3s; }
        .summary-grid.no-revenue { grid-template-columns: repeat(2, 1fr); }
        .kpi-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-label { font-size: 0.85rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .kpi-value.money { color: var(--green); }
        .kpi-value.kr { color: var(--blue); }
        .kpi-value.us { color: var(--primary); }
        .kpi-sub { font-size: 0.8rem; color: #888; margin-top: 5px; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 50px; }
        .tab-btn { padding: 12px 28px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 30px; cursor: pointer; font-weight: 700; font-size: 1rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn.active { background: #333; color: #fff; border-color: #333; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); padding: 30px; margin-bottom: 30px; border: 1px solid var(--border); }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .control-group label { font-weight: bold; font-size: 0.9rem; margin-right: 8px; color: #333; }
        input, select { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; background: #fff; color: #333; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; white-space: nowrap; }
        th { background: #F8F9FA; color: #333; padding: 16px; text-align: center; font-weight: 800; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 10; cursor: pointer; }
        th:hover { background: #eee; }
        td { padding: 14px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        tr:hover { background-color: #f1f3f5; cursor: pointer; }
        
        .rank-up { color: #D32F2F; font-weight: bold; background: #FFEBEE; padding: 2px 6px; border-radius: 4px; }
        .rank-down { color: #1976D2; font-weight: bold; background: #E3F2FD; padding: 2px 6px; border-radius: 4px; }
        .money-text { color: var(--green); font-weight: 800; font-family: 'Montserrat'; }
        .highlight-cut { background: #FFF8E1; font-weight: bold; border-left: 3px solid #FFC107; }
        
        .matrix-rank { font-weight: 900; color: #000000; font-size: 1.1rem; }
        .matrix-null { color: #ddd; }
        .platform-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; color: #fff; font-size: 0.8rem; margin-right: 5px; }
        
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: #fff; margin: 2vh auto; width: 90%; max-width: 1300px; height: 92vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 25px 35px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 20px 20px 0 0; }
        .modal-title h2 { margin: 0; font-size: 1.8rem; color: #000; }
        .modal-title p { margin: 5px 0 0 0; color: #666; font-size: 1.1rem; }
        .close-btn { font-size: 36px; color: #aaa; cursor: pointer; } .close-btn:hover { color: #000; }
        .modal-body { padding: 35px; overflow-y: auto; flex: 1; background: #FAFAFA; }
        #detailModal th { background-color: #333 !important; color: #fff !important; }
        
        .yt-btn { background: #FF0000; color: #fff; padding: 8px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255,0,0,0.2); transition: background 0.2s; }
        .yt-btn:hover { background: #cc0000; }
        
        .info-icon { display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; background: #ddd; color: #fff; font-size: 12px; font-weight: bold; margin-left: 6px; cursor: help; position: relative; }
        .info-icon:hover::after { content: attr(data-tooltip); position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 10px 14px; border-radius: 6px; font-size: 0.8rem; white-space: pre-line; width: 320px; z-index: 100; font-weight: normal; line-height: 1.5; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* ëª¨ë‹¬ ë‚´ë¶€ ì°¨íŠ¸ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
        .chart-stack { display: flex; flex-direction: column; gap: 30px; margin-bottom: 40px; }
        .chart-box { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); }
        .chart-box.wide { width: 100%; height: 400px; display: flex; flex-direction: column; }
        .chart-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; color: #333; border-left: 4px solid var(--primary); padding-left: 12px; }
        
        .search-wrapper { position: relative; margin-left: auto; width: 300px; }
        .search-wrapper input { width: 100%; padding-left: 40px; border-radius: 20px; border: 1px solid #ddd; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        .footer-info { text-align: center; color: #888; margin-top: 40px; font-size: 0.85rem; padding-top: 20px; border-top: 1px solid #ddd; }
        .price-tag { display: inline-block; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; margin: 0 5px; font-weight: 600; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 class="login-title" style="color:#000; margin-bottom:10px;">MUSICDEAL <span style="color:var(--primary)">ADMIN</span></h2>
        <input type="password" id="passwordInput" class="login-input" placeholder="Access Key" onkeyup="if(window.event.keyCode==13){checkLogin()}">
        <button class="login-btn" onclick="checkLogin()">ì ‘ì†í•˜ê¸°</button>
        <p id="login-msg" style="color:var(--primary); margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="app-content" class="container">
    <header>
        <h1>MUSICDEAL <span>ANALYTICS</span></h1>
        <div class="header-controls">
            <div class="date-badge">ìµœì¢… ì—…ë°ì´íŠ¸: <span id="header-date">-</span></div>
            <div class="toggle-wrapper">
                <label class="switch">
                    <input type="checkbox" id="revenue-toggle" onchange="toggleRevenue()">
                    <span class="slider"></span>
                </label>
                <label for="revenue-toggle">ğŸ’° ìˆ˜ìµ ë¶„ì„</label>
            </div>
        </div>
    </header>

    <div class="summary-grid" id="kpi-container">
        <div class="kpi-card" id="card-market" style="border-top: 4px solid var(--green);">
            <span class="kpi-label">ğŸ’° Market Size (Top 100 Only)</span>
            <div class="kpi-value money" id="total-revenue">-</div>
            <div class="kpi-sub">ì°¨íŠ¸ ë‚´ ê³¡ë“¤ì˜ ì¼ê°„ ì¶”ì • ë§¤ì¶œ í•©ê³„</div>
        </div>
        <div class="kpi-card" id="card-kr">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR Revenue Share</span>
            <div class="kpi-value kr" id="kr-revenue">-</div>
        </div>
        <div class="kpi-card" id="card-us">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US Revenue Share</span>
            <div class="kpi-value us" id="us-revenue">-</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR MV Entry Cut</span>
            <div class="kpi-value kr" id="kr-mv-cut">-</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US MV Entry Cut</span>
            <div class="kpi-value us" id="us-mv-cut">-</div>
        </div>
        <div class="kpi-card" id="card-dup">
            <span class="kpi-label">âš ï¸ Global Duplicate Blocked</span>
            <div class="kpi-value" id="dup-blocked" style="color:var(--primary)">-</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily', this)">ğŸ“… ë°ì¼ë¦¬ & ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="openTab('cross', this)">ğŸŒ í†µí•© ë­í‚¹ (Matrix)</button>
        <button class="tab-btn" onclick="openTab('trend', this)">ğŸ“ˆ ì›”ê°„/ì—°ê°„ ì¶”ì´</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">âš¡ ì‡¼ì¸  ë°”ì´ëŸ´</button>
        <button class="tab-btn" onclick="openTab('long-run', this)">ğŸ§Ÿ ë¡±ëŸ°(ì¢€ë¹„) ì§€ìˆ˜</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ë‚ ì§œ</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
                <div class="control-group"><label>êµ­ê°€</label><select id="countryFilter" onchange="updateChartFilter()"><option value="ALL">ì „ì²´ (Global)</option><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></div>
                <div class="control-group"><label>ì°¨íŠ¸</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´ ì°¨íŠ¸</option></select></div>
                <div class="search-wrapper"><span class="search-icon">ğŸ”</span><input type="text" id="dailySearch" placeholder="ê³¡ëª… / ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." onkeyup="renderDaily()"></div>
            </div>
            <div class="table-container">
                <table id="dailyTable"><thead><tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¡°íšŒìˆ˜ (ì¼ê°„/ì£¼ê°„)</th><th>ì „ì¼ ëŒ€ë¹„ (Delta)</th><th id="th-daily-rev">ì˜ˆìƒ ìˆ˜ìµ (Daily Value)</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="cross" class="tab-content">
        <div class="card">
            <div class="controls">
                <h3>ğŸŒ í”Œë«í¼ í†µí•© ìˆœìœ„ í˜„í™©</h3>
                <div style="margin-left:20px; font-size:0.8rem; color:#666;">* ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê³¼ê±° ìˆœìœ„ë„ ë¹„êµ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í—¤ë” í´ë¦­ ì‹œ ì •ë ¬)</div>
                <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                    <label>ì¡°íšŒì¼:</label>
                    <input type="date" id="crossDate" onchange="renderCross()">
                </div>
                <div class="search-wrapper"><span class="search-icon">ğŸ”</span><input type="text" id="crossSearch" placeholder="í†µí•© ê²€ìƒ‰..." onkeyup="renderCross()"></div>
            </div>
            <div class="table-container">
                <table id="crossTable">
                    <thead>
                        <tr>
                            <th onclick="sortMatrix(0)" style="width:60px;">No. â†•</th>
                            <th onclick="sortMatrix(1)" style="width:30%">Song Info â†•</th>
                            <th onclick="sortMatrix(2)"><span class="platform-badge" style="background:#00d344">M</span> Melon â†•</th>
                            <th onclick="sortMatrix(3)"><span class="platform-badge" style="background:#2bb6ff">G</span> Genie â†•</th>
                            <th onclick="sortMatrix(4)"><span class="platform-badge" style="background:#1db954">S</span> Spotify (Global) â†•</th>
                            <th onclick="sortMatrix(5)"><span class="platform-badge" style="background:#1db954">S</span> Spotify (KR) â†•</th>
                            <th onclick="sortMatrix(6)"><span class="platform-badge" style="background:#000">B</span> Hot 100 â†•</th>
                            <th onclick="sortMatrix(7)"><span class="platform-badge" style="background:#000">B</span> BB 200 â†•</th>
                            <th onclick="sortMatrix(8)"><span class="platform-badge" style="background:#000">B</span> Global 200 â†•</th>
                            <th onclick="sortMatrix(9)"><span class="platform-badge" style="background:#ff0000">Y</span> YouTube (KR) â†•</th>
                            <th onclick="sortMatrix(10)"><span class="platform-badge" style="background:#ff0000">Y</span> YouTube (US) â†•</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="trend" class="tab-content">
        <div class="card">
            <h3>ğŸ“ˆ êµ¬ê°„ë³„ ì§„ì… í•„ìš” ìˆ˜ì¹˜ (ëˆ„ì  í‰ê· )</h3>
            <div class="table-container"><table id="trendTable"><thead><tr><th>ê¸°ê°„</th><th>ì°¨íŠ¸</th><th>1~10ìœ„</th><th>11~20ìœ„</th><th>21~30ìœ„</th><th>31~40ìœ„</th><th>41~50ìœ„</th><th>ì§„ì… ì»· (100ìœ„)</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ê¸°ì¤€ì¼</label><input type="date" id="shortsDate" onchange="renderShortsStrategy()"></div>
                <div class="control-group"><label>ì°¨íŠ¸</label><select id="shortsChartSelect" onchange="renderShortsStrategy()"><option value="KR_Daily_Top_Shorts">ğŸ‡°ğŸ‡· í•œêµ­ ì‡¼ì¸ </option><option value="US_Daily_Top_Shorts">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì‡¼ì¸ </option></select></div>
                <div style="margin-left:auto;"><button class="tab-btn" onclick="setShortsPeriod(1, this)">ì¼ê°„</button><button class="tab-btn" onclick="setShortsPeriod(7, this)">ì£¼ê°„</button></div>
            </div>
            <div id="shortsKPI" style="padding:20px; background:#FFF8E1; border-left:5px solid #FFC107; border-radius:8px; margin-bottom:30px; color:#333;"></div>
            <div class="insight-grid" style="margin-bottom:30px;">
                <div class="chart-box wide"><div class="chart-header">ğŸ”¥ Viral Map</div><canvas id="scatterChart"></canvas></div>
                <div class="chart-box wide"><div class="chart-header">ğŸš€ ê¸‰ìƒìŠ¹ ë£¨í‚¤</div><div style="overflow-y:auto; flex:1;"><table id="rookieTable"><thead><tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>ì†ë„</th></tr></thead><tbody></tbody></table></div></div>
            </div>
            <div class="table-container"><table id="shortsTable"><thead></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="long-run" class="tab-content">
        <div class="card">
            <div class="info-box" style="background:#E3F2FD; border-left:4px solid #2196F3; padding:15px; margin-bottom:20px; color:#0D47A1;"><strong>ğŸ§Ÿ ë¡±ëŸ° ì§€ìˆ˜</strong></div>
            <div class="table-container"><table id="zombieTable"><thead><tr><th>ê³¡ëª…</th><th>ì²´ë¥˜ì¼</th><th>í‰ê· ìˆœìœ„</th><th>ë¡±ëŸ°ì ìˆ˜</th><th>ìƒíƒœ</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div class="footer-info"><p>Data powered by MusicDeal Analytics</p></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><h2 id="modalTitle">Title</h2><p id="modalArtist">Artist</p></div>
            <div style="display:flex; align-items:center; gap:20px;">
                <a id="ytLink" href="#" target="_blank" class="yt-btn">Watch Now</a>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                <div class="kpi-card" id="modal-card-rev" style="border-left:5px solid var(--green);"><span class="kpi-label">ğŸ’° ì¶”ì • ëˆ„ì  ìˆ˜ìµ</span><div class="kpi-value money" id="mRevenue">-</div></div>
                <div class="kpi-card"><span class="kpi-label">ğŸ† ìµœê³  ìˆœìœ„</span><div class="kpi-value" id="mBestRank">-</div></div>
                <div class="kpi-card"><span class="kpi-label">ğŸ”¥ ìµœê³  ìˆ˜ì¹˜</span><div class="kpi-value" id="mPeakView">-</div></div>
            </div>
            
            <div class="chart-stack">
                <div class="chart-box wide">
                    <div class="chart-header" id="viewChartTitle">ğŸ“Š ì¼ê°„ ì¶”ì´</div>
                    <div style="flex:1; position:relative; min-height:300px;"><canvas id="viewChart"></canvas></div>
                </div>
                <div class="chart-box wide">
                    <div class="chart-header">ğŸ† í†µí•© ìˆœìœ„ ë³€ë™ (Cross-Chart Rank)</div>
                    <div style="flex:1; position:relative; min-height:300px;"><canvas id="rankChart"></canvas></div>
                </div>
            </div>

            <div class="card" style="margin-top:60px; padding:0; border:none; box-shadow:none;">
                <h3 style="margin-bottom:15px; color:#000;">ğŸ“‹ ìƒì„¸ ì´ë ¥</h3>
                <div class="table-container">
                    <table id="historyTable"><thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜</th><th>ì¦ê°</th><th id="th-hist-rev">ìˆ˜ìµ (Daily)</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const ACCESS_KEY = "musicdeal2025"; 
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };

    let rawData = [], uniqueCharts = [];
    let scatterChartInst=null, vChart=null, rChart=null;
    let shortsPeriod = 1;
    let showRevenue = false;

    function checkLogin() {
        if(document.getElementById('passwordInput').value === ACCESS_KEY) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            setTimeout(()=>document.getElementById('app-content').style.opacity='1', 100);
            updateVisibility();
            loadData();
            localStorage.setItem('md_auth', 'true');
        } else {
            document.getElementById('login-msg').innerText = "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
        }
    }
    if(localStorage.getItem('md_auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('app-content').style.opacity = '1';
        updateVisibility();
        loadData();
    }

    function toggleRevenue() {
        showRevenue = document.getElementById('revenue-toggle').checked;
        updateVisibility();
    }

    function updateVisibility() {
        const kpiContainer = document.getElementById('kpi-container');
        const idsToHide = ['card-market', 'card-kr', 'card-us', 'card-dup'];
        if (showRevenue) {
            kpiContainer.classList.remove('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'block');
        } else {
            kpiContainer.classList.add('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'none');
        }
        const thDaily = document.getElementById('th-daily-rev');
        if(thDaily) thDaily.style.display = showRevenue ? '' : 'none';
        renderDaily();
    }

    function loadData() {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastValidRow = rawData[rawData.length-1];
                const lastDate = lastValidRow ? lastValidRow.Date : "";
                
                document.getElementById("header-date").innerText = lastDate;
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                document.getElementById("crossDate").value = lastDate; // í†µí•© íƒ­ ë‚ ì§œ ì´ˆê¸°í™”

                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                updateSummary(lastDate);
                renderDaily(); renderCross(); renderTrend(); renderShortsStrategy(); renderLongRun();
            }
        });
    }

    // ê°•ë ¥í•œ CSV íŒŒì„œ (ë¹ˆ ê°’ ì²˜ë¦¬)
    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(!row || row.length < 5) continue; 
            
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            let date = getCol(0); let chart = getCol(1); let rankRaw = getCol(2);
            let title = getCol(3); let artist = getCol(4); let vid = getCol(5); let vStr = getCol(6);

            if(!vid || vid.length < 5) vid = null; 
            let rankNum = parseInt(rankRaw.replace(/[^0-9]/g, "")) || 0;
            let views = parseInt(vStr ? vStr.replace(/,/g, "") : "0") || 0;

            data.push({ Date: date, Chart: chart, Rank: rankNum, Title: title, Artist: artist, Video_ID: vid, Views: views, Delta: 0, Revenue: 0 });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        const map = {};
        rawData.forEach(d => {
            const idKey = d.Video_ID ? d.Video_ID : `${d.Title}|${d.Artist}`;
            const key = `${d.Chart}|${idKey}`;
            if(!map[key]) map[key] = []; map[key].push(d);
        });
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=0; i<list.length; i++) {
                const curr = list[i];
                const prev = i > 0 ? list[i-1] : null;
                if(prev) curr.Delta = curr.Views - prev.Views;
                else curr.Delta = 0; 
                if(curr.Chart.includes("Shorts")) {
                    curr.Revenue = 0;
                } else {
                    let rate = 0;
                    if(curr.Chart.includes("US")) rate = curr.Chart.includes("Songs") ? RATES.US.song : RATES.US.mv;
                    else if(curr.Chart.includes("KR")) rate = curr.Chart.includes("Songs") ? RATES.KR.song : RATES.KR.mv;
                    curr.Revenue = Math.round((curr.Chart.includes("Weekly") ? curr.Views/7 : (curr.Chart.includes("Trending")?Math.max(0,curr.Delta):curr.Views)) * rate);
                }
            }
        });
    }

    function updateSummary(date) { 
        const todayData = rawData.filter(d => d.Date === date);
        let krSum=0, usSum=0, total=0, dup=0;
        const trendMap={};
        todayData.forEach(d => {
            if(d.Chart.includes("Shorts")) return;
            let rev = d.Revenue;
            if(d.Chart.includes("US")) usSum+=rev; else krSum+=rev;
            if(d.Chart.includes("Trending")) {
                const k = d.Video_ID || `${d.Title}|${d.Artist}`;
                if(!trendMap[k]) trendMap[k]=rev; else { dup++; if(rev>trendMap[k]) trendMap[k]=rev; }
            } else total+=rev;
        });
        total += Object.values(trendMap).reduce((a,b)=>a+b,0);
        document.getElementById("total-revenue").innerText = "â‚©" + total.toLocaleString();
        document.getElementById("kr-revenue").innerText = "â‚©" + krSum.toLocaleString();
        document.getElementById("us-revenue").innerText = "â‚©" + usSum.toLocaleString();
        document.getElementById("dup-blocked").innerText = dup + "ê°œ";
        const getCut = (c) => { const r = rawData.find(d=>d.Date===date && d.Chart===c && d.Rank===(c.includes("Trending")?20:100)); return r?r.Views.toLocaleString():"-"; };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    function openTab(id, btn) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); btn.classList.add('active'); window.dispatchEvent(new Event('resize')); }
    
    // [ìˆ˜ì •] ì°¨íŠ¸ í•„í„° ìˆœì„œ ê°•ì œ ì¡°ì • (YouTube ìš°ì„ )
    function updateChartFilter() { 
        const c = document.getElementById("countryFilter").value;
        const s = document.getElementById("chartFilter"); s.innerHTML='<option value="ALL">ì „ì²´ ì°¨íŠ¸</option>';
        
        // ìš°ì„ ìˆœìœ„ ì •ë ¬ ë¡œì§
        const sortedCharts = uniqueCharts.sort((a,b) => {
            const score = (name) => {
                if(name.includes("YouTube") || name.startsWith("KR_") || name.startsWith("US_")) return 1;
                if(name.includes("Melon") || name.includes("Genie")) return 2;
                if(name.includes("Spotify")) return 3;
                if(name.includes("Billboard")) return 4;
                return 5;
            };
            return score(a) - score(b);
        });

        sortedCharts.forEach(ch=>{ 
            if(c==="ALL"||ch.startsWith(c)) { 
                const o=document.createElement("option"); o.value=ch; o.innerText=ch; s.appendChild(o); 
            }
        });
        renderDaily();
    }

    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const search = document.getElementById("dailySearch").value.toLowerCase();
        let data = rawData.filter(d => d.Date === date);
        if(country !== "ALL") data = data.filter(d => d.Chart.startsWith(country));
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);
        if(search) data = data.filter(d => d.Title.toLowerCase().includes(search) || d.Artist.toLowerCase().includes(search));
        
        data.sort((a,b) => (a.Chart<b.Chart?-1:(a.Chart>b.Chart?1:a.Rank-b.Rank)));
        
        document.querySelector("#dailyTable tbody").innerHTML = data.map(d => {
            const delta = d.Delta > 0 ? `<span class="rank-up">â–²${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">â–¼${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            const rev = showRevenue ? `<td class="money-text">â‚©${d.Revenue.toLocaleString()}</td>` : "";
            const id = d.Video_ID || `${d.Artist}|${d.Title}`;
            return `<tr onclick="openDetail('${id}')"><td>${d.Chart}</td><td>${d.Rank}</td><td class="song-title">${d.Title}</td><td>${d.Artist}</td><td style="font-weight:bold">${d.Views.toLocaleString()}</td><td>${delta}</td>${rev}</tr>`;
        }).join("") || `<tr><td colspan="7" style="text-align:center; padding:30px;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // í†µí•© ë­í‚¹ ì •ë ¬ ë³€ìˆ˜
    let matrixSortCol = 0;
    let matrixSortAsc = true;

    function sortMatrix(colIndex) {
        if(matrixSortCol === colIndex) matrixSortAsc = !matrixSortAsc;
        else { matrixSortCol = colIndex; matrixSortAsc = true; }
        renderCross();
    }

    // [ìˆ˜ì •] í†µí•© ë­í‚¹: ë‚ ì§œ ì„ íƒ & ì •ë ¬ ê¸°ëŠ¥ í¬í•¨
    function renderCross() {
        const search = document.getElementById("crossSearch").value.toLowerCase();
        const targetDate = document.getElementById("crossDate").value; // í†µí•© íƒ­ ì „ìš© ë‚ ì§œ
        const data = rawData.filter(d => d.Date === targetDate);
        
        const songs = {};
        data.forEach(d => {
            const key = d.Title + "|" + d.Artist;
            if(!songs[key]) songs[key] = { title: d.Title, artist: d.Artist, id: d.Video_ID||key, ranks: {} };
            songs[key].ranks[d.Chart] = d.Rank;
        });
        
        let list = Object.values(songs);
        if(search) list = list.filter(s => s.title.toLowerCase().includes(search) || s.artist.toLowerCase().includes(search));
        
        const KEYS = {
            m:'Melon_Daily_Top100', g:'Genie_Daily_Top200', sg:'Spotify_Global_Daily', sk:'Spotify_KR_Daily',
            bh:'Billboard_Hot100', b2:'Billboard_200', bg:'Billboard_Global200',
            yk:'KR_Daily_Top_MV', yu:'US_Daily_Top_MV'
        };
        const keyArr = ['no', 'info', KEYS.m, KEYS.g, KEYS.sg, KEYS.sk, KEYS.bh, KEYS.b2, KEYS.bg, KEYS.yk, KEYS.yu];

        // ì •ë ¬ ë¡œì§
        list.sort((a, b) => {
            let valA, valB;
            const k = keyArr[matrixSortCol];
            
            if (matrixSortCol === 0) return matrixSortAsc ? 0 : 0; // No. ì •ë ¬ì€ ë Œë”ë§ ì‹œ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬
            if (matrixSortCol === 1) { valA = a.title; valB = b.title; }
            else { valA = a.ranks[k] || 9999; valB = b.ranks[k] || 9999; }

            if(valA < valB) return matrixSortAsc ? -1 : 1;
            if(valA > valB) return matrixSortAsc ? 1 : -1;
            return 0;
        });

        const rr = (v) => v ? `<span class="matrix-rank">${v}</span>` : `<span class="matrix-null">-</span>`;
        
        document.querySelector("#crossTable tbody").innerHTML = list.map((s, i) => `
            <tr onclick="openDetail('${s.id}')">
                <td style="font-weight:bold; color:#666; text-align:center;">${i+1}</td>
                <td style="text-align:center;"><div style="font-weight:bold; color:#000;">${s.title}</div><div style="font-size:0.85rem; color:#666;">${s.artist}</div></td>
                <td>${rr(s.ranks[KEYS.m])}</td><td>${rr(s.ranks[KEYS.g])}</td>
                <td>${rr(s.ranks[KEYS.sg])}</td><td>${rr(s.ranks[KEYS.sk])}</td>
                <td>${rr(s.ranks[KEYS.bh])}</td><td>${rr(s.ranks[KEYS.b2])}</td><td>${rr(s.ranks[KEYS.bg])}</td>
                <td>${rr(s.ranks[KEYS.yk])}</td><td>${rr(s.ranks[KEYS.yu])}</td>
            </tr>`).join("") || `<tr><td colspan="11" style="text-align:center; padding:30px;">ë°ì´í„° ì—†ìŒ (${targetDate})</td></tr>`;
    }

    function renderTrend() { const stats={}; rawData.forEach(d=>{ const k=d.Date.substring(0,7)+"|"+d.Chart; if(!stats[k]) stats[k]={s:[0,0,0,0,0,0],c:[0,0,0,0,0,0],sum:0,cnt:0}; const s=stats[k]; let i=-1; if(d.Rank<=10)i=0;else if(d.Rank<=30)i=1;else if(d.Rank<=50)i=2;else if(d.Rank<=70)i=3;else if(d.Rank<=100)i=4; if(i>=0){s.s[i]+=d.Views;s.c[i]++;} if(d.Rank===(d.Chart.includes("Trending")?20:100)){s.sum+=d.Views;s.cnt++;} }); document.querySelector("#trendTable tbody").innerHTML=Object.keys(stats).sort().reverse().map(k=>{ const [m,c]=k.split("|"); const s=stats[k]; let h=""; for(let i=0;i<5;i++) h+=`<td>${s.c[i]?Math.round(s.s[i]/s.c[i]).toLocaleString():"-"}</td>`; return `<tr><td>${m}</td><td>${c}</td>${h}<td class="highlight-cut">${s.cnt?Math.round(s.sum/s.cnt).toLocaleString():"-"}</td></tr>`; }).join(""); }
    function setShortsPeriod(d,b) { shortsPeriod=d; renderShortsStrategy(); }
    function renderShortsStrategy() { const d=document.getElementById("shortsDate").value; const c=document.getElementById("shortsChartSelect").value; const data=rawData.filter(x=>x.Date===d&&x.Chart===c); if(!data.length){ document.getElementById("shortsKPI").innerHTML="ë°ì´í„° ì—†ìŒ"; return; } const top10=data.filter(x=>x.Rank<=10&&x.Delta>0); const avg=top10.length?Math.round(top10.reduce((a,b)=>a+b.Delta,0)/top10.length):0; document.getElementById("shortsKPI").innerHTML=`<strong>ğŸ’¡ Insight:</strong> Top 10 í‰ê· í™”ë ¥ <span style="color:var(--primary)">+${avg.toLocaleString()}</span> / ì¼`; if(scatterChartInst) scatterChartInst.destroy(); const ctx=document.getElementById('scatterChart').getContext('2d'); scatterChartInst=new Chart(ctx,{type:'scatter',data:{datasets:[{label:'Songs',data:data.filter(x=>x.Delta>0).map(x=>({x:x.Views,y:x.Delta,t:x.Title,r:x.Rank})),backgroundColor:p=>p.raw.r<=10?'#E62117':(p.raw.r<=50?'#1A73E8':'#aaa')}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'logarithmic'}}}}); document.querySelector("#rookieTable tbody").innerHTML=data.filter(x=>x.Rank>20&&x.Delta>0).sort((a,b)=>b.Delta-a.Delta).slice(0,10).map(x=>`<tr onclick="openDetail('${x.Video_ID||x.Title}')"><td>${x.Rank}</td><td>${x.Title}</td><td style="color:var(--primary)">+${(x.Delta*shortsPeriod).toLocaleString()}</td></tr>`).join(""); const t=document.querySelector("#shortsTable tbody"); let h=""; for(let i=0;i<5;i++){ const s=i*10+1, e=(i+1)*10; const seg=data.filter(x=>x.Rank>=s&&x.Rank<=e); const dseg=seg.filter(x=>x.Delta>0); const av=dseg.length?Math.round(dseg.reduce((a,b)=>a+b.Delta,0)/dseg.length):0; h+=`<tr><td>${s}~${e}ìœ„</td><td>${(seg.length?Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length):0).toLocaleString()}</td><td style="color:var(--primary)">+${av.toLocaleString()}</td></tr>`; } t.innerHTML=h; }
    function renderLongRun() { const m={}; rawData.forEach(d=>{ const k=d.Video_ID||`${d.Title}|${d.Artist}`; if(!m[k]) m[k]={c:0,r:0,t:d.Title,v:k}; m[k].c++; m[k].r+=d.Rank; }); const z=Object.values(m).map(v=>({t:v.t, d:v.c, s:Math.round(v.c*1000/(v.r/v.c)), v:v.v})).sort((a,b)=>b.s-a.s).slice(0,20); document.querySelector("#zombieTable tbody").innerHTML=z.map(x=>`<tr onclick="openDetail('${x.v}')"><td>${x.t}</td><td>${x.d}ì¼</td><td>-</td><td style="color:var(--blue)">${x.s}</td><td>${x.s>=1000?'ğŸ§Ÿ':'ğŸŒ±'}</td></tr>`).join(""); }
    
    // [ìˆ˜ì •] ëª¨ë‹¬ ìƒì„¸: ê·¸ë˜í”„ 2ê°œ ìƒí•˜ ë°°ì¹˜ & í†µí•© ë­í‚¹ ê·¸ë˜í”„ ê°•í™”
    function openDetail(id) { 
        document.getElementById("detailModal").style.display="block"; 
        const rev=document.getElementById('modal-card-rev'); 
        if(showRevenue) rev.style.display='block'; else rev.style.display='none'; 
        
        let hist;
        if(id.includes("|")){ const [a,t]=id.split("|"); hist=rawData.filter(d=>d.Artist===a&&d.Title===t).sort((a,b)=>new Date(b.Date)-new Date(a.Date)); } 
        else { hist=rawData.filter(d=>d.Video_ID===id).sort((a,b)=>new Date(b.Date)-new Date(a.Date)); } 
        
        if(!hist.length) return; 
        const i=hist[0]; 
        document.getElementById("modalTitle").innerText=i.Title; 
        document.getElementById("modalArtist").innerText=i.Artist; 
        const btn=document.getElementById("ytLink"); 
        if(i.Video_ID) btn.href=`https://www.youtube.com/watch?v=${i.Video_ID}`; 
        else btn.href=`https://www.youtube.com/results?search_query=${i.Artist} ${i.Title}`; 
        
        const best=Math.min(...hist.map(d=>d.Rank)); 
        const peak=Math.max(...hist.map(d=>d.Views)); 
        document.getElementById("mBestRank").innerText=best+"ìœ„"; 
        document.getElementById("mPeakView").innerText=peak.toLocaleString(); 
        const totalRev=hist.reduce((a,b)=>a+b.Revenue,0); 
        document.getElementById("mRevenue").innerText="â‚©"+totalRev.toLocaleString(); 
        
        if(vChart)vChart.destroy(); if(rChart)rChart.destroy(); 
        
        const dates=[...new Set(hist.map(d=>d.Date))].sort(); 
        
        // í†µí•© ë­í‚¹ ê·¸ë˜í”„ (Rank Chart) ë°ì´í„°ì…‹ ìƒì„± - ëª¨ë“  ì°¨íŠ¸ í¬í•¨
        const songCharts = [...new Set(hist.map(d => d.Chart))];
        const colors = ['#E62117', '#1A73E8', '#00d344', '#1db954', '#000000', '#F9A825', '#9C27B0']; // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        
        const rankDatasets = songCharts.map((cName, idx) => ({
            label: cName,
            data: dates.map(dt => { const item = hist.find(h => h.Date === dt && h.Chart === cName); return item ? item.Rank : null; }),
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length],
            tension: 0.3,
            spanGaps: true,
            pointRadius: 5,       // [ìš”ì²­] ì  í¬ê¸° í™•ëŒ€
            pointHoverRadius: 8   // [ìš”ì²­] í˜¸ë²„ ì‹œ ë” í¬ê²Œ
        }));

        // ì¡°íšŒìˆ˜ ê·¸ë˜í”„ (View Chart) - ëŒ€í‘œ ì°¨íŠ¸ 1ê°œ ë˜ëŠ” í•©ì‚° (ì—¬ê¸°ì„œëŠ” ê°€ì¥ ë§ì´ ë…¸ì¶œëœ ì°¨íŠ¸ ê¸°ì¤€)
        const mainChart = songCharts[0];
        const viewData = dates.map(dt => { const item = hist.find(h => h.Date === dt && h.Chart === mainChart); return item ? item.Views : null; });

        vChart=new Chart(document.getElementById('viewChart'), {
            type:'line',
            data:{
                labels:dates,
                datasets:[{ label: mainChart + " (Views)", data: viewData, borderColor: '#333', backgroundColor: 'rgba(0,0,0,0.1)', fill: true, tension: 0.4 }]
            },
            options:{ maintainAspectRatio:false }
        }); 
        
        rChart=new Chart(document.getElementById('rankChart'), {
            type:'line',
            data:{ labels:dates, datasets: rankDatasets },
            options:{ 
                maintainAspectRatio:false, 
                scales:{ y:{ reverse:true, beginAtZero: false } } // ìˆœìœ„ëŠ” 1ìœ„ê°€ ìœ„ë¡œ ê°€ë„ë¡ ë°˜ì „
            }
        }); 
        
        document.querySelector("#historyTable tbody").innerHTML=hist.map(d=>`<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${d.Views.toLocaleString()}</td><td>${d.Delta}</td>${showRevenue?`<td>â‚©${d.Revenue}</td>`:""}</tr>`).join(""); 
    }
    function closeModal() { document.getElementById("detailModal").style.display="none"; }
    window.onclick=function(e){if(e.target==document.getElementById("detailModal"))closeModal();}
</script>
</body>
</html>
