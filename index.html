<!DOCTYPE html>
<html>
<head>
<style>
  /* [스타일] 테이블 디자인 */
  .ranking-table-container {
    width: 100%;
    overflow-x: auto;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  }
  
  table.custom-rank-table {
    width: 100%;
    border-collapse: collapse;
    border-spacing: 0;
    min-width: 1000px; /* 컬럼이 늘어나서 넓이 확보 */
  }

  /* 헤더 스타일 */
  table.custom-rank-table th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 700;
    padding: 12px 8px;
    font-size: 13px;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
    white-space: nowrap;
  }

  /* 셀 스타일 */
  table.custom-rank-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #f1f3f5;
    vertical-align: middle;
    text-align: center;
  }

  /* 곡 정보 (왼쪽 정렬) */
  .song-info {
    text-align: left !important;
    width: 220px;
    position: sticky;
    left: 0;
    background-color: #fff; /* 스크롤 시 겹침 방지 */
    z-index: 1;
  }
  .song-title {
    font-weight: bold;
    color: #212529;
    font-size: 14px;
    margin-bottom: 4px;
    display: block;
  }
  .song-artist {
    color: #868e96;
    font-size: 12px;
  }

  /* [중요] 순위 숫자 (검은색/굵게) */
  .rank-cell {
    color: #000000 !important;
    font-weight: 800 !important;
    font-size: 15px;
  }

  /* 1~3위 강조 */
  .top-rank {
    color: #e03131 !important;
  }

  /* 데이터 없음 */
  .no-data {
    color: #ced4da;
    font-weight: 400;
    font-size: 12px;
  }
</style>
</head>
<body>

<div class="ranking-table-container">
  <table class="custom-rank-table">
    <thead>
      <tr>
        <th class="song-info" style="padding-left:15px; z-index:2;">Song Info</th>
        <th style="background-color:#00d344; color:white;">Melon</th>
        <th style="background-color:#0094fb; color:white;">Genie</th>
        
        <th style="background-color:#000000; color:white;">Hot 100</th>
        <th style="background-color:#333333; color:white;">BB 200</th>
        <th style="background-color:#555555; color:white;">Global 200</th>
        
        <th style="background-color:#1db954; color:white;">Spot. (GL)</th>
        <th style="background-color:#1ed760; color:white;">Spot. (KR)</th>
        
        <th style="background-color:#ff0000; color:white;">YT (KR)</th>
        <th style="background-color:#cc0000; color:white;">YT (US)</th>
      </tr>
    </thead>
    <tbody id="ranking-tbody">
      <tr><td colspan="10" style="padding:20px;">데이터 로딩 중...</td></tr>
    </tbody>
  </table>
</div>

<script>
// [설정 1] CSV 주소 (그대로 유지)
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";

// [설정 2] 매핑 테이블 (빌보드 3개 모두 연결)
const MAPPER = {
  // 파이썬 키 : 화면 컬럼 ID
  "Melon_Daily_Top100":    "Melon",
  "Genie_Daily_Top200":    "Genie",
  
  // 빌보드 3개
  "Billboard_Hot100":      "Bb_Hot100",
  "Billboard_200":         "Bb_200",
  "Billboard_Global200":   "Bb_Global",
  
  "Spotify_Global_Daily":  "Spot_GL",
  "Spotify_KR_Daily":      "Spot_KR",
  
  // 유튜브
  "KR_Daily_Top_MV":       "YT_KR",
  "KR_Weekly_Top_MV":      "YT_KR",
  "KR_Weekly_Top_Songs":   "YT_KR",
  "US_Daily_Top_MV":       "YT_US",
  "US_Weekly_Top_MV":      "YT_US",
  "US_Weekly_Top_Songs":   "YT_US"
};

// [로직] 데이터 로드 및 파싱
async function loadData() {
  try {
    const response = await fetch(SHEET_CSV_URL);
    const text = await response.text();
    const rows = csvToJSON(text);
    renderTable(rows);
  } catch (err) {
    console.error(err);
    document.getElementById('ranking-tbody').innerHTML = `<tr><td colspan="10">로딩 실패 (새로고침 필요)</td></tr>`;
  }
}

function csvToJSON(csv) {
  const lines = csv.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim());
  const result = [];
  for(let i=1; i<lines.length; i++){
    const currentline = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
    if (!currentline) continue;
    let obj = {};
    headers.forEach((h, index) => {
        let val = currentline[index] || "";
        val = val.replace(/^"|"$/g, '');
        obj[h] = val;
    });
    result.push(obj);
  }
  return result;
}

// [로직] 렌더링
function renderTable(data) {
  const tbody = document.getElementById('ranking-tbody');
  tbody.innerHTML = "";
  
  const songMap = {};

  data.forEach(row => {
    // 합계/Total 제거
    if ((row.Title && row.Title.includes("합계")) || 
        (row.Title && row.Title.toLowerCase().includes("total"))) return;

    // 키 생성
    const key = (row.Title + row.Artist).replace(/\s/g, ""); 
    
    if (!songMap[key]) {
      songMap[key] = {
        title: row.Title,
        artist: row.Artist,
        ranks: {} 
      };
    }

    const targetCol = MAPPER[row.Chart];
    if (targetCol) {
      let rawRank = row.Rank || "";
      // TOP 글자 제거, 숫자만 남김
      let cleanRank = rawRank.toString().replace(/TOP\s?/gi, "").trim();
      songMap[key].ranks[targetCol] = cleanRank;
    }
  });

  const songs = Object.values(songMap);
  if (songs.length === 0) {
    tbody.innerHTML = "<tr><td colspan='10'>표시할 데이터가 없습니다.</td></tr>";
    return;
  }

  songs.forEach(song => {
    const tr = document.createElement('tr');
    
    // 컬럼 순서 (헤더와 일치해야 함)
    const colOrder = [
      "Melon", "Genie", 
      "Bb_Hot100", "Bb_200", "Bb_Global", 
      "Spot_GL", "Spot_KR", 
      "YT_KR", "YT_US"
    ];
    
    // 1. 곡 정보
    let html = `
      <td class="song-info">
        <span class="song-title">${song.title}</span>
        <span class="song-artist">${song.artist}</span>
      </td>
    `;

    // 2. 순위 컬럼
    colOrder.forEach(col => {
      let val = song.ranks[col];
      let displayClass = "rank-cell";
      
      if (val && val !== "-" && !isNaN(val) && parseInt(val) <= 3) {
        displayClass += " top-rank";
      }
      if (!val || val === "-" || val === "0") {
        val = "-";
        displayClass = "no-data";
      }

      html += `<td class="${displayClass}">${val}</td>`;
    });

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });
}

loadData();
</script>

</body>
</html>
