<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Analytics (Cross-Platform)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <style>
        :root {
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-main: #1A1A1A;
            --text-sub: #5F6368;
            --primary: #E62117; /* YouTube */
            --melon: #00CD3C;   /* Melon */
            --genie: #0096FF;   /* Genie */
            --spotify: #1DB954; /* Spotify */
            --billboard: #121212; /* Billboard */
            --blue: #1A73E8;
            --green: #1E8E3E;
            --border: #E0E0E0;
            --shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            min-height: 100vh;
        }
        
        .container { max-width: 1800px; margin: 0 auto; padding: 80px 20px 100px; }

        header { 
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 60px; border-bottom: 1px solid #eee; padding-bottom: 40px; 
        }
        h1 { 
            margin: 0 0 15px 0; font-weight: 900; font-size: 3rem; 
            letter-spacing: -1px; color: var(--text-main); text-transform: uppercase; 
        }
        h1 span { color: var(--primary); }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .date-badge { 
            display: inline-block; background: #fff; padding: 8px 20px; 
            border-radius: 30px; border: 1px solid var(--border); 
            color: var(--text-sub); font-weight: 600; font-size: 0.95rem;
            box-shadow: var(--shadow);
        }
        
        /* Toggle */
        .toggle-wrapper { display: flex; align-items: center; background: #fff; border: 1px solid var(--border); padding: 5px 10px 5px 5px; border-radius: 30px; box-shadow: var(--shadow); cursor: pointer; }
        .toggle-wrapper label { font-size: 0.9rem; font-weight: 700; color: #333; margin-left: 8px; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f9f9f9; text-align: center; }
        .login-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #app-content { display: none; opacity: 0; transition: opacity 0.5s; }

        /* KPI Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; transition: all 0.3s; }
        .summary-grid.no-revenue { grid-template-columns: repeat(2, 1fr); }

        .kpi-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-label { font-size: 0.85rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .kpi-value.money { color: var(--green); }
        .kpi-sub { font-size: 0.8rem; color: #888; margin-top: 5px; }

        /* Tabs */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 50px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 28px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 30px; cursor: pointer; font-weight: 700; font-size: 1rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn.active { background: #333; color: #fff; border-color: #333; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        /* Card & Controls */
        .card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); padding: 30px; margin-bottom: 30px; border: 1px solid var(--border); }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        input, select { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; background: #fff; color: #333; }
        .search-wrapper { position: relative; margin-left: auto; width: 300px; }
        .search-wrapper input { width: 100%; padding-left: 40px; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; white-space: nowrap; }
        th { background: #F8F9FA; color: #333; padding: 16px; text-align: center; font-weight: 800; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 10; }
        td { padding: 14px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        tr:hover { background-color: #f1f3f5; cursor: pointer; }

        /* Platform Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; color: #fff; margin-right: 6px; display: inline-block; width: 80px; text-align: center; }
        .badge.melon { background-color: var(--melon); }
        .badge.genie { background-color: var(--genie); }
        .badge.yt { background-color: var(--primary); }
        .badge.spotify { background-color: var(--spotify); }
        .badge.billboard { background-color: var(--billboard); }

        .rank-up { color: #D32F2F; font-weight: bold; background: #FFEBEE; padding: 2px 6px; border-radius: 4px; }
        .rank-down { color: #1976D2; font-weight: bold; background: #E3F2FD; padding: 2px 6px; border-radius: 4px; }
        .money-text { color: var(--green); font-weight: 800; font-family: 'Montserrat'; }
        .sum-row { background: #333 !important; color: #fff !important; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: #fff; margin: 2vh auto; width: 95%; max-width: 1600px; height: 92vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 25px 35px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title h2 { margin: 0; font-size: 1.8rem; color: #000; }
        .close-btn { font-size: 36px; cursor: pointer; }
        .modal-body { padding: 35px; overflow-y: auto; flex: 1; background: #FAFAFA; }
        #detailModal th { background-color: #333 !important; color: #fff !important; }

        .yt-btn { background: #FF0000; color: #fff; padding: 8px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255,0,0,0.2); }
        
        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-box { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 20px; height: 450px; display: flex; flex-direction: column; box-shadow: var(--shadow); }
        .chart-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; color: #333; border-left: 4px solid var(--primary); padding-left: 12px; }
        
        .footer-info { text-align: center; color: #888; margin-top: 40px; font-size: 0.85rem; padding-top: 20px; border-top: 1px solid #ddd; }
        .price-tag { display: inline-block; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; margin: 0 5px; font-weight: 600; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 class="login-title" style="color:#000; margin-bottom:10px;">MUSICDEAL <span style="color:var(--primary)">ADMIN</span></h2>
        <input type="password" id="passwordInput" class="login-input" placeholder="Access Key" onkeyup="if(window.event.keyCode==13){checkLogin()}">
        <button class="login-btn" onclick="checkLogin()">ì ‘ì†í•˜ê¸°</button>
        <p id="login-msg" style="color:var(--primary); margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="app-content" class="container">
    <header>
        <h1>MUSICDEAL <span>ANALYTICS</span></h1>
        <div class="header-controls">
            <div class="date-badge">ìµœì¢… ì—…ë°ì´íŠ¸: <span id="header-date">-</span></div>
            <div class="toggle-wrapper">
                <label class="switch">
                    <input type="checkbox" id="revenue-toggle" onchange="toggleRevenue()">
                    <span class="slider"></span>
                </label>
                <label for="revenue-toggle">ğŸ’° ìˆ˜ìµ ë¶„ì„</label>
            </div>
        </div>
    </header>

    <div class="summary-grid no-revenue" id="kpi-container" style="display:none;"> <div class="kpi-card" id="card-market" style="border-top: 4px solid var(--green);">
            <span class="kpi-label">ğŸ’° Market Size (Top 100 Only)</span>
            <div class="kpi-value money" id="total-revenue">-</div>
        </div>
        <div class="kpi-card" id="card-kr">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR Revenue Share</span>
            <div class="kpi-value kr" id="kr-revenue">-</div>
        </div>
        <div class="kpi-card" id="card-us">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US Revenue Share</span>
            <div class="kpi-value us" id="us-revenue">-</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR MV Entry Cut</span>
            <div class="kpi-value kr" id="kr-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì 100ìœ„ ì¡°íšŒìˆ˜</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US MV Entry Cut</span>
            <div class="kpi-value us" id="us-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì 100ìœ„ ì¡°íšŒìˆ˜</div>
        </div>
        <div class="kpi-card" id="card-dup">
            <span class="kpi-label">âš ï¸ Global Duplicate</span>
            <div class="kpi-value" id="dup-blocked">-</div>
            <div class="kpi-sub">ì¤‘ë³µ íŠ¸ë Œë”© ì˜ìƒ ìˆ˜</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('cross-rank', this)">ğŸ† í”Œë«í¼ë³„ í†µí•© ìˆœìœ„</button>
        <button class="tab-btn" onclick="openTab('daily', this)">ğŸ“… ì „ì²´ ë°ì´í„° (Raw)</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">âš¡ ì‡¼ì¸  ë°”ì´ëŸ´</button>
    </div>

    <div id="cross-rank" class="tab-content active">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ë‚ ì§œ</label><input type="date" id="rankDate" onchange="renderCrossRank()"></div>
                <div class="search-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="rankSearch" placeholder="ì•„í‹°ìŠ¤íŠ¸ / ê³¡ëª… ê²€ìƒ‰..." onkeyup="renderCrossRank()">
                </div>
            </div>
            <div class="table-container">
                <table id="crossRankTable">
                    <thead>
                        <tr>
                            <th>ê³¡ëª… (Artist)</th>
                            <th>ğŸˆ Melon</th>
                            <th>ğŸ§ Genie</th>
                            <th>ğŸ”´ YouTube (KR)</th>
                            <th>ğŸŸ¢ Spotify (Global)</th>
                            <th>ğŸŸ¢ Spotify (US)</th>
                            <th>ğŸ‡ºğŸ‡¸ Billboard</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="daily" class="tab-content">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ë‚ ì§œ</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
                <div class="control-group"><label>í”Œë«í¼ í•„í„°</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´ ë³´ê¸°</option></select></div>
                <div class="search-wrapper"><span class="search-icon">ğŸ”</span><input type="text" id="dailySearch" placeholder="ê²€ìƒ‰..." onkeyup="renderDaily()"></div>
            </div>
            <div class="table-container">
                <table id="dailyTable">
                    <thead><tr><th>í”Œë«í¼/ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ìˆ˜ì¹˜ (Views/Streams)</th><th>ë³€ë™</th><th id="th-daily-rev" style="display:none">ì˜ˆìƒ ìˆ˜ìµ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="card">
            <div class="controls">
                <h3>âš¡ ì‡¼ì¸  ë°”ì´ëŸ´ (YouTube)</h3>
                <div class="control-group" style="margin-left:auto;"><label>ê¸°ì¤€ì¼</label><input type="date" id="shortsDate" onchange="renderShorts()"></div>
            </div>
            <div class="insight-grid">
                <div class="chart-box"><div class="chart-header">ğŸ”¥ Viral Map</div><canvas id="scatterChart"></canvas></div>
                <div class="chart-box">
                    <div class="chart-header">ğŸš€ ê¸‰ìƒìŠ¹ Top 10</div>
                    <div style="overflow-y:auto; flex:1;"><table id="rookieTable"><thead><tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>í™”ë ¥</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><h2 id="modalTitle">Title</h2><p id="modalArtist">Artist</p></div>
            <div style="display:flex; align-items:center; gap:20px;">
                <a id="ytLink" href="#" target="_blank" class="yt-btn">â–¶ Watch on YouTube</a>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div class="chart-box" style="width:100%; height:350px; margin-bottom:30px;">
                <div class="chart-header">ğŸ† í”Œë«í¼ë³„ ìˆœìœ„ ë¹„êµ (Cross-Platform Rank)</div>
                <canvas id="crossRankChart"></canvas>
            </div>
            
            <div class="insight-grid">
                <div class="chart-box"><div class="chart-header">ğŸ“Š YouTube ì¡°íšŒìˆ˜ ì¶”ì´</div><canvas id="viewChart"></canvas></div>
                <div class="chart-box"><div class="chart-header">ğŸ“‰ í”Œë«í¼ë³„ ìƒì„¸ ì´ë ¥</div>
                    <div class="table-container" style="height:100%; overflow-y:auto;">
                        <table id="historyTable"><thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜</th><th id="th-hist-rev" style="display:none">ìˆ˜ìµ</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const ACCESS_KEY = "musicdeal2025"; 
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };

    let rawData = [];
    let crossChartInst = null, viewChartInst = null;
    let showRevenue = false; 

    function checkLogin() {
        if(document.getElementById('passwordInput').value === ACCESS_KEY) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            setTimeout(()=>document.getElementById('app-content').style.opacity='1', 100);
            updateVisibility(); 
            loadData();
            localStorage.setItem('md_auth', 'true');
        }
    }
    if(localStorage.getItem('md_auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('app-content').style.opacity = '1';
        updateVisibility();
        loadData();
    }

    function toggleRevenue() {
        showRevenue = document.getElementById('revenue-toggle').checked;
        updateVisibility();
    }

    function updateVisibility() {
        const kpiContainer = document.getElementById('kpi-container');
        const idsToHide = ['card-market', 'card-kr', 'card-us', 'card-dup'];
        
        // KPI Container ìì²´ëŠ” í•­ìƒ ë³´ì„ (Entry Cut ë•Œë¬¸ì—), ë‚´ë¶€ ì¹´ë“œë§Œ í† ê¸€
        kpiContainer.style.display = 'grid'; 
        
        if (showRevenue) {
            kpiContainer.classList.remove('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('th-daily-rev').style.display = '';
        } else {
            kpiContainer.classList.add('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('th-daily-rev').style.display = 'none';
        }
        renderDaily();
    }

    function loadData() {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                document.getElementById("header-date").innerText = lastDate;
                document.getElementById("rankDate").value = lastDate;
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                
                const charts = [...new Set(rawData.map(d => d.Chart))].sort();
                const filter = document.getElementById("chartFilter");
                charts.forEach(c => {
                    const opt = document.createElement("option"); opt.value = c; opt.innerText = c;
                    filter.appendChild(opt);
                });

                updateSummary(lastDate);
                renderCrossRank();
                renderDaily();
                renderShorts();
            }
        });
    }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            
            let title = getCol(3);
            let artist = getCol(4);
            // Normalization Key
            let normTitle = title.toLowerCase().replace(/\(.*\)|\[.*\]/g, "").replace(/[^a-z0-9ê°€-í£]/g, "");
            let normArtist = artist.toLowerCase().replace(/\(.*\)|\[.*\]/g, "").replace(/[^a-z0-9ê°€-í£]/g, "");
            let normKey = `${normTitle}|${normArtist}`;

            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: title, Artist: artist, Video_ID: getCol(5), Views: parseInt(getCol(6).replace(/,/g, "")) || 0, NormKey: normKey, Delta: 0, Revenue: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        // ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼ (ìœ íŠœë¸Œë§Œ ìˆ˜ìµ ê³„ì‚°)
        // ... (ìƒëµ ì—†ì´ êµ¬í˜„)
        const map = {};
        rawData.forEach(d => {
            const idKey = d.Video_ID ? d.Video_ID : d.NormKey;
            const key = `${d.Chart}|${idKey}`;
            if(!map[key]) map[key] = []; map[key].push(d);
        });
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=0; i<list.length; i++) {
                const curr = list[i];
                const prev = i > 0 ? list[i-1] : null;
                if(prev) curr.Delta = curr.Views - prev.Views; else curr.Delta = 0;

                // ìˆ˜ìµ ê³„ì‚° (ìœ íŠœë¸Œë§Œ)
                if(!curr.Chart.startsWith("KR_") && !curr.Chart.startsWith("US_")) {
                    curr.Revenue = 0;
                } else if(curr.Chart.includes("Shorts")) {
                    curr.Revenue = 0;
                } else {
                    let rate = curr.Chart.includes("US") ? (curr.Chart.includes("Songs") ? 10 : 4) : (curr.Chart.includes("Songs") ? 5 : 2.5);
                    if(curr.Chart.includes("Weekly")) curr.Revenue = Math.round((curr.Views/7)*rate);
                    else if(curr.Chart.includes("Trending")) curr.Revenue = Math.round(Math.max(0, curr.Delta)*rate);
                    else curr.Revenue = Math.round(curr.Views*rate);
                }
            }
        });
    }

    function updateSummary(date) {
        // ê¸°ì¡´ ë¡œì§ ë™ì¼
        const todayData = rawData.filter(d => d.Date === date);
        const trendingMap = {};
        let krSum = 0, usSum = 0, totalMarketSize = 0, duplicateCount = 0;

        todayData.forEach(d => {
            if(d.Revenue === 0) return;
            let rev = d.Revenue;
            if(d.Chart.includes("US")) usSum += rev; else krSum += rev;
            
            if(d.Chart.includes("Trending")) {
                const idKey = d.Video_ID ? d.Video_ID : d.NormKey;
                if(!trendingMap[idKey]) trendingMap[idKey] = rev;
                else { duplicateCount++; if(rev > trendingMap[idKey]) trendingMap[idKey] = rev; }
            } else {
                totalMarketSize += rev;
            }
        });
        totalMarketSize += Object.values(trendingMap).reduce((a,b)=>a+b, 0);
        
        document.getElementById("total-revenue").innerText = "â‚©" + totalMarketSize.toLocaleString();
        document.getElementById("kr-revenue").innerText = "â‚©" + krSum.toLocaleString();
        document.getElementById("us-revenue").innerText = "â‚©" + usSum.toLocaleString();
        document.getElementById("dup-blocked").innerText = duplicateCount + "ê°œ";

        // Entry Cut (YouTube Only)
        const getCut = (chart) => {
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === 100);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    function openTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // [NEW] í†µí•© ìˆœìœ„ í…Œì´ë¸” ë Œë”ë§
    function renderCrossRank() {
        const date = document.getElementById("rankDate").value;
        const search = document.getElementById("rankSearch").value.toLowerCase();
        const tbody = document.querySelector("#crossRankTable tbody");
        
        const dayData = rawData.filter(d => d.Date === date);
        const grouped = {};

        dayData.forEach(d => {
            if(!grouped[d.NormKey]) {
                grouped[d.NormKey] = { 
                    title: d.Title, artist: d.Artist, key: d.NormKey, video_id: d.Video_ID,
                    melon: '-', genie: '-', yt: '-', sp_g: '-', sp_us: '-', bb: '-' 
                };
            }
            const item = grouped[d.NormKey];
            if(d.Video_ID && !item.video_id) item.video_id = d.Video_ID;

            if(d.Chart.includes("Melon")) item.melon = d.Rank;
            if(d.Chart.includes("Genie")) item.genie = d.Rank;
            if(d.Chart.includes("KR_Daily_Top_MV")) item.yt = d.Rank;
            if(d.Chart.includes("Spotify_Global")) item.sp_g = d.Rank;
            if(d.Chart.includes("Spotify_US")) item.sp_us = d.Rank;
            if(d.Chart.includes("Billboard")) item.bb = d.Rank;
        });

        const sorted = Object.values(grouped).filter(i => 
            i.title.toLowerCase().includes(search) || i.artist.toLowerCase().includes(search)
        ).sort((a,b) => {
            let rA = a.melon !== '-' ? a.melon : 999;
            let rB = b.melon !== '-' ? b.melon : 999;
            return rA - rB;
        });

        tbody.innerHTML = sorted.map(i => `
            <tr onclick="openDetail('${i.key.replace(/'/g, "\\'")}')">
                <td><div style="font-weight:bold">${i.title}</div><div style="font-size:0.85em; color:#666">${i.artist}</div></td>
                <td style="color:var(--melon); font-weight:bold">${i.melon}</td>
                <td style="color:var(--genie); font-weight:bold">${i.genie}</td>
                <td style="color:var(--primary); font-weight:bold">${i.yt}</td>
                <td style="color:var(--spotify); font-weight:bold">${i.sp_g}</td>
                <td style="color:var(--spotify); font-weight:bold">${i.sp_us}</td>
                <td style="color:var(--billboard); font-weight:bold">${i.bb}</td>
            </tr>
        `).join("");
    }

    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const chart = document.getElementById("chartFilter").value;
        const search = document.getElementById("dailySearch").value.toLowerCase();
        const tbody = document.querySelector("#dailyTable tbody");

        let data = rawData.filter(d => d.Date === date);
        if(chart !== "ALL") data = data.filter(d => d.Chart === chart);
        if(search) data = data.filter(d => d.Title.toLowerCase().includes(search) || d.Artist.toLowerCase().includes(search));

        data.sort((a,b) => {
            const getScore = (c) => {
                if(c.includes("Melon")) return 1; if(c.includes("Genie")) return 2;
                if(c.includes("YouTube") || c.startsWith("KR_") || c.startsWith("US_")) return 3;
                return 4;
            };
            if(getScore(a.Chart) !== getScore(b.Chart)) return getScore(a.Chart) - getScore(b.Chart);
            return a.Rank - b.Rank;
        });

        tbody.innerHTML = data.map(d => {
            let badge = "";
            if(d.Chart.includes("Melon")) badge = `<span class="badge melon">Melon</span>`;
            else if(d.Chart.includes("Genie")) badge = `<span class="badge genie">Genie</span>`;
            else if(d.Chart.includes("Spotify")) badge = `<span class="badge spotify">Spotify</span>`;
            else if(d.Chart.includes("Billboard")) badge = `<span class="badge billboard">Billboard</span>`;
            else badge = `<span class="badge yt">YouTube</span>`;

            let delta = d.Delta > 0 ? `<span class="rank-up">â–²${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">â–¼${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            let viewStr = d.Views > 0 ? d.Views.toLocaleString() : "-";
            let revCell = showRevenue ? `<td class="money-text">${d.Revenue>0?'â‚©'+d.Revenue.toLocaleString():'-'}</td>` : "";

            return `<tr onclick="openDetail('${d.NormKey.replace(/'/g, "\\'")}')">
                <td>${badge} ${d.Chart.replace('Melon_','').replace('Genie_','')}</td><td>${d.Rank}</td>
                <td class="song-title">${d.Title}</td><td>${d.Artist}</td>
                <td style="font-weight:bold">${viewStr}</td><td>${delta}</td>${revCell}
            </tr>`;
        }).join("");
    }

    function renderShorts() {
        const date = document.getElementById("shortsDate").value;
        const chartName = document.getElementById("shortsChartSelect").value;
        const data = rawData.filter(d => d.Date === date && d.Chart === chartName);
        if(data.length === 0) { document.getElementById("shortsKPI").innerHTML = "ë°ì´í„° ì—†ìŒ"; return; }
        const top10 = data.filter(d => d.Rank <= 10 && d.Delta > 0);
        const avgSpeed = top10.length ? Math.round(top10.reduce((a,b)=>a+b.Delta,0)/top10.length) : 0;
        document.getElementById("shortsKPI").innerHTML = `<strong>ğŸ’¡ Insight:</strong> Top 10 í‰ê· í™”ë ¥ <span style="color:var(--primary)">+${avgSpeed.toLocaleString()}</span> / ì¼`;
        
        if(scatterChartInst) scatterChartInst.destroy();
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const points = data.filter(d => d.Delta > 0).map(d => ({ x: d.Views, y: d.Delta, title: d.Title }));
        scatterChartInst = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Songs', data: points, backgroundColor: '#E62117' }] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: {type:'logarithmic'} } } });
        
        document.querySelector("#rookieTable tbody").innerHTML = data.filter(d=>d.Delta>0).sort((a,b)=>b.Delta-a.Delta).slice(0,10).map(d => 
            `<tr onclick="openDetail('${d.NormKey.replace(/'/g, "\\'")}')"><td>${d.Rank}</td><td>${d.Title}</td><td style="color:var(--primary)">+${d.Delta.toLocaleString()}</td></tr>`
        ).join("");
    }

    function openDetail(normKey) {
        document.getElementById("detailModal").style.display = "block";
        
        const revTh = document.getElementById('th-hist-rev');
        revTh.style.display = showRevenue ? '' : 'none';

        const hist = rawData.filter(d => d.NormKey === normKey).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        if(hist.length === 0) return;

        const info = hist[hist.length-1];
        document.getElementById("modalTitle").innerText = info.Title;
        document.getElementById("modalArtist").innerText = info.Artist;

        const ytBtn = document.getElementById("ytLink");
        const vidItem = hist.find(d => d.Video_ID && d.Video_ID.length > 5);
        if(vidItem) {
            ytBtn.href = `https://www.youtube.com/watch?v=${vidItem.Video_ID}`;
            ytBtn.innerHTML = "â–¶ Watch MV";
        } else {
            ytBtn.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(info.Artist + " " + info.Title)}`;
            ytBtn.innerHTML = "ğŸ” Search YouTube";
        }

        // [NEW] Multi-line Chart
        const dates = [...new Set(hist.map(d => d.Date))].sort();
        const getRankSeries = (keyword) => dates.map(dt => {
            const item = hist.find(h => h.Date === dt && h.Chart.includes(keyword));
            return item ? item.Rank : null;
        });

        if(crossChartInst) crossChartInst.destroy();
        crossChartInst = new Chart(document.getElementById('crossRankChart'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'Melon', data: getRankSeries("Melon"), borderColor: '#00CD3C', tension: 0.2, spanGaps: true },
                    { label: 'Genie', data: getRankSeries("Genie"), borderColor: '#0096FF', tension: 0.2, spanGaps: true },
                    { label: 'YouTube', data: getRankSeries("Top_MV"), borderColor: '#E62117', tension: 0.2, spanGaps: true },
                    { label: 'Spotify', data: getRankSeries("Spotify"), borderColor: '#1DB954', tension: 0.2, spanGaps: true },
                    { label: 'Billboard', data: getRankSeries("Billboard"), borderColor: '#000', borderDash: [5,5], tension: 0.2, spanGaps: true },
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, min: 1, max: 200 } } }
        });

        // YouTube View Chart
        if(viewChartInst) viewChartInst.destroy();
        const ytItems = hist.filter(d => d.Chart.startsWith("KR_") || d.Chart.startsWith("US_"));
        const ytDates = [...new Set(ytItems.map(d=>d.Date))].sort();
        const charts = [...new Set(ytItems.map(d=>d.Chart))];
        const colors = ['#E62117', '#1A73E8', '#F9A825', '#2E7D32'];
        const mkDs = (key) => charts.map((c,i) => ({ label: c, data: ytDates.map(dt => { const item=ytItems.find(h=>h.Date===dt&&h.Chart===c); return item?item[key]:null; }), borderColor:colors[i%4], tension:0.4, fill:false, spanGaps: true }));
        viewChartInst = new Chart(document.getElementById('viewChart'), { type:'line', data:{labels:ytDates, datasets:mkDs('Views')}, options:{responsive:true, maintainAspectRatio:false} });

        document.querySelector("#historyTable tbody").innerHTML = hist.map(d => {
            let revCell = showRevenue ? `<td style="color:var(--green)">${d.Revenue>0?'â‚©'+d.Revenue.toLocaleString():'-'}</td>` : "";
            return `<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${d.Views>0?d.Views.toLocaleString():'-'}</td>${revCell}</tr>`;
        }).join("");
    }
    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
</script>
</body>
</html>
