<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Analytics | Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #161616;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --primary: #FF3B30; /* MusicDeal Red */
            --primary-glow: rgba(255, 59, 48, 0.4);
            --accent: #32D74B; /* Profit Green */
            --border: #333;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            min-height: 100vh;
        }

        /* === Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ === */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            text-align: center; width: 100%; max-width: 400px; padding: 40px;
            background: var(--card-bg); border-radius: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .login-title { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; margin-bottom: 10px; letter-spacing: -1px; }
        .login-title span { color: var(--primary); }
        .login-input {
            width: 100%; padding: 16px; margin-top: 20px;
            background: #000; border: 1px solid #333; border-radius: 12px;
            color: #fff; font-size: 1rem; text-align: center;
            transition: var(--transition);
        }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
        .login-btn {
            width: 100%; padding: 16px; margin-top: 15px;
            background: var(--primary); border: none; border-radius: 12px;
            color: #fff; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: var(--transition);
        }
        .login-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--primary-glow); }

        /* === Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà === */
        #app-content { display: none; opacity: 0; transition: opacity 1s; padding: 40px 5%; max-width: 1920px; margin: 0 auto; }
        
        /* Ìó§Îçî */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .brand { font-family: 'Montserrat', sans-serif; font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; }
        .brand span { color: var(--primary); }
        .date-badge { background: var(--card-bg); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); color: var(--text-sub); font-size: 0.9rem; font-family: 'Montserrat'; }

        /* KPI Ïπ¥Îìú ÏÑπÏÖò */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .kpi-card {
            background: var(--card-bg); border-radius: 20px; padding: 30px;
            border: 1px solid var(--border); position: relative; overflow: hidden;
            transition: var(--transition);
        }
        .kpi-card:hover { transform: translateY(-5px); border-color: #555; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .kpi-label { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2.2rem; font-weight: 800; margin: 10px 0 5px 0; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .kpi-value.money { background: linear-gradient(to right, #32D74B, #2da44e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .kpi-desc { font-size: 0.85rem; color: #666; }
        .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.2; }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 40px; background: var(--card-bg); padding: 8px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; border: 1px solid var(--border); }
        .tab-btn {
            padding: 12px 30px; border: none; background: transparent; cursor: pointer;
            border-radius: 40px; font-weight: 600; color: var(--text-sub); font-size: 1rem;
            transition: var(--transition);
        }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 0 20px var(--primary-glow); }
        
        .tab-content { display: none; animation: fadeInUp 0.5s ease; }
        .tab-content.active { display: block; }

        /* Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .control-bar {
            display: flex; gap: 20px; background: var(--card-bg); padding: 20px;
            border-radius: 16px; border: 1px solid var(--border); align-items: center; flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .control-item label { color: var(--text-sub); font-size: 0.85rem; margin-right: 10px; font-weight: 600; }
        input, select {
            background: #0a0a0a; border: 1px solid var(--border); color: #fff;
            padding: 10px 15px; border-radius: 8px; font-size: 0.95rem;
        }
        
        /* Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î */
        .table-box { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { 
            background: #252525; color: #fff; padding: 18px; text-align: center; 
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #444;
        }
        td { padding: 16px; border-bottom: 1px solid #2a2a2a; color: #ddd; text-align: center; font-size: 0.95rem; }
        tr:hover { background-color: #2a2a2a; cursor: pointer; }
        
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; background: #333; border-radius: 50%; font-size: 0.8rem; font-weight: bold; }
        .rank-1 { background: #FFD700; color: #000; }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }
        
        .trend-up { color: #ff453a; font-weight: bold; }
        .trend-down { color: #0a84ff; font-weight: bold; }
        .money-val { color: var(--accent); font-family: 'Montserrat'; font-weight: 700; }
        .highlight-cut { background: rgba(255, 59, 48, 0.1); border: 1px solid var(--primary); color: var(--primary); font-weight: bold; }

        /* Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑà */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
        .chart-card { background: var(--card-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border); height: 100%; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .chart-title { font-size: 1.2rem; font-weight: 700; color: #fff; }

        /* Î™®Îã¨ */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .modal-content {
            background: #1a1a1a; margin: 40px auto; width: 90%; max-width: 1200px; height: 90vh;
            border-radius: 24px; border: 1px solid #333; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header { padding: 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-title h2 { margin: 0; font-size: 2rem; font-weight: 800; }
        .modal-title p { margin: 5px 0 0 0; color: var(--text-sub); font-size: 1.1rem; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .close-btn { font-size: 36px; color: #666; cursor: pointer; transition: 0.2s; }
        .close-btn:hover { color: #fff; }

        /* Í≤ÄÏÉâÎ∞î */
        .search-wrapper { position: relative; margin-left: auto; width: 300px; }
        .search-wrapper input { width: 100%; padding-left: 40px; background: #000; border-color: #444; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; }

        /* ÌïòÎã® Ìë∏ÌÑ∞ */
        .footer-info { margin-top: 50px; border-top: 1px solid var(--border); padding-top: 30px; color: #555; font-size: 0.9rem; }
        .price-tag { display: inline-block; background: #222; padding: 5px 10px; border-radius: 6px; margin-right: 10px; border: 1px solid #333; }
        .price-tag span { color: var(--accent); font-weight: bold; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ïä§ÌÅ¨Î°§Î∞î Ïª§Ïä§ÌÖÄ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div class="login-title">MusicDeal <span>Admin</span></div>
        <p style="color:#888; margin-bottom:30px;">Authorized Personnel Only</p>
        <input type="password" id="passwordInput" class="login-input" placeholder="Enter Access Key" onkeyup="if(window.event.keyCode==13){checkLogin()}">
        <button class="login-btn" onclick="checkLogin()">Access Dashboard</button>
        <p id="login-msg" style="color:red; margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="app-content">
    <header>
        <div class="brand">MusicDeal <span>Analytics</span></div>
        <div class="date-badge">Last Updated: <span id="header-date">-</span></div>
    </header>

    <div class="summary-grid">
        <div class="kpi-card">
            <div class="kpi-icon">üí∞</div>
            <span class="kpi-label">Est. Daily Revenue (Top 100)</span>
            <div class="kpi-value money" id="total-revenue">-</div>
            <div class="kpi-desc">Based on daily chart performance</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üá∞üá∑</div>
            <span class="kpi-label">KR MV Entry Cut</span>
            <div class="kpi-value" id="kr-mv-cut">-</div>
            <div class="kpi-desc">Minimum views to enter Top 100</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üá∫üá∏</div>
            <span class="kpi-label">US MV Entry Cut</span>
            <div class="kpi-value" id="us-mv-cut">-</div>
            <div class="kpi-desc">Minimum views to enter Top 100</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily', this)">üìÖ Daily & Revenue</button>
        <button class="tab-btn" onclick="openTab('trend', this)">üìà Trend Analysis</button>
        <button class="tab-btn" onclick="openTab('cross', this)">üîó Cross Chart</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">‚ö° Shorts Strategy</button>
        <button class="tab-btn" onclick="openTab('long-run', this)">üßü Zombie Index</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="control-bar">
            <div class="control-item"><label>Date</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
            <div class="control-item"><label>Region</label><select id="countryFilter" onchange="updateChartFilter()"><option value="ALL">Global</option><option value="KR">üá∞üá∑ Korea</option><option value="US">üá∫üá∏ USA</option></select></div>
            <div class="control-item"><label>Chart</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">All Charts</option></select></div>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="dailySearch" placeholder="Search Song or Artist..." onkeyup="renderDaily()">
            </div>
        </div>
        <div class="table-box">
            <div class="table-scroll">
                <table id="dailyTable">
                    <thead><tr><th>Chart</th><th>Rank</th><th>Title</th><th>Artist</th><th>Views / Count</th><th>Delta (Daily)</th><th>Est. Revenue</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="trend" class="tab-content">
        <div class="chart-card" style="margin-bottom:20px;">
            <h3 class="chart-title">üìà Period Analysis (Avg Views & Revenue)</h3>
            <div class="table-box">
                <div class="table-scroll">
                    <table id="trendTable">
                        <thead><tr><th>Period</th><th>Chart</th><th>Top 1~10</th><th>11~20</th><th>21~30</th><th>31~40</th><th>41~50</th><th>Cut (100)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="cross" class="tab-content">
        <div class="control-bar">
            <div class="control-item" style="flex:1"><h3 style="margin:0">üîó Multi-Chart Artists</h3></div>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="crossSearch" placeholder="Search..." onkeyup="renderCross()">
            </div>
        </div>
        <div class="table-box">
            <div class="table-scroll">
                <table id="crossTable">
                    <thead><tr><th>Artist - Song</th><th>Chart Count</th><th>Included Charts</th><th>Best Rank</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="control-bar">
            <div class="control-item"><label>Date</label><input type="date" id="shortsDate" onchange="renderShortsStrategy()"></div>
            <div class="control-item"><label>Target</label><select id="shortsChartSelect" onchange="renderShortsStrategy()"><option value="KR_Daily_Top_Shorts">üá∞üá∑ KR Shorts</option><option value="US_Daily_Top_Shorts">üá∫üá∏ US Shorts</option></select></div>
            <div class="control-item" style="margin-left:auto;">
                <button class="tab-btn" style="padding:8px 16px; font-size:0.85rem;" onclick="setShortsPeriod(1, this)">1 Day</button>
                <button class="tab-btn" style="padding:8px 16px; font-size:0.85rem;" onclick="setShortsPeriod(7, this)">7 Days</button>
                <button class="tab-btn" style="padding:8px 16px; font-size:0.85rem;" onclick="setShortsPeriod(30, this)">30 Days</button>
            </div>
        </div>

        <div id="shortsKPI" style="margin-bottom:30px; padding:20px; background:rgba(255, 59, 48, 0.1); border:1px solid var(--primary); border-radius:12px; color:#fff;"></div>

        <div class="table-box" style="margin-bottom:30px;">
            <div class="table-scroll">
                <table id="shortsTable">
                    <thead><tr><th>Rank Range</th><th>Avg Total</th><th>Target Velocity</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="grid-2">
            <div class="chart-card">
                <h3 class="chart-title">üî• Viral Map (Scatter)</h3>
                <div style="height:350px"><canvas id="scatterChart"></canvas></div>
            </div>
            <div class="chart-card" style="display:flex; flex-direction:column;">
                <h3 class="chart-title">üöÄ Rising Rookies</h3>
                <div style="flex:1; overflow-y:auto;">
                    <table id="rookieTable"><thead><tr><th>Rank</th><th>Song</th><th>Velocity</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">üóìÔ∏è Weekly Heatmap (Upload Pattern)</h3>
            <div style="height:300px"><canvas id="dayChart"></canvas></div>
        </div>
    </div>

    <div id="long-run" class="tab-content">
        <div class="chart-card">
            <h3 class="chart-title">üßü Zombie Index (Long-Run Power)</h3>
            <p style="color:var(--text-sub); margin-bottom:20px;">* High score means the song survives on the chart for a long time with high rank.</p>
            <div class="table-box">
                <div class="table-scroll">
                    <table id="zombieTable">
                        <thead><tr><th>Song</th><th>Days on Chart</th><th>Avg Rank</th><th>Zombie Score</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-info">
        <h4>üí∞ Revenue Calculation Logic (2025 Est.)</h4>
        <div style="margin-top:10px;">
            <div class="price-tag">üá∞üá∑ KR Songs: <span>‚Ç©5</span></div>
            <div class="price-tag">üá∞üá∑ KR MV: <span>‚Ç©2.5</span></div>
            <div class="price-tag">üá∫üá∏ US Songs: <span>‚Ç©10</span></div>
            <div class="price-tag">üá∫üá∏ US MV: <span>‚Ç©4</span></div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">
                <h2 id="modalTitle">Title</h2>
                <p id="modalArtist">Artist</p>
            </div>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                <div class="kpi-card" style="padding:20px; border-left:4px solid var(--accent);">
                    <span class="kpi-label">Est. Total Revenue</span>
                    <div class="kpi-value money" id="mRevenue" style="font-size:1.8rem">-</div>
                </div>
                <div class="kpi-card" style="padding:20px;">
                    <span class="kpi-label">Best Rank</span>
                    <div class="kpi-value" id="mBestRank" style="font-size:1.8rem">-</div>
                </div>
                <div class="kpi-card" style="padding:20px;">
                    <span class="kpi-label">Peak Views</span>
                    <div class="kpi-value" id="mPeakView" style="font-size:1.8rem">-</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="chart-card"><canvas id="viewChart"></canvas></div>
                <div class="chart-card"><canvas id="rankChart"></canvas></div>
            </div>
            
            <div class="table-box">
                <div class="table-scroll">
                    <table id="historyTable">
                        <thead>
                            </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // üîê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï (Ïó¨Í∏∞ÏÑú Î∞îÍæ∏ÏÑ∏Ïöî)
    const ACCESS_KEY = "musicdeal2025"; 
    // üî¥ CSV ÎßÅÌÅ¨
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    // ============================================================

    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };
    let rawData = [], uniqueCharts = [];
    let scatterChartInst=null, dayChartInst=null, vChart=null, rChart=null;
    let shortsPeriod = 1;

    // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
    function checkLogin() {
        const input = document.getElementById('passwordInput').value;
        const msg = document.getElementById('login-msg');
        if(input === ACCESS_KEY) {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                setTimeout(() => document.getElementById('app-content').style.opacity = '1', 100);
                loadData(); // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            }, 500);
            localStorage.setItem('musicdeal_auth', 'true');
        } else {
            msg.innerText = "Access Denied: Invalid Key";
            document.getElementById('passwordInput').value = "";
        }
    }

    // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÌôïÏù∏
    if(localStorage.getItem('musicdeal_auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('app-content').style.opacity = '1';
        loadData();
    }

    function loadData() {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                document.getElementById("header-date").innerText = lastDate;
                updateSummary(lastDate);
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                
                renderDaily(); renderTrend(); renderCross(); renderShortsStrategy(); renderLongRun();
            }
        });
    }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            let vStr = getCol(6).replace(/,/g, "");
            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: getCol(3), Artist: getCol(4), Views: parseInt(vStr) || 0, Delta: 0, Revenue: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        const map = {};
        rawData.forEach(d => {
            let rate = 0;
            const isKR = d.Chart.includes("KR"), isSong = d.Chart.includes("Songs"), isShorts = d.Chart.includes("Shorts");
            if(!isShorts) {
                if(isKR) rate = isSong ? RATES.KR.song : RATES.KR.mv; else rate = isSong ? RATES.US.song : RATES.US.mv;
                d.Revenue = Math.round(d.Views * rate);
            }
            const key = `${d.Chart}|${d.Title}|${d.Artist}`;
            if(!map[key]) map[key] = []; map[key].push(d);
        });
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=1; i<list.length; i++) {
                const diff = (new Date(list[i].Date) - new Date(list[i-1].Date))/(1000*3600*24);
                if(diff === 1) list[i].Delta = list[i].Views - list[i-1].Views;
            }
        });
    }

    function updateSummary(date) {
        document.getElementById("current-date").innerText = date;
        document.getElementById("data-count").innerText = rawData.length.toLocaleString() + " Rows";
        const todayData = rawData.filter(d => d.Date === date);
        const totalRev = todayData.reduce((sum, d) => sum + d.Revenue, 0);
        document.getElementById("total-revenue").innerText = "‚Ç©" + totalRev.toLocaleString();
        const getCut = (chart) => {
            const cutRank = chart.includes("Trending") ? 20 : (chart.includes("Shorts") ? 50 : 100);
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === cutRank);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    function openTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // [1] Îç∞ÏùºÎ¶¨
    function updateChartFilter() {
        const country = document.getElementById("countryFilter").value;
        const chartSelect = document.getElementById("chartFilter");
        chartSelect.innerHTML = '<option value="ALL">All Charts</option>';
        uniqueCharts.forEach(chart => {
            if(country === "ALL" || chart.startsWith(country)) {
                const opt = document.createElement("option"); opt.value = chart; opt.innerText = chart; chartSelect.appendChild(opt);
            }
        });
        renderDaily();
    }
    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const search = document.getElementById("dailySearch").value.toLowerCase();
        const tbody = document.querySelector("#dailyTable tbody");
        
        let data = rawData.filter(d => d.Date === date);
        if(country !== "ALL") data = data.filter(d => d.Chart.startsWith(country));
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);
        if(search) data = data.filter(d => d.Title.toLowerCase().includes(search) || d.Artist.toLowerCase().includes(search));

        tbody.innerHTML = data.map(d => {
            let delta = d.Delta > 0 ? `<span class="rank-up">‚ñ≤${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">‚ñº${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            let revStr = d.Revenue > 0 ? `‚Ç©${d.Revenue.toLocaleString()}` : "-";
            let rankClass = d.Rank <= 3 ? `rank-${d.Rank}` : '';
            let rankDisp = d.Rank <= 3 ? `<span class="rank-badge ${rankClass}">${d.Rank}</span>` : d.Rank;
            
            return `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')">
                <td>${d.Chart}</td><td>${rankDisp}</td><td style="font-weight:bold; color:#fff;">${d.Title}</td><td>${d.Artist}</td><td style="font-weight:bold">${d.Views.toLocaleString()}</td><td>${delta}</td><td class="money-val">${revStr}</td></tr>`;
        }).join("") || `<tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">No Data Found</td></tr>`;
    }

    // [2] Ìä∏Î†åÎìú
    function renderTrend() {
        const tbody = document.querySelector("#trendTable tbody");
        const stats = {};
        rawData.forEach(d => {
            const key = d.Date.substring(0, 7) + "|" + d.Chart;
            if(!stats[key]) stats[key] = { s:[0,0,0,0,0,0], r:[0,0,0,0,0,0], c:[0,0,0,0,0,0], sumCut:0, cntCut:0 };
            const s = stats[key];
            let idx = -1;
            if(d.Rank<=10) idx=0; else if(d.Rank<=30) idx=1; else if(d.Rank<=50) idx=2; else if(d.Rank<=70) idx=3; else if(d.Rank<=100) idx=4;
            if(idx>=0) { s.s[idx]+=d.Views; s.r[idx]+=d.Revenue; s.c[idx]++; }
            const cutRank = d.Chart.includes("Trending")?20:(d.Chart.includes("Shorts")?50:100);
            if(d.Rank===cutRank) { s.sumCut+=d.Views; s.cntCut++; }
        });
        tbody.innerHTML = Object.keys(stats).sort().reverse().map(k => {
            const [m, c] = k.split("|"); const s = stats[k];
            let cols = ""; 
            for(let i=0; i<5; i++) {
                const avgV = s.c[i] ? Math.round(s.s[i]/s.c[i]).toLocaleString() : "-";
                const avgR = s.c[i] && s.r[i] > 0 ? `‚Ç©${Math.round(s.r[i]/s.c[i]).toLocaleString()}` : "";
                cols += `<td>${avgV}${avgR ? '<br><span style="font-size:0.8em; color:var(--accent)">'+avgR+'</span>' : ''}</td>`;
            }
            const cut = s.cntCut ? Math.round(s.sumCut/s.cntCut).toLocaleString() : "-";
            return `<tr><td>${m}</td><td style="text-align:left">${c}</td>${cols}<td class="highlight-cut">${cut}</td></tr>`;
        }).join("");
    }

    // [3] ÌÅ¨Î°úÏä§
    function renderCross() {
        const tbody = document.querySelector("#crossTable tbody");
        const search = document.getElementById("crossSearch").value.toLowerCase();
        const lastDate = rawData[rawData.length-1].Date;
        const data = rawData.filter(d => d.Date === lastDate);
        const map = {};
        data.forEach(d => {
            const k = `${d.Artist} - ${d.Title}`; 
            if(!map[k]) map[k] = { charts: [], minRank: 999 }; 
            map[k].charts.push(d.Chart); 
            if(d.Rank < map[k].minRank) map[k].minRank = d.Rank;
        });
        const crosses = Object.entries(map).filter(([k,v]) => v.charts.length > 1).sort((a,b) => b[1].charts.length - a[1].charts.length);
        
        let html = crosses.filter(([k]) => k.toLowerCase().includes(search)).map(([k, v]) => 
            `<tr onclick="openDetail('${k.split(" - ")[1].replace(/'/g, "\\'")}', '${k.split(" - ")[0].replace(/'/g, "\\'")}')">
                <td style="font-weight:bold; color:#fff;">${k}</td><td style="color:var(--primary); font-weight:800">${v.charts.length} Charts</td><td>${v.charts.join(", ")}</td><td>${v.minRank}</td></tr>`
        ).join("");
        tbody.innerHTML = html || `<tr><td colspan="4" style="text-align:center; padding:30px;">No Data</td></tr>`;
    }

    // [4] ÏáºÏ∏†
    function setShortsPeriod(days, btn) {
        shortsPeriod = days;
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderShortsStrategy();
    }
    function renderShortsStrategy() {
        const date = document.getElementById("shortsDate").value;
        const chartName = document.getElementById("shortsChartSelect").value;
        const data = rawData.filter(d => d.Date === date && d.Chart === chartName);
        if(data.length === 0) { document.getElementById("shortsKPI").innerHTML = "No Data"; return; }

        let pLabel = "Daily"; if(shortsPeriod===7) pLabel="Weekly Avg"; if(shortsPeriod===30) pLabel="Monthly Avg";

        // Í∏∞Í∞Ñ ÌèâÍ∑† Í≥ÑÏÇ∞ Ìï®Ïàò
        const calcPeriodAvg = (items) => {
            if(!items || items.length === 0) return 0;
            let totalDelta = 0, count = 0;
            const targetDate = new Date(date);
            const startDate = new Date(targetDate);
            startDate.setDate(targetDate.getDate() - shortsPeriod + 1);
            
            items.forEach(item => {
                const hist = rawData.filter(d => d.Title === item.Title && d.Artist === item.Artist && new Date(d.Date) >= startDate && new Date(d.Date) <= targetDate);
                const validDeltas = hist.filter(h => h.Delta > 0);
                if(validDeltas.length > 0) { totalDelta += validDeltas.reduce((a,b)=>a+b.Delta,0) / validDeltas.length; count++; }
            });
            return count > 0 ? Math.round(totalDelta / count) : 0;
        };

        const top10Items = data.filter(d => d.Rank <= 10);
        const avgSpeed = calcPeriodAvg(top10Items);
        const cutItem = data.find(d => d.Rank === 50);
        const cutSpeed = cutItem ? calcPeriodAvg([cutItem]) : 0;

        document.getElementById("shortsKPI").innerHTML = `<strong>üí° ${pLabel} Strategy:</strong> Top 10 Speed <span style="color:var(--primary)">+${avgSpeed.toLocaleString()}/day</span> | Rank 50 Cut <span style="color:#0a84ff">+${cutSpeed.toLocaleString()}/day</span>`;

        if(scatterChartInst) scatterChartInst.destroy();
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const points = data.filter(d => d.Delta > 0).map(d => ({ x: d.Views, y: d.Delta, title: d.Title, rank: d.Rank }));
        scatterChartInst = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Songs', data: points, backgroundColor: p=>p.raw.rank<=10?'#FF3B30':(p.raw.rank<=50?'#32D74B':'#666') }] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: {type:'logarithmic', title:{display:true, text:'Total (Log)'}}, y: {title:{display:true, text:'Daily Velocity'}} }, plugins: { tooltip: { callbacks: { label: c => `${c.raw.rank}. ${c.raw.title}` } } } } });

        const avgD = data.reduce((a,b)=>a+(b.Delta>0?b.Delta:0),0) / data.length;
        const rookies = data.filter(d => d.Rank > 20 && d.Delta > avgD).sort((a,b) => b.Delta - a.Delta);
        document.querySelector("#rookieTable tbody").innerHTML = rookies.slice(0, 10).map(d => `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')"><td>${d.Rank}</td><td style="color:#fff">${d.Title}</td><td style="color:var(--primary)">+${(d.Delta*shortsPeriod).toLocaleString()}</td></tr>`).join("");

        const tbody = document.querySelector("#shortsTable tbody");
        let html = "";
        for(let i=0; i<5; i++) {
            const s = i*10+1; const e = (i+1)*10;
            const seg = data.filter(d => d.Rank >= s && d.Rank <= e);
            const avgT = seg.length ? Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length) : 0;
            const periodAvgSpeed = calcPeriodAvg(seg);
            html += `<tr><td>${s}~${e}</td><td>${avgT.toLocaleString()}</td><td style="color:var(--primary); font-weight:bold">+${periodAvgSpeed.toLocaleString()} / day</td></tr>`;
        }
        
        if(cutItem) {
            const cutTotal = cutItem.Views.toLocaleString();
            const cutVelo = calcPeriodAvg([cutItem]).toLocaleString();
            html += `<tr class="entry-row"><td style="color:var(--primary)">üèÅ Rank 50 Cut</td><td style="font-weight:bold">${cutTotal}</td><td style="color:var(--primary); font-weight:bold">+${cutVelo} / day</td></tr>`;
        }
        tbody.innerHTML = html;

        const dayStats = [0,0,0,0,0,0,0], dayCnt = [0,0,0,0,0,0,0];
        rawData.filter(d => d.Chart === chartName && d.Delta > 0).forEach(d => { const day = new Date(d.Date).getDay(); dayStats[day]+=d.Delta; dayCnt[day]++; });
        const dayAvgs = dayStats.map((s,i) => dayCnt[i] ? Math.round(s/dayCnt[i]) : 0);
        if(dayChartInst) dayChartInst.destroy();
        const dayCtx = document.getElementById('dayChart').getContext('2d');
        dayChartInst = new Chart(dayCtx, { type: 'bar', data: { labels:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], datasets:[{ label:'Avg Velocity', data:dayAvgs, backgroundColor:'rgba(255, 59, 48, 0.7)' }] }, options:{responsive:true, maintainAspectRatio:false} });
    }

    // [5] Î°±Îü∞
    function renderLongRun() {
        const map = {}; rawData.forEach(d => { const k=`${d.Chart}|${d.Title}|${d.Artist}`; if(!map[k]) map[k]={c:0, r:0}; map[k].c++; map[k].r+=d.Rank; });
        const zombies = Object.entries(map).map(([k,v]) => { const [c,t,a]=k.split("|"); const ar=Math.round(v.r/v.c); const s=Math.round(v.c*1000/ar); return {chart:c, title:t, artist:a, days:v.c, ar, s}; }).sort((a,b)=>b.s-a.s).slice(0,20);
        document.querySelector("#zombieTable tbody").innerHTML = zombies.map(z => `<tr onclick="openDetail('${z.title.replace(/'/g, "\\'")}', '${z.artist.replace(/'/g, "\\'")}')"><td style="color:#fff">${z.title}</td><td>${z.days} Days</td><td>${z.ar}</td><td style="color:var(--accent); font-weight:bold">${z.s}</td><td>${z.s>=2000?'üëë God':(z.s>=1000?'üßü Zombie':'üå± Rookie')}</td></tr>`).join("");
    }

    function openDetail(title, artist) {
        document.getElementById("detailModal").style.display = "block";
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalArtist").innerText = artist;
        const hist = rawData.filter(d => d.Title === title && d.Artist === artist).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        
        const bestRank = Math.min(...hist.map(d=>d.Rank));
        const peakView = Math.max(...hist.map(d=>d.Views));
        const totalRev = hist.reduce((sum, d) => sum + d.Revenue, 0);

        document.getElementById("mBestRank").innerText = bestRank;
        document.getElementById("mPeakView").innerText = peakView.toLocaleString();
        document.getElementById("mRevenue").innerText = "‚Ç©" + totalRev.toLocaleString();

        if(vChart) vChart.destroy(); if(rChart) rChart.destroy();
        const dates = [...new Set(hist.map(d=>d.Date))].sort();
        const charts = [...new Set(hist.map(d=>d.Chart))];
        const colors = ['#FF3B30', '#32D74B', '#0A84FF', '#FFD60A'];
        const mkDs = (key) => charts.map((c,i) => ({ label: c, data: dates.map(dt => { const item=hist.find(h=>h.Date===dt&&h.Chart===c); return item?item[key]:null; }), borderColor:colors[i%4], fill:false }));
        vChart = new Chart(document.getElementById('viewChart'), { type:'line', data:{labels:dates, datasets:mkDs('Views')}, options:{responsive:true, maintainAspectRatio:false} });
        rChart = new Chart(document.getElementById('rankChart'), { type:'line', data:{labels:dates, datasets:mkDs('Rank')}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{reverse:true}}} });

        // üî• Î™®Îã¨ Ìó§Îçî Í∞ïÏ†ú ÏÇΩÏûÖ (Ïä§ÌÉÄÏùº ÏßÅÏ†ë Ï£ºÏûÖ)
        document.querySelector("#historyTable thead").innerHTML = `
            <tr style="background:#252525; color:#fff;">
                <th style="padding:12px; text-align:center;">Date</th>
                <th style="padding:12px; text-align:center;">Chart</th>
                <th style="padding:12px; text-align:center;">Rank</th>
                <th style="padding:12px; text-align:center;">Views</th>
                <th style="padding:12px; text-align:center;">Delta</th>
                <th style="padding:12px; text-align:center;">Revenue</th>
            </tr>
        `;

        document.querySelector("#historyTable tbody").innerHTML = hist.map(d => 
            `<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${d.Views.toLocaleString()}</td><td style="color:${d.Delta>0?'var(--primary)':'inherit'}">${d.Delta>0?'+':''}${d.Delta.toLocaleString()}</td><td style="color:var(--accent)">‚Ç©${d.Revenue.toLocaleString()}</td></tr>`).join("");
    }
    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
</script>
</body>
</html>
