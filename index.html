<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Insight Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #E62117; --secondary: #0F0F0F; --bg: #F9F9F9; --white: #ffffff; --gray: #606060; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--secondary); }
        
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; font-weight: 800; color: var(--secondary); }
        
        /* ìƒë‹¨ ìš”ì•½ ì¹´ë“œ */
        .summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .summary-title { font-size: 0.9em; color: var(--gray); font-weight: 600; margin-bottom: 10px; display: block; }
        .summary-value { font-size: 1.8em; font-weight: 800; color: var(--secondary); }
        .summary-sub { font-size: 0.85em; color: var(--gray); margin-top: 5px; }

        /* íƒ­ */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 24px; border: none; background: #e5e5e5; cursor: pointer; border-radius: 24px; font-weight: 700; font-size: 15px; color: var(--gray); transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(230, 33, 23, 0.3); }
        .tab-content { display: none; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 2px 20px rgba(0,0,0,0.03); }
        .tab-content.active { display: block; }

        /* ì»¨íŠ¸ë¡¤ */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f1f1f1; border-radius: 8px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-weight: bold; font-size: 14px; }
        select, input[type="date"] { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 120px; }

        /* í…Œì´ë¸” */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th { background: var(--secondary); color: white; padding: 14px; position: sticky; top: 0; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        tr:hover { background-color: #fff5f5; cursor: pointer; }
        .rank-up { color: var(--primary); font-weight: bold; }
        .rank-down { color: blue; }
        .song-title { font-weight: 600; color: #333; text-align: left; }
        .highlight-cut { color: var(--primary); font-weight: 800; background: #fff0f0; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: white; margin: 3% auto; padding: 30px; border-radius: 16px; width: 90%; max-width: 1100px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 800px) { .chart-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ MusicDeal Insight Analytics</h1>
    
    <div class="summary-section">
        <div class="summary-card">
            <span class="summary-title">ğŸ‡°ğŸ‡· KR Daily MV Top 100 ì§„ì…ì»· (ì˜¤ëŠ˜)</span>
            <div class="summary-value" id="kr-mv-cut">-</div>
            <div class="summary-sub" id="kr-mv-desc">ë°ì´í„° ë¡œë”©ì¤‘...</div>
        </div>
        <div class="summary-card">
            <span class="summary-title">ğŸ‡ºğŸ‡¸ US Daily MV Top 100 ì§„ì…ì»· (ì˜¤ëŠ˜)</span>
            <div class="summary-value" id="us-mv-cut">-</div>
            <div class="summary-sub" id="us-mv-desc">ë°ì´í„° ë¡œë”©ì¤‘...</div>
        </div>
        <div class="summary-card">
            <span class="summary-title">ğŸ“… ë°ì´í„° ê¸°ì¤€ì¼</span>
            <div class="summary-value" id="current-date">-</div>
            <div class="summary-sub" id="data-count">-</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily')">ğŸ“… ë°ì¼ë¦¬ ìƒì„¸ ë¶„ì„</button>
        <button class="tab-btn" onclick="openTab('trend')">ğŸ“ˆ ì›”ê°„/ì—°ê°„ ì¶”ì´</button>
        <button class="tab-btn" onclick="openTab('shorts')">âš¡ ì‡¼ì¸  ì „ëµ</button>
        <button class="tab-btn" onclick="openTab('cross')">ğŸ”— í¬ë¡œìŠ¤ ì°¨íŠ¸</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="controls">
            <div class="control-group"><label>ğŸ“… ë‚ ì§œ:</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
            <div class="control-group"><label>ğŸ³ï¸ êµ­ê°€:</label><select id="countryFilter" onchange="updateChartFilter()"><option value="ALL">ì „ì²´ ë³´ê¸°</option><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (KR)</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (US)</option></select></div>
            <div class="control-group"><label>ğŸ“Š ì°¨íŠ¸:</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´ ì°¨íŠ¸</option></select></div>
        </div>
        <div class="table-wrap"><table id="dailyTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="trend" class="tab-content">
        <h3>ğŸ“… ê¸°ê°„ë³„ ì§„ì… í•„ìš” ìˆ˜ì¹˜ ë³€í™” (ëˆ„ì  í‰ê· )</h3>
        <div class="table-wrap"><table id="trendTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="shorts" class="tab-content">
        <h3>âš¡ ì‡¼ì¸  ìƒì„±ëŸ‰ ê¸°ë°˜ ì§„ì… ì „ëµ (êµ¬ê°„ë³„ ìƒì„¸)</h3>
        <div class="controls"><label>ê¸°ì¤€ì¼: <input type="date" id="shortsDate" onchange="renderShorts()"></label></div>
        <div class="table-wrap"><table id="shortsTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="cross" class="tab-content">
        <h3>ğŸ”— ë©€í‹° ì°¨íŠ¸ ì§„ì… ì•„í‹°ìŠ¤íŠ¸</h3>
        <div class="table-wrap"><table id="crossTable"><thead></thead><tbody></tbody></table></div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">ì œëª©</h2>
        <p id="modalArtist">ì•„í‹°ìŠ¤íŠ¸</p>
        <div class="chart-grid"><canvas id="viewChart"></canvas><canvas id="rankChart"></canvas></div>
        <h3>ğŸ“‹ ìƒì„¸ ì´ë ¥</h3>
        <div class="table-wrap"><table id="historyTable"><thead></thead><tbody></tbody></table></div>
    </div>
</div>

<script>
    // ============================================================
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    // ============================================================

    let rawData = [];
    let uniqueCharts = [];

    fetch(SHEET_CSV_URL)
        .then(res => res.text())
        .then(text => {
            rawData = parseCSV(text);
            calculateDeltas();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                updateSummary(lastDate);
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                renderDaily();
                renderTrend();
                renderShorts();
                renderCross();
            }
        });

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            let vStr = getCol(6).replace(/,/g, "");
            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: getCol(3), Artist: getCol(4), Views: parseInt(vStr) || 0, Delta: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateDeltas() {
        const map = {};
        rawData.forEach(d => {
            const key = `${d.Chart}|${d.Title}|${d.Artist}`;
            if(!map[key]) map[key] = [];
            map[key].push(d);
        });
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=1; i<list.length; i++) {
                const diff = (new Date(list[i].Date) - new Date(list[i-1].Date))/(1000*3600*24);
                if(diff === 1) list[i].Delta = list[i].Views - list[i-1].Views;
            }
        });
    }

    function updateSummary(date) {
        document.getElementById("current-date").innerText = date;
        document.getElementById("data-count").innerText = `ì´ ë°ì´í„° ${rawData.length.toLocaleString()}ê±´`;
        const getCut = (chart) => {
            const cutRank = chart.includes("Trending") ? 20 : (chart.includes("Shorts") ? 50 : 100);
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === cutRank);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
        document.getElementById("kr-mv-desc").innerText = "KR Daily MV Top 100 ì»·";
        document.getElementById("us-mv-desc").innerText = "US Daily MV Top 100 ì»·";
    }

    function updateChartFilter() {
        const country = document.getElementById("countryFilter").value;
        const chartSelect = document.getElementById("chartFilter");
        chartSelect.innerHTML = '<option value="ALL">ì „ì²´ ì°¨íŠ¸</option>';
        uniqueCharts.forEach(chart => {
            if(country === "ALL" || chart.startsWith(country)) {
                const opt = document.createElement("option");
                opt.value = chart;
                opt.innerText = chart;
                chartSelect.appendChild(opt);
            }
        });
        renderDaily();
    }

    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const tbody = document.querySelector("#dailyTable tbody");
        const thead = document.querySelector("#dailyTable thead");
        thead.innerHTML = `<tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¡°íšŒìˆ˜(ê°œìˆ˜)</th><th>ì „ì¼ ëŒ€ë¹„</th></tr>`;

        let data = rawData.filter(d => d.Date === date);
        if(country !== "ALL") data = data.filter(d => d.Chart.startsWith(country));
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);

        let html = "";
        data.forEach(d => {
            let deltaStr = "-";
            if(d.Delta > 0) deltaStr = `<span class="rank-up">â–² ${d.Delta.toLocaleString()}</span>`;
            else if(d.Delta < 0) deltaStr = `<span class="rank-down">â–¼ ${Math.abs(d.Delta).toLocaleString()}</span>`;
            html += `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')"><td>${d.Chart}</td><td>${d.Rank}</td><td class="song-title">${d.Title}</td><td>${d.Artist}</td><td style="font-weight:bold">${d.Views.toLocaleString()}</td><td>${deltaStr}</td></tr>`;
        });
        tbody.innerHTML = html || `<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    }

    function renderTrend() {
        const tbody = document.querySelector("#trendTable tbody");
        const thead = document.querySelector("#trendTable thead");
        thead.innerHTML = `<tr><th>ê¸°ê°„</th><th>ì°¨íŠ¸</th><th>Top 10 í‰ê· </th><th>Top 50 í‰ê· </th><th>Top 100 í‰ê· </th><th class="highlight-cut">ì§„ì… ì»· (í‰ê· )</th></tr>`;
        
        const stats = {};
        rawData.forEach(d => {
            const key = d.Date.substring(0, 7) + "|" + d.Chart;
            if(!stats[key]) stats[key] = { sum10:0, cnt10:0, sum50:0, cnt50:0, sum100:0, cnt100:0, sumCut:0, cntCut:0 };
            const s = stats[key];
            if(d.Rank <= 10) { s.sum10 += d.Views; s.cnt10++; }
            if(d.Rank <= 50) { s.sum50 += d.Views; s.cnt50++; }
            if(d.Rank <= 100) { s.sum100 += d.Views; s.cnt100++; }
            
            const cutRank = d.Chart.includes("Trending") ? 20 : (d.Chart.includes("Shorts") ? 50 : 100);
            if(d.Rank === cutRank) { s.sumCut += d.Views; s.cntCut++; }
        });

        let html = "";
        Object.keys(stats).sort().reverse().forEach(key => {
            const [month, chart] = key.split("|");
            const s = stats[key];
            const avg10 = s.cnt10 ? Math.round(s.sum10/s.cnt10) : 0;
            const avg50 = s.cnt50 ? Math.round(s.sum50/s.cnt50) : 0;
            const avg100 = s.cnt100 ? Math.round(s.sum100/s.cnt100) : 0;
            const avgCut = s.cntCut ? Math.round(s.sumCut/s.cntCut) : 0;
            html += `<tr><td>${month}</td><td style="text-align:left">${chart}</td><td>${avg10.toLocaleString()}</td><td>${avg50.toLocaleString()}</td><td>${avg100.toLocaleString()}</td><td class="highlight-cut">${avgCut.toLocaleString()}</td></tr>`;
        });
        tbody.innerHTML = html;
    }

    // [ìˆ˜ì •ë¨] ì‡¼ì¸  ì „ëµ: 10, 20, 30, 40, 50ìœ„ êµ¬ê°„ìœ¼ë¡œ í™•ì¥
    function renderShorts() {
        const date = document.getElementById("shortsDate").value;
        const tbody = document.querySelector("#shortsTable tbody");
        const thead = document.querySelector("#shortsTable thead");
        
        // 5ê°œ êµ¬ê°„ ì»¬ëŸ¼ ìƒì„±
        thead.innerHTML = `<tr><th>ì°¨íŠ¸</th><th>Rank 1~10</th><th>Rank 11~20</th><th>Rank 21~30</th><th>Rank 31~40</th><th>Rank 41~50</th><th class="highlight-cut">ì§„ì… ì»· (50ìœ„)</th></tr>`;
        
        const data = rawData.filter(d => d.Date === date && d.Chart.includes("Shorts"));
        const charts = [...new Set(data.map(d => d.Chart))];
        let html = "";
        
        charts.forEach(chart => {
            const cData = data.filter(d => d.Chart === chart);
            
            let cols = "";
            for(let i=0; i<5; i++) {
                const s = i*10 + 1;
                const e = (i+1)*10;
                const seg = cData.filter(d => d.Rank >= s && d.Rank <= e);
                const avgTotal = seg.length ? Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length) : 0;
                const deltaSeg = seg.filter(d => d.Delta > 0);
                const avgDelta = deltaSeg.length ? Math.round(deltaSeg.reduce((a,b)=>a+b.Delta,0)/deltaSeg.length) : 0;
                
                let valStr = `${avgTotal.toLocaleString()}<br><span style="font-size:0.8em; color:#888">(ëˆ„ì )</span>`;
                if(avgDelta > 0) valStr = `<span style="color:red; font-weight:bold">+${avgDelta.toLocaleString()}</span><br><span style="font-size:0.8em; color:#888">(ì¼ê°„)</span>`;
                
                cols += `<td>${valStr}</td>`;
            }

            const cutItem = cData.find(d => d.Rank === 50);
            let cutVal = "-";
            if(cutItem) {
                cutVal = cutItem.Delta > 0 ? `<span style="color:red; font-weight:bold">+${cutItem.Delta.toLocaleString()}</span>` : `${cutItem.Views.toLocaleString()}`;
            }

            html += `<tr><td style="font-weight:bold">${chart}</td>${cols}<td class="highlight-cut">${cutVal}</td></tr>`;
        });
        tbody.innerHTML = html || `<tr><td colspan="7">ë°ì´í„° ë¶€ì¡± (ì‡¼ì¸  ë°ì´í„° ì—†ìŒ)</td></tr>`;
    }

    function renderCross() {
        const tbody = document.querySelector("#crossTable tbody");
        const thead = document.querySelector("#crossTable thead");
        thead.innerHTML = `<tr><th>ì•„í‹°ìŠ¤íŠ¸ - ë…¸ë˜</th><th>ì§„ì… ì°¨íŠ¸ ìˆ˜</th><th>ì°¨íŠ¸ ëª©ë¡</th><th>ìµœê³  ìˆœìœ„</th></tr>`;
        const lastDate = rawData[rawData.length-1].Date;
        const data = rawData.filter(d => d.Date === lastDate);
        const map = {};
        data.forEach(d => {
            const key = `${d.Artist} - ${d.Title}`;
            if(!map[key]) map[key] = { charts: [], minRank: 999 };
            map[key].charts.push(d.Chart);
            if(d.Rank < map[key].minRank) map[key].minRank = d.Rank;
        });
        const crosses = Object.entries(map).filter(([k,v]) => v.charts.length > 1);
        crosses.sort((a,b) => b[1].charts.length - a[1].charts.length);
        let html = "";
        crosses.forEach(([key, val]) => {
            html += `<tr onclick="openDetail('${key.split(" - ")[1].replace(/'/g, "\\'")}', '${key.split(" - ")[0].replace(/'/g, "\\'")}')"><td class="song-title">${key}</td><td style="font-weight:bold; color:purple">${val.charts.length}</td><td>${val.charts.join(", ")}</td><td>${val.minRank}ìœ„</td></tr>`;
        });
        tbody.innerHTML = html;
    }

    let vChart = null, rChart = null;
    function openDetail(title, artist) {
        document.getElementById("detailModal").style.display = "block";
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalArtist").innerText = artist;
        const history = rawData.filter(d => d.Title === title && d.Artist === artist);
        const dates = [...new Set(history.map(d => d.Date))].sort();
        const charts = [...new Set(history.map(d => d.Chart))];
        const tbody = document.querySelector("#historyTable");
        tbody.innerHTML = `<thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜</th><th>ì¦ê°</th></tr></thead><tbody>` + 
        history.sort((a,b)=>new Date(b.Date)-new Date(a.Date)).map(d => `<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${d.Views.toLocaleString()}</td><td>${d.Delta}</td></tr>`).join("") + `</tbody>`;
        if(vChart) vChart.destroy();
        if(rChart) rChart.destroy();
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
        const makeDataset = (key) => charts.map((c, i) => ({ label: c, data: dates.map(dt => { const item = history.find(h => h.Date === dt && h.Chart === c); return item ? item[key] : null; }), borderColor: colors[i%colors.length], fill: false }));
        vChart = new Chart(document.getElementById('viewChart'), { type: 'line', data: { labels: dates, datasets: makeDataset('Views') }, options: { responsive: true, plugins: { title: { display: true, text: 'ì¡°íšŒìˆ˜ ì¶”ì´' } } } });
        rChart = new Chart(document.getElementById('rankChart'), { type: 'line', data: { labels: dates, datasets: makeDataset('Rank') }, options: { responsive: true, scales: { y: { reverse: true } }, plugins: { title: { display: true, text: 'ìˆœìœ„ ì¶”ì´' } } } });
    }
    
    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
