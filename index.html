<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Insight Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #FF0000; --secondary: #282828; --bg: #f9f9f9; --white: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; }
        .status { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px; }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: #ddd; cursor: pointer; border-radius: 20px; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255,0,0,0.3); }
        .tab-content { display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* í…Œì´ë¸” ê³µí†µ */
        .table-wrap { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th { background: var(--secondary); color: white; padding: 12px; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        tr:hover { background-color: #f0f0f0; cursor: pointer; }
        
        .rank-up { color: red; font-weight: bold; }
        .rank-down { color: blue; }
        .highlight-song { color: var(--primary); font-weight: bold; text-decoration: underline; }
        
        /* í¬ë¡œìŠ¤ ì°¨íŠ¸ ë±ƒì§€ */
        .cross-badge { background: #6f42c1; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }

        /* ëª¨ë‹¬ (ìƒì„¸ë³´ê¸°) */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 800px) { .chart-grid { grid-template-columns: 1fr; } }
        
        .insight-box { background: #f0f8ff; padding: 15px; border-left: 5px solid #007bff; margin-bottom: 20px; border-radius: 4px; }
        .insight-title { font-weight: bold; display: block; margin-bottom: 5px; font-size: 1.1em; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        input[type="date"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ MusicDeal Insight Analytics</h1>
    <div class="status" id="data-status">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily')">ğŸ“… ë°ì¼ë¦¬ ì¢…í•©</button>
        <button class="tab-btn" onclick="openTab('shorts-insight')">âš¡ ì‡¼ì¸  ìƒì„± ì „ëµ (New)</button>
        <button class="tab-btn" onclick="openTab('cross-chart')">ğŸ”— í¬ë¡œìŠ¤ ì°¨íŠ¸ ë¶„ì„</button>
        <button class="tab-btn" onclick="openTab('monthly')">ğŸ—“ï¸ ì›”ê°„/ì—°ê°„ ìš”ì•½</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="controls">
            <h3>ì¼ê°„ ì°¨íŠ¸ í˜„í™©</h3>
            <input type="date" id="dailyDate" onchange="renderDaily()">
        </div>
        <div class="insight-box">
            <span class="insight-title">ğŸ’¡ ì‚¬ìš© íŒ</span>
            ë…¸ë˜ ì œëª©ì´ë‚˜ ì•„í‹°ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ë¶„ì„(ê·¸ë˜í”„) í™”ë©´ì´ ëœ¹ë‹ˆë‹¤. <br>
            ë³´ë¼ìƒ‰ ë±ƒì§€(Cross)ëŠ” 2ê°œ ì´ìƒì˜ ì°¨íŠ¸ì— ë™ì‹œì— ì§„ì…í•œ ê³¡ì…ë‹ˆë‹¤.
        </div>
        <div class="table-wrap"><table id="dailyTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="shorts-insight" class="tab-content">
        <h3>âš¡ ì‡¼ì¸  ìƒì„±ëŸ‰ ê¸°ë°˜ ì§„ì… ì „ëµ</h3>
        <div class="insight-box">
            <span class="insight-title">ğŸ“Š ë¶„ì„ ë¡œì§</span>
            ë‹¨ìˆœ ëˆ„ì  ê°œìˆ˜ê°€ ì•„ë‹ˆë¼, <strong>"ì–´ì œ ëŒ€ë¹„ ì˜¤ëŠ˜ ëª‡ ê°œì˜ ì‡¼ì¸ ê°€ ìƒˆë¡œ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€(Delta)"</strong>ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.<br>
            ê° ìˆœìœ„ êµ¬ê°„(Top 10, 20...)ì— ì§„ì…í•˜ë ¤ë©´ <strong>í•˜ë£¨ì— ìµœì†Œ ëª‡ ê°œì˜ ì‡¼ì¸ ê°€ ìƒì„±ë˜ì–´ì•¼ í•˜ëŠ”ì§€</strong> ë³´ì—¬ì¤ë‹ˆë‹¤.
        </div>
        <div class="controls">
             <label>ë¶„ì„ ê¸°ì¤€ì¼: <input type="date" id="shortsDate" onchange="renderShortsInsight()"></label>
        </div>
        <div class="table-wrap"><table id="shortsTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="cross-chart" class="tab-content">
        <h3>ğŸ”— ë©€í‹° ì°¨íŠ¸ ì ìœ  ì•„í‹°ìŠ¤íŠ¸ (Cross-Chart)</h3>
        <div class="insight-box">
            í•œêµ­/ë¯¸êµ­, í˜¹ì€ MV/ì‡¼ì¸ /ìŒì› ì°¨íŠ¸ì— <strong>ë™ì‹œ ì§„ì…í•œ ê°•ë ¥í•œ ìŒì›</strong>ë§Œ í•„í„°ë§í–ˆìŠµë‹ˆë‹¤.
        </div>
        <div class="table-wrap"><table id="crossTable"><thead></thead><tbody></tbody></table></div>
    </div>

    <div id="monthly" class="tab-content">
        <h3>ğŸ—“ï¸ ê¸°ê°„ë³„ í‰ê·  ì§„ì… ì»·</h3>
        <div class="table-wrap"><table id="aggTable"><thead></thead><tbody></tbody></table></div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">ë…¸ë˜ ì œëª©</h2>
        <p id="modalArtist">ì•„í‹°ìŠ¤íŠ¸</p>
        
        <div class="insight-box" id="modalInsight"></div>

        <div class="chart-grid">
            <div>
                <canvas id="viewChart"></canvas>
            </div>
            <div>
                <canvas id="rankChart"></canvas>
            </div>
        </div>
        
        <h3>ğŸ“‹ ì°¨íŠ¸ ì§„ì… ì´ë ¥</h3>
        <div class="table-wrap">
            <table id="historyTable">
                <thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸ëª…</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜(ì¡°íšŒìˆ˜/ê°œìˆ˜)</th><th>ë³€ë™</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ”´ ì—¬ê¸°ì— êµ¬ê¸€ ì‹œíŠ¸ CSV ë§í¬ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    // ============================================================

    let rawData = [];
    let processedData = []; // Delta ê³„ì‚°ëœ ë°ì´í„°

    // ì°¨íŠ¸ ê°ì²´ ì „ì—­ ë³€ìˆ˜
    let viewChartInst = null;
    let rankChartInst = null;

    // ì´ˆê¸° ì‹¤í–‰
    fetch(SHEET_CSV_URL)
        .then(res => res.text())
        .then(text => {
            rawData = parseCSV(text);
            calculateDeltas(); // ì „ì¼ ëŒ€ë¹„ ì¦ê° ê³„ì‚°
            
            document.getElementById("data-status").innerText = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ì´ ${rawData.length.toLocaleString()}í–‰`;
            
            // ë‚ ì§œ ì„¸íŒ…
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                
                renderDaily();
                renderShortsInsight();
                renderCrossChart();
                renderAggregated();
            }
        });

    // CSV íŒŒì‹±
    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
        const idx = { date: headers.indexOf("Date"), chart: headers.indexOf("Chart"), rank: headers.indexOf("Rank"), title: headers.indexOf("Title"), artist: headers.indexOf("Artist"), views: headers.indexOf("Views") };
        
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < headers.length) continue;
            
            let v = row[idx.views] ? row[idx.views].replace(/"/g, "").replace(/,/g, "") : "0";
            data.push({
                Date: row[idx.date].replace(/"/g, ""),
                Chart: row[idx.chart].replace(/"/g, ""),
                Rank: parseInt(row[idx.rank].replace(/"/g, "")),
                Title: row[idx.title].replace(/"/g, ""),
                Artist: row[idx.artist].replace(/"/g, ""),
                Views: parseInt(v) || 0,
                Delta: 0 // ì´ˆê¸°ê°’
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    // ì „ì¼ ëŒ€ë¹„ ì¦ê°(Delta) ê³„ì‚° ë¡œì§
    function calculateDeltas() {
        // ë¹ ë¥´ê³  ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ Map ì‚¬ìš© (Key: Date|Chart|Title)
        // ê°™ì€ ë…¸ë˜ë¼ë„ ë‚ ì§œë³„ë¡œ ì¶”ì 
        const map = {};
        rawData.forEach(d => {
            const key = `${d.Chart}|${d.Title}|${d.Artist}`;
            if(!map[key]) map[key] = [];
            map[key].push(d);
        });

        // ê° ê·¸ë£¹ë³„ë¡œ ë‚ ì§œìˆœ ì •ë ¬ í›„ ì°¨ì´ ê³„ì‚°
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=1; i<list.length; i++) {
                const today = list[i];
                const yesterday = list[i-1];
                // ë‚ ì§œ ì°¨ì´ê°€ 1ì¼ì¼ ë•Œë§Œ ê³„ì‚°
                const diffTime = new Date(today.Date) - new Date(yesterday.Date);
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                
                if(diffDays === 1) {
                    today.Delta = today.Views - yesterday.Views;
                }
            }
        });
    }

    // ================= 1. ë°ì¼ë¦¬ ë Œë”ë§ =================
    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const tbody = document.querySelector("#dailyTable tbody");
        const thead = document.querySelector("#dailyTable thead");
        thead.innerHTML = `<tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ìˆ˜ì¹˜ (Views/Shorts)</th><th>ì „ì¼ ëŒ€ë¹„</th></tr>`;
        
        const dayData = rawData.filter(d => d.Date === date);
        
        // í¬ë¡œìŠ¤ ì°¨íŠ¸ ë¶„ì„ (ê°™ì€ ë‚  ì—¬ëŸ¬ ì°¨íŠ¸ì— ìˆëŠ” ë…¸ë˜ ì°¾ê¸°)
        const songCounts = {};
        dayData.forEach(d => {
            const key = d.Title + d.Artist;
            songCounts[key] = (songCounts[key] || 0) + 1;
        });

        let html = "";
        dayData.forEach(d => {
            const isCross = songCounts[d.Title + d.Artist] > 1;
            const isShorts = d.Chart.includes("Shorts");
            const unit = isShorts ? "ê°œ" : "";
            
            // ë¸íƒ€ í‘œì‹œ
            let deltaStr = "-";
            if(d.Delta > 0) deltaStr = `<span class="rank-up">â–² ${d.Delta.toLocaleString()}</span>`;
            else if(d.Delta < 0) deltaStr = `<span class="rank-down">â–¼ ${Math.abs(d.Delta).toLocaleString()}</span>`;

            const crossBadge = isCross ? `<span class="cross-badge">Cross</span>` : "";

            html += `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')">
                <td>${d.Chart}</td>
                <td>${d.Rank}</td>
                <td class="highlight-song">${d.Title} ${crossBadge}</td>
                <td>${d.Artist}</td>
                <td>${d.Views.toLocaleString()}${unit}</td>
                <td>${deltaStr}</td>
            </tr>`;
        });
        tbody.innerHTML = html || `<tr><td colspan="6">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // ================= 2. ì‡¼ì¸  ìƒì„± ì „ëµ (New Feature) =================
    function renderShortsInsight() {
        const date = document.getElementById("shortsDate").value;
        const tbody = document.querySelector("#shortsTable tbody");
        const thead = document.querySelector("#shortsTable thead");
        thead.innerHTML = `<tr><th>êµ­ê°€/ì°¨íŠ¸</th><th>Rank 1~10 ì§„ì… í•„ìš” ìƒì„±ëŸ‰</th><th>Rank 11~20 ì§„ì… í•„ìš” ìƒì„±ëŸ‰</th><th>Rank 21~30 ì§„ì… í•„ìš” ìƒì„±ëŸ‰</th><th>50ìœ„ ì§„ì… ì»· (ì¼ê°„ ìƒì„±)</th></tr>`;

        const dayData = rawData.filter(d => d.Date === date && d.Chart.includes("Shorts"));
        const charts = [...new Set(dayData.map(d => d.Chart))];
        
        let html = "";
        charts.forEach(chart => {
            const cData = dayData.filter(d => d.Chart === chart);
            
            // ì¼ê°„ ìƒì„±ëŸ‰(Delta)ì˜ í‰ê· ì„ êµ¬í•¨ (ë‹¨, Deltaê°€ 0ë³´ë‹¤ í° ê²½ìš°ë§Œ ìœ íš¨í•œ ìƒì„±ìœ¼ë¡œ ê°„ì£¼)
            const calcAvgDelta = (s, e) => {
                const seg = cData.filter(d => d.Rank >= s && d.Rank <= e && d.Delta > 0);
                return seg.length ? Math.round(seg.reduce((a,b)=>a+b.Delta,0)/seg.length) : 0;
            };

            // ì»· ë¼ì¸ (50ìœ„)ì˜ ì¼ê°„ ìƒì„±ëŸ‰
            const cutItem = cData.find(d => d.Rank === 50) || cData[cData.length-1];
            const cutDelta = cutItem && cutItem.Delta > 0 ? cutItem.Delta : 0;

            html += `<tr>
                <td style="font-weight:bold">${chart}</td>
                <td style="color:red; font-weight:bold">í•˜ë£¨ +${calcAvgDelta(1,10).toLocaleString()}ê°œ</td>
                <td style="color:blue">í•˜ë£¨ +${calcAvgDelta(11,20).toLocaleString()}ê°œ</td>
                <td>í•˜ë£¨ +${calcAvgDelta(21,30).toLocaleString()}ê°œ</td>
                <td>í•˜ë£¨ +${cutDelta.toLocaleString()}ê°œ</td>
            </tr>`;
        });

        tbody.innerHTML = html || `<tr><td colspan="5">ì‡¼ì¸  ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¸íƒ€ ê³„ì‚° ë¶ˆê°€ (ìµœì†Œ 2ì¼ì¹˜ ë°ì´í„° í•„ìš”)</td></tr>`;
    }

    // ================= 3. í¬ë¡œìŠ¤ ì°¨íŠ¸ ë¶„ì„ =================
    function renderCrossChart() {
        const tbody = document.querySelector("#crossTable tbody");
        const thead = document.querySelector("#crossTable thead");
        thead.innerHTML = `<tr><th>ì•„í‹°ìŠ¤íŠ¸ - ë…¸ë˜</th><th>ì§„ì… ì°¨íŠ¸ ê°œìˆ˜</th><th>ì†í•œ ì°¨íŠ¸ ëª©ë¡</th><th>ìµœê³  ìˆœìœ„</th></tr>`;

        // ìµœê·¼ ë‚ ì§œ ê¸°ì¤€
        const lastDate = rawData[rawData.length-1].Date;
        const dayData = rawData.filter(d => d.Date === lastDate);

        const map = {};
        dayData.forEach(d => {
            const key = `${d.Artist} - ${d.Title}`;
            if(!map[key]) map[key] = { charts: [], minRank: 101 };
            map[key].charts.push(d.Chart);
            if(d.Rank < map[key].minRank) map[key].minRank = d.Rank;
        });

        // 2ê°œ ì´ìƒ ì°¨íŠ¸ì— ìˆëŠ” ê²½ìš°ë§Œ í•„í„°ë§
        const crosses = Object.entries(map).filter(([k, v]) => v.charts.length > 1);
        crosses.sort((a,b) => b[1].charts.length - a[1].charts.length); // ì°¨íŠ¸ ê°œìˆ˜ ë§ì€ ìˆœ

        let html = "";
        crosses.forEach(([key, val]) => {
            html += `<tr onclick="openDetail('${key.split(" - ")[1].replace(/'/g, "\\'")}', '${key.split(" - ")[0].replace(/'/g, "\\'")}')">
                <td class="highlight-song">${key}</td>
                <td style="font-weight:bold; color:purple">${val.charts.length}ê°œ</td>
                <td>${val.charts.join(", ")}</td>
                <td>${val.minRank}ìœ„</td>
            </tr>`;
        });
        tbody.innerHTML = html || `<tr><td colspan="4">í¬ë¡œìŠ¤ ì°¨íŠ¸ ì§„ì… ê³¡ ì—†ìŒ</td></tr>`;
    }

    // ================= 4. ì›”ê°„/ì—°ê°„ ì§‘ê³„ =================
    function renderAggregated() {
        const tbody = document.querySelector("#aggTable tbody");
        const thead = document.querySelector("#aggTable thead");
        thead.innerHTML = `<tr><th>ê¸°ê°„ (ì›”)</th><th>ì°¨íŠ¸</th><th>Top 10 í‰ê· ìˆ˜ì¹˜</th><th>ì§„ì… ì»· í‰ê· </th></tr>`;
        
        // ì›”ë³„ ì§‘ê³„
        const stats = {};
        rawData.forEach(d => {
            const key = d.Date.substring(0, 7) + "|" + d.Chart; // YYYY-MM
            if(!stats[key]) stats[key] = { sum10:0, cnt10:0, sumCut:0, cntCut:0 };
            
            if(d.Rank <= 10) { stats[key].sum10 += d.Views; stats[key].cnt10++; }
            // ì§„ì…ì»· (ì‡¼ì¸  50ìœ„, íŠ¸ë Œë”© 20ìœ„, ë‚˜ë¨¸ì§€ 100ìœ„)
            let cut = 100;
            if(d.Chart.includes("Shorts")) cut = 50;
            if(d.Chart.includes("Trending")) cut = 20;
            
            if(d.Rank >= cut-1 && d.Rank <= cut) {
                 stats[key].sumCut += d.Views; stats[key].cntCut++;
            }
        });

        let html = "";
        Object.keys(stats).sort().reverse().forEach(key => {
            const [month, chart] = key.split("|");
            const s = stats[key];
            const avg10 = s.cnt10 ? Math.round(s.sum10/s.cnt10) : 0;
            const avgCut = s.cntCut ? Math.round(s.sumCut/s.cntCut) : 0;
            
            html += `<tr><td>${month}</td><td>${chart}</td><td>${avg10.toLocaleString()}</td><td style="color:blue">${avgCut.toLocaleString()}</td></tr>`;
        });
        tbody.innerHTML = html;
    }

    // ================= 5. ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ (Chart.js) =================
    function openDetail(title, artist) {
        const modal = document.getElementById("detailModal");
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalArtist").innerText = artist;
        
        // í•´ë‹¹ ë…¸ë˜ì˜ ëª¨ë“  ì´ë ¥ í•„í„°ë§
        const history = rawData.filter(d => d.Title === title && d.Artist === artist);
        
        // ì¸ì‚¬ì´íŠ¸ ìƒì„±
        const chartsIn = [...new Set(history.map(d => d.Chart))];
        const firstDate = history[0].Date;
        const lastDate = history[history.length-1].Date;
        const maxViews = Math.max(...history.map(d => d.Views));
        const bestRank = Math.min(...history.map(d => d.Rank));
        
        document.getElementById("modalInsight").innerHTML = `
            <strong>ğŸ“Š ë¶„ì„ ìš”ì•½</strong><br>
            â€¢ í™œë™ ê¸°ê°„: ${firstDate} ~ ${lastDate}<br>
            â€¢ ì§„ì… ì°¨íŠ¸: ${chartsIn.join(", ")} (${chartsIn.length}ê°œ)<br>
            â€¢ ìµœê³  ìˆœìœ„: <strong>${bestRank}ìœ„</strong> / ìµœê³  ìˆ˜ì¹˜: <strong>${maxViews.toLocaleString()}</strong>
        `;

        // í…Œì´ë¸” ë Œë”ë§
        const tbody = document.querySelector("#historyTable tbody");
        let html = "";
        // ìµœì‹ ìˆœ ì •ë ¬
        const sortedHist = [...history].sort((a,b) => new Date(b.Date) - new Date(a.Date));
        sortedHist.forEach(d => {
            html += `<tr>
                <td>${d.Date}</td>
                <td>${d.Chart}</td>
                <td>${d.Rank}</td>
                <td>${d.Views.toLocaleString()}</td>
                <td>${d.Delta > 0 ? '+' + d.Delta.toLocaleString() : d.Delta}</td>
            </tr>`;
        });
        tbody.innerHTML = html;

        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (Chart.js)
        drawCharts(history);
        
        modal.style.display = "block";
    }

    function drawCharts(data) {
        // ë‚ ì§œë³„ë¡œ ë°ì´í„° ì •ë¦¬ (ì°¨íŠ¸ê°€ ì—¬ëŸ¬ ê°œë©´ ë³µì¡í•´ì§€ë¯€ë¡œ, ê°€ì¥ ìµœê·¼ ì°¨íŠ¸ í˜¹ì€ ë©”ì¸ ì°¨íŠ¸ í•˜ë‚˜ ê¸°ì¤€)
        // ì—¬ê¸°ì„œëŠ” ì°¨íŠ¸ë³„ë¡œ ìƒ‰ê¹”ì„ ë‹¤ë¥´ê²Œ í•´ì„œ ë³´ì—¬ì¤Œ
        const ctxView = document.getElementById('viewChart').getContext('2d');
        const ctxRank = document.getElementById('rankChart').getContext('2d');
        
        if(viewChartInst) viewChartInst.destroy();
        if(rankChartInst) rankChartInst.destroy();

        // ë°ì´í„° ê°€ê³µ: ë‚ ì§œë³„ xì¶•, ì°¨íŠ¸ë³„ yì¶• ë°ì´í„°ì…‹
        const dates = [...new Set(data.map(d => d.Date))].sort();
        const charts = [...new Set(data.map(d => d.Chart))];
        
        const datasetsView = [];
        const datasetsRank = [];
        
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];

        charts.forEach((chart, idx) => {
            const chartData = data.filter(d => d.Chart === chart);
            const dataMap = {};
            chartData.forEach(d => dataMap[d.Date] = d);
            
            const views = dates.map(date => dataMap[date] ? dataMap[date].Views : null);
            const ranks = dates.map(date => dataMap[date] ? dataMap[date].Rank : null);
            
            const color = colors[idx % colors.length];

            datasetsView.push({ label: chart, data: views, borderColor: color, fill: false, tension: 0.1 });
            datasetsRank.push({ label: chart, data: ranks, borderColor: color, fill: false, tension: 0.1 });
        });

        viewChartInst = new Chart(ctxView, {
            type: 'line',
            data: { labels: dates, datasets: datasetsView },
            options: { responsive: true, plugins: { title: { display: true, text: 'ğŸ“ˆ ì¼ê°„ ìˆ˜ì¹˜(ì¡°íšŒìˆ˜/ê°œìˆ˜) ì¶”ì´' } } }
        });

        rankChartInst = new Chart(ctxRank, {
            type: 'line',
            data: { labels: dates, datasets: datasetsRank },
            options: { 
                responsive: true, 
                scales: { y: { reverse: true } }, // ìˆœìœ„ëŠ” ë‚®ì„ìˆ˜ë¡ ì¢‹ìœ¼ë¯€ë¡œ ë’¤ì§‘ê¸°
                plugins: { title: { display: true, text: 'ğŸ† ìˆœìœ„ ë³€ë™ ì¶”ì´ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)' } } 
            }
        });
    }

    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById("detailModal")) closeModal(); }
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
