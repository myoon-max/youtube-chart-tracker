<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Insight Analytics (Final Strategy)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #E62117; --secondary: #0F0F0F; --bg: #F4F5F7; --white: #ffffff; --gray: #606060; --green: #2ba640; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--secondary); }
        .container { max-width: 1800px; margin: 0 auto; padding-bottom: 50px; }
        h1 { text-align: center; margin-bottom: 30px; font-weight: 900; }
        
        /* ì¹´ë“œ & ìš”ì•½ */
        .card { background: var(--white); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 24px; margin-bottom: 24px; border: 1px solid #e9ecef; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-item { border-left: 5px solid var(--primary); padding-left: 20px; display: flex; flex-direction: column; justify-content: center; }
        .stat-item.money { border-left-color: var(--green); }
        .stat-label { font-size: 0.9rem; color: var(--gray); font-weight: 600; margin-bottom: 5px; }
        .stat-value { font-size: 1.6rem; font-weight: 800; color: var(--secondary); }
        .stat-sub { font-size: 0.8rem; color: #999; margin-top: 4px; }

        /* íƒ­ */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; border: none; background: #e9ecef; cursor: pointer; border-radius: 50px; font-weight: 700; color: var(--gray); transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(230, 33, 23, 0.3); transform: translateY(-2px); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* ì»¨íŠ¸ë¡¤ */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        input, select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ced4da; font-size: 14px; }
        
        /* ê¸°ê°„ í† ê¸€ ë²„íŠ¼ */
        .period-toggle { display: inline-flex; background: #eee; border-radius: 20px; padding: 4px; margin-left: auto; }
        .period-btn { border: none; background: transparent; padding: 8px 16px; border-radius: 16px; cursor: pointer; font-weight: 600; font-size: 13px; color: #666; transition: 0.2s; }
        .period-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ (í—¤ë” ê³ ì •) */
        .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th { background-color: #212529 !important; color: #ffffff !important; padding: 14px; text-align: center; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; vertical-align: middle; }
        tr:hover { background-color: #f1f3f5; cursor: pointer; }
        
        .rank-up { color: #E62117; font-weight: bold; background: #fff5f5; padding: 2px 6px; border-radius: 4px; }
        .rank-down { color: #0056b3; font-weight: bold; background: #e7f1ff; padding: 2px 6px; border-radius: 4px; }
        .money-text { color: var(--green); font-weight: 800; }
        .highlight-cut { background: #fff3cd; font-weight: bold; border-left: 2px solid #ffecb3; }
        .entry-row { background-color: #fff0f0; font-weight: bold; border-top: 2px solid #E62117; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 2vh auto; width: 95%; max-width: 1200px; height: 92vh; display: flex; flex-direction: column; padding: 20px; border-radius: 16px; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-body { overflow-y: auto; flex: 1; }
        .close-btn { font-size: 30px; cursor: pointer; font-weight: bold; }
        
        /* ëª¨ë‹¬ ë‚´ë¶€ í—¤ë” ê°•ì œ ì ìš© */
        #detailModal th { background-color: #212529 !important; color: #ffffff !important; }

        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ MusicDeal Insight Analytics</h1>
    
    <div class="summary-grid">
        <div class="card stat-item money"><span class="stat-label">ğŸ’° ì˜ˆìƒ ì¼ê°„ ì‹œì¥ ê·œëª¨</span><div class="stat-value" id="total-revenue">-</div><div class="stat-sub">Top 100 í•©ê³„</div></div>
        <div class="card stat-item"><span class="stat-label">ğŸ‡°ğŸ‡· KR MV Top 100 ì»·</span><div class="stat-value" id="kr-mv-cut">-</div><div class="stat-sub">ì˜¤ëŠ˜ ì§„ì… ìµœì†Œ ì¡°íšŒìˆ˜</div></div>
        <div class="card stat-item"><span class="stat-label">ğŸ‡ºğŸ‡¸ US MV Top 100 ì»·</span><div class="stat-value" id="us-mv-cut">-</div><div class="stat-sub">ì˜¤ëŠ˜ ì§„ì… ìµœì†Œ ì¡°íšŒìˆ˜</div></div>
        <div class="card stat-item"><span class="stat-label">ğŸ“… ë°ì´í„° ê¸°ì¤€ì¼</span><div class="stat-value" id="current-date">-</div><div class="stat-sub" id="data-count">-</div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily', this)">ğŸ“… ë°ì¼ë¦¬ & ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">âš¡ ì‡¼ì¸  ë°”ì´ëŸ´ ì „ëµ</button>
        <button class="tab-btn" onclick="openTab('trend', this)">ğŸ“ˆ ì›”ê°„/ì—°ê°„ ì¶”ì´</button>
        <button class="tab-btn" onclick="openTab('cross', this)">ğŸ”— í¬ë¡œìŠ¤ ì°¨íŠ¸</button>
        <button class="tab-btn" onclick="openTab('long-run', this)">ğŸƒ ë¡±ëŸ°(ì¢€ë¹„) ì§€ìˆ˜</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="card">
            <div class="controls">
                <label>ğŸ“… ë‚ ì§œ: <input type="date" id="dailyDate" onchange="renderDaily()"></label>
                <label>ğŸ³ï¸ êµ­ê°€: <select id="countryFilter" onchange="updateChartFilter()"><option value="ALL">ì „ì²´</option><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></label>
                <label>ğŸ“Š ì°¨íŠ¸: <select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´</option></select></label>
            </div>
            <div class="table-container">
                <table id="dailyTable">
                    <thead><tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¡°íšŒìˆ˜/ê°œìˆ˜</th><th>ì „ì¼ ëŒ€ë¹„</th><th>ì˜ˆìƒ ìˆ˜ìµ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div style="background:#f8f9fa; padding:15px; font-size:0.9em; color:#666; border-radius:8px;">
            <strong>ğŸ’° ìˆ˜ìµ ì‚°ì¶œ ê¸°ì¤€ (2025ë…„ ì‹œì¥ í‰ê· ):</strong><br>
            â€¢ ì•„íŠ¸íŠ¸ë™(Songs): ğŸ‡°ğŸ‡· 5ì›/íšŒ, ğŸ‡ºğŸ‡¸ 10ì›/íšŒ (ìŠ¤íŠ¸ë¦¬ë° ë¡œì—´í‹°)<br>
            â€¢ MV ë¡±í¼: ğŸ‡°ğŸ‡· 2.5ì›/íšŒ, ğŸ‡ºğŸ‡¸ 4ì›/íšŒ (ê´‘ê³  RPM)
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="card">
            <div class="controls">
                <label>ğŸ“… ê¸°ì¤€ì¼: <input type="date" id="shortsDate" onchange="renderShortsStrategy()"></label>
                <label>ğŸ“Š ì°¨íŠ¸: <select id="shortsChartSelect" onchange="renderShortsStrategy()"><option value="KR_Daily_Top_Shorts">ğŸ‡°ğŸ‡· í•œêµ­ ì‡¼ì¸ </option><option value="US_Daily_Top_Shorts">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì‡¼ì¸ </option></select></label>
                
                <div class="period-toggle">
                    <button class="period-btn active" onclick="setShortsPeriod(1, this)">ì¼ê°„</button>
                    <button class="period-btn" onclick="setShortsPeriod(7, this)">ì£¼ê°„(í‰ê· )</button>
                    <button class="period-btn" onclick="setShortsPeriod(30, this)">ì›”ê°„(í‰ê· )</button>
                </div>
            </div>
            
            <div id="shortsKPI" style="padding:15px; background:#fff3cd; border-radius:8px; margin-bottom:20px;"></div>
            
            <div style="margin-bottom:30px;">
                <h3>ğŸ“Š êµ¬ê°„ë³„ ëª©í‘œ ìƒì„±ëŸ‰ (KPI)</h3>
                <div class="table-container">
                    <table id="shortsTable">
                        <thead><tr><th>êµ¬ê°„</th><th>í‰ê·  ëˆ„ì  ê°œìˆ˜</th><th>í‰ê·  ìƒì„± ì†ë„</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="insight-grid">
                <div class="card" style="margin:0; height:450px;">
                    <h4 style="margin-top:0">ğŸ”¥ Viral Map (ì‚°ì ë„)</h4>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="card" style="margin:0; height:450px; overflow-y:auto;">
                    <h4 style="margin-top:0">ğŸ”¥ ê¸‰ìƒìŠ¹ ë£¨í‚¤ (í™”ë ¥ Top)</h4>
                    <table id="rookieTable">
                        <thead><tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>ì†ë„</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card" style="margin-top:20px; height:350px;">
                <h4 style="margin-top:0">ğŸ—“ï¸ ìš”ì¼ë³„ í™”ë ¥ íŒ¨í„´</h4>
                <div style="height:250px;"><canvas id="dayChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="trend" class="tab-content">
        <div class="card">
            <h3>ğŸ“ˆ êµ¬ê°„ë³„ ì§„ì… í•„ìš” ìˆ˜ì¹˜ (ëˆ„ì  í‰ê· )</h3>
            <div class="table-container">
                <table id="trendTable">
                    <thead><tr><th>ê¸°ê°„</th><th>ì°¨íŠ¸</th><th>1~10ìœ„</th><th>11~30ìœ„</th><th>31~50ìœ„</th><th>51~70ìœ„</th><th>71~100ìœ„</th><th class="highlight-cut">ì§„ì… ì»·</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cross" class="tab-content">
        <div class="card">
            <h3>ğŸ”— ë©€í‹° ì°¨íŠ¸ ì§„ì… ì•„í‹°ìŠ¤íŠ¸</h3>
            <div class="table-container">
                <table id="crossTable">
                    <thead><tr><th>ì•„í‹°ìŠ¤íŠ¸ - ë…¸ë˜</th><th>ì§„ì… ì°¨íŠ¸ ìˆ˜</th><th>ì°¨íŠ¸ ëª©ë¡</th><th>ìµœê³  ìˆœìœ„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="long-run" class="tab-content">
        <div class="card">
            <div style="margin-bottom:15px; font-size:0.9em; color:#666;">
                <strong>ğŸ§Ÿ ë¡±ëŸ° ì§€ìˆ˜ë€?</strong> ì°¨íŠ¸ì—ì„œ ì˜¤ë«ë™ì•ˆ ìƒì¡´í•˜ë©° ê¾¸ì¤€í•œ ì„±ê³¼ë¥¼ ë‚´ëŠ” ê³¡ (ê³„ì‚°ì‹: ì²´ë¥˜ì¼ Ã— 1000 Ã· í‰ê·  ìˆœìœ„)
            </div>
            <div class="table-container">
                <table id="zombieTable">
                    <thead><tr><th>ê³¡ëª…</th><th>ì²´ë¥˜ì¼</th><th>í‰ê· ìˆœìœ„</th><th>ë¡±ëŸ°ì ìˆ˜</th><th>ìƒíƒœ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div><h2 id="modalTitle" style="margin:0">Title</h2><p id="modalArtist" style="margin:0; color:#666">Artist</p></div>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                <div class="card" style="margin:0; border-left:5px solid var(--green); text-align:center;">
                    <span class="stat-label">ğŸ’° ì¶”ì • ëˆ„ì  ìˆ˜ìµ</span><span class="stat-value" id="mRevenue" style="color:var(--green)">-</span>
                </div>
                <div class="card" style="margin:0; text-align:center;">
                    <span class="stat-label">ğŸ† ìµœê³  ìˆœìœ„</span><span class="stat-value" id="mBestRank">-</span>
                </div>
                <div class="card" style="margin:0; text-align:center;">
                    <span class="stat-label">ğŸ”¥ ìµœê³  ìˆ˜ì¹˜</span><span class="stat-value" id="mPeakView">-</span>
                </div>
            </div>
            <div class="insight-grid">
                <div class="card" style="margin:0; height:350px;"><canvas id="viewChart"></canvas></div>
                <div class="card" style="margin:0; height:350px;"><canvas id="rankChart"></canvas></div>
            </div>
            <div class="card" style="margin-top:20px;">
                <h3>ğŸ“‹ ìƒì„¸ ì´ë ¥</h3>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜</th><th>ì¦ê°</th><th>ìˆ˜ìµ</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };
    let rawData = [], uniqueCharts = [];
    let scatterChartInst=null, dayChartInst=null, vChart=null, rChart=null;
    let shortsPeriod = 1; // 1=ì¼ê°„, 7=ì£¼ê°„, 30=ì›”ê°„

    try {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                updateSummary(lastDate);
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                
                // ì´ˆê¸° ë Œë”ë§
                renderDaily(); renderTrend(); renderCross(); renderShortsStrategy(); renderLongRun();
            }
        });
    } catch(e) { console.error(e); }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            let vStr = getCol(6).replace(/,/g, "");
            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: getCol(3), Artist: getCol(4), Views: parseInt(vStr) || 0, Delta: 0, Revenue: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        const map = {};
        rawData.forEach(d => {
            let rate = 0;
            const isKR = d.Chart.includes("KR"), isSong = d.Chart.includes("Songs"), isShorts = d.Chart.includes("Shorts");
            if(!isShorts) {
                if(isKR) rate = isSong ? RATES.KR.song : RATES.KR.mv; else rate = isSong ? RATES.US.song : RATES.US.mv;
                d.Revenue = Math.round(d.Views * rate);
            }
            const key = `${d.Chart}|${d.Title}|${d.Artist}`;
            if(!map[key]) map[key] = []; map[key].push(d);
        });
        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=1; i<list.length; i++) {
                const diff = (new Date(list[i].Date) - new Date(list[i-1].Date))/(1000*3600*24);
                if(diff === 1) list[i].Delta = list[i].Views - list[i-1].Views;
            }
        });
    }

    function updateSummary(date) {
        document.getElementById("current-date").innerText = date;
        document.getElementById("data-count").innerText = rawData.length.toLocaleString();
        const todayData = rawData.filter(d => d.Date === date);
        const totalRev = todayData.reduce((sum, d) => sum + d.Revenue, 0);
        document.getElementById("total-revenue").innerText = "â‚©" + totalRev.toLocaleString();
        const getCut = (chart) => {
            const cutRank = chart.includes("Trending") ? 20 : (chart.includes("Shorts") ? 50 : 100);
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === cutRank);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    function openTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // [1] ë°ì¼ë¦¬
    function updateChartFilter() {
        const country = document.getElementById("countryFilter").value;
        const chartSelect = document.getElementById("chartFilter");
        chartSelect.innerHTML = '<option value="ALL">ì „ì²´ ì°¨íŠ¸</option>';
        uniqueCharts.forEach(chart => {
            if(country === "ALL" || chart.startsWith(country)) {
                const opt = document.createElement("option"); opt.value = chart; opt.innerText = chart; chartSelect.appendChild(opt);
            }
        });
        renderDaily();
    }
    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const tbody = document.querySelector("#dailyTable tbody");
        let data = rawData.filter(d => d.Date === date);
        if(country !== "ALL") data = data.filter(d => d.Chart.startsWith(country));
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);
        tbody.innerHTML = data.map(d => {
            let delta = d.Delta > 0 ? `<span class="rank-up">â–²${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">â–¼${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            let revStr = d.Revenue > 0 ? `â‚©${d.Revenue.toLocaleString()}` : "-";
            return `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')"><td>${d.Chart}</td><td>${d.Rank}</td><td class="song-title">${d.Title}</td><td>${d.Artist}</td><td style="font-weight:bold">${d.Views.toLocaleString()}</td><td>${delta}</td><td class="money-text">${revStr}</td></tr>`;
        }).join("") || `<tr><td colspan="7" style="text-align:center; padding:20px;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // [2] ì‡¼ì¸  (ê¸°ê°„ í‰ê·  ê¸°ëŠ¥ íƒ‘ì¬)
    function setShortsPeriod(days, btn) {
        shortsPeriod = days;
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderShortsStrategy();
    }

    function renderShortsStrategy() {
        const date = document.getElementById("shortsDate").value;
        const chartName = document.getElementById("shortsChartSelect").value;
        const data = rawData.filter(d => d.Date === date && d.Chart === chartName);
        if(data.length === 0) { document.getElementById("shortsKPI").innerHTML = "ë°ì´í„° ì—†ìŒ"; return; }

        // ê¸°ê°„ ë¼ë²¨
        let pLabel = "ì¼ê°„ ìƒì„±";
        if(shortsPeriod === 7) pLabel = "ì£¼ê°„ í‰ê·  ìƒì„±(ì¼)";
        if(shortsPeriod === 30) pLabel = "ì›”ê°„ í‰ê·  ìƒì„±(ì¼)";

        // ê¸°ê°„ë³„ í‰ê·  ì†ë„ ê³„ì‚° ë¡œì§
        const calcPeriodAvg = (items) => {
            if(!items || items.length === 0) return 0;
            // itemsëŠ” ì˜¤ëŠ˜ì ë°ì´í„°. ê° ì•„ì´í…œì˜ ê³¼ê±° ê¸°ë¡ì„ ì¡°íšŒí•´ì•¼ í•¨.
            // ê°„ë‹¨í•˜ê²Œ: ì˜¤ëŠ˜ì DeltaëŠ” 'ì–´ì œ ëŒ€ë¹„'ì´ë¯€ë¡œ, ì§„ì •í•œ 7ì¼ í‰ê· ì„ ë‚´ë ¤ë©´ ê³¼ê±° 7ì¼ì¹˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ì•¼ í•¨.
            // Client-side ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´, ì—¬ê¸°ì„œëŠ” [ì˜¤ëŠ˜ì˜ Delta]ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê¸°ê°„ ì¶”ì •ì¹˜(Projection)ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
            // 'ê³¼ê±° Nì¼ê°„ì˜ Delta í‰ê· 'ì„ ê³„ì‚°í•˜ëŠ” ê²ƒì´ ë§ìŒ.
            
            let totalDelta = 0;
            let count = 0;
            
            // ì˜¤ëŠ˜ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê³¡ë“¤ì˜ ê³¼ê±° Nì¼ì¹˜ Delta í‰ê· 
            const targetDate = new Date(date);
            const startDate = new Date(targetDate);
            startDate.setDate(targetDate.getDate() - shortsPeriod + 1); // ì˜¤ëŠ˜ í¬í•¨ Nì¼
            
            items.forEach(item => {
                const hist = rawData.filter(d => d.Title === item.Title && d.Artist === item.Artist && new Date(d.Date) >= startDate && new Date(d.Date) <= targetDate);
                const validDeltas = hist.filter(h => h.Delta > 0);
                if(validDeltas.length > 0) {
                    const avg = validDeltas.reduce((a,b)=>a+b.Delta,0) / validDeltas.length;
                    totalDelta += avg;
                    count++;
                }
            });
            
            return count > 0 ? Math.round(totalDelta / count) : 0;
        };

        // KPI ê³„ì‚°
        const top10Items = data.filter(d => d.Rank <= 10);
        const avgSpeed = calcPeriodAvg(top10Items);
        
        const cutItem = data.find(d => d.Rank === 50);
        const cutSpeed = cutItem ? calcPeriodAvg([cutItem]) : 0;

        document.getElementById("shortsKPI").innerHTML = `<strong>ğŸ’¡ ${pLabel} Insight:</strong> Top 10 í‰ê· ì†ë„ <span style="color:red">+${avgSpeed.toLocaleString()}ê°œ/ì¼</span> | 50ìœ„ ë°©ì–´ì„  <span style="color:blue">+${cutSpeed.toLocaleString()}ê°œ/ì¼</span>`;

        if(scatterChartInst) scatterChartInst.destroy();
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const points = data.filter(d => d.Delta > 0).map(d => ({ x: d.Views, y: d.Delta, title: d.Title, rank: d.Rank }));
        scatterChartInst = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'ê³¡ ë¶„í¬', data: points, backgroundColor: p=>p.raw.rank<=10?'#E62117':(p.raw.rank<=50?'#36A2EB':'#adb5bd') }] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: {type:'logarithmic', title:{display:true, text:'ëˆ„ì '}}, y: {title:{display:true, text:'ì¼ê°„ ìƒì„±'}} }, plugins: { tooltip: { callbacks: { label: c => `${c.raw.rank}ìœ„: ${c.raw.title}` } } } } });

        // ë£¨í‚¤ (ì¼ê°„ ê¸°ì¤€ ìœ ì§€)
        const avgD = data.reduce((a,b)=>a+(b.Delta>0?b.Delta:0),0) / data.length;
        const rookies = data.filter(d => d.Rank > 20 && d.Delta > avgD).sort((a,b) => b.Delta - a.Delta);
        document.querySelector("#rookieTable tbody").innerHTML = rookies.slice(0, 10).map(d => `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')"><td>${d.Rank}</td><td>${d.Title}</td><td style="color:red">+${d.Delta.toLocaleString()}</td></tr>`).join("");

        // ë©”ì¸ í…Œì´ë¸”
        const tbody = document.querySelector("#shortsTable tbody");
        let html = "";
        for(let i=0; i<5; i++) {
            const s = i*10+1; const e = (i+1)*10;
            const seg = data.filter(d => d.Rank >= s && d.Rank <= e);
            const avgT = seg.length ? Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length) : 0;
            
            // êµ¬ê°„ë³„ ê¸°ê°„ í‰ê·  ì†ë„
            const periodAvgSpeed = calcPeriodAvg(seg);
            
            html += `<tr><td>${s}~${e}ìœ„</td><td>${avgT.toLocaleString()}</td><td style="color:red; font-weight:bold">+${periodAvgSpeed.toLocaleString()} / ì¼</td></tr>`;
        }
        
        // ğŸ 50ìœ„ ì§„ì… ì»· ì¶”ê°€
        if(cutItem) {
            const cutTotal = cutItem.Views.toLocaleString();
            const cutVelo = calcPeriodAvg([cutItem]).toLocaleString();
            html += `<tr class="entry-row"><td style="color:#E62117">ğŸ 50ìœ„ ì§„ì… ì»· (Entry Level)</td><td style="font-weight:bold">${cutTotal} (ëˆ„ì )</td><td style="color:#E62117; font-weight:bold">+${cutVelo} / ì¼</td></tr>`;
        }

        tbody.innerHTML = html;

        const dayStats = [0,0,0,0,0,0,0], dayCnt = [0,0,0,0,0,0,0];
        rawData.filter(d => d.Chart === chartName && d.Delta > 0).forEach(d => {
            const day = new Date(d.Date).getDay();
            dayStats[day]+=d.Delta; dayCnt[day]++;
        });
        const dayAvgs = dayStats.map((s,i) => dayCnt[i] ? Math.round(s/dayCnt[i]) : 0);
        if(dayChartInst) dayChartInst.destroy();
        const dayCtx = document.getElementById('dayChart').getContext('2d');
        dayChartInst = new Chart(dayCtx, { type: 'bar', data: { labels:['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '], datasets:[{ label:'í‰ê·  ìƒì„±ëŸ‰', data:dayAvgs, backgroundColor:'rgba(230,33,23,0.6)' }] }, options:{responsive:true, maintainAspectRatio:false} });
    }

    // [3] íŠ¸ë Œë“œ
    function renderTrend() {
        const tbody = document.querySelector("#trendTable tbody");
        const stats = {};
        rawData.forEach(d => {
            const key = d.Date.substring(0, 7) + "|" + d.Chart;
            if(!stats[key]) stats[key] = { s:[0,0,0,0,0,0], c:[0,0,0,0,0,0], sumCut:0, cntCut:0 };
            const s = stats[key];
            // 1~10, 11~30, 31~50, 51~70, 71~100
            if(d.Rank<=10) { s.s[0]+=d.Views; s.c[0]++; }
            else if(d.Rank<=30) { s.s[1]+=d.Views; s.c[1]++; }
            else if(d.Rank<=50) { s.s[2]+=d.Views; s.c[2]++; }
            else if(d.Rank<=70) { s.s[3]+=d.Views; s.c[3]++; }
            else if(d.Rank<=100) { s.s[4]+=d.Views; s.c[4]++; }
            
            const cutRank = d.Chart.includes("Trending")?20:(d.Chart.includes("Shorts")?50:100);
            if(d.Rank===cutRank) { s.sumCut+=d.Views; s.cntCut++; }
        });
        tbody.innerHTML = Object.keys(stats).sort().reverse().map(k => {
            const [m, c] = k.split("|"); const s = stats[k];
            let cols = ""; 
            cols += `<td>${s.c[0]?Math.round(s.s[0]/s.c[0]).toLocaleString():"-"}</td>`;
            cols += `<td>${s.c[1]?Math.round(s.s[1]/s.c[1]).toLocaleString():"-"}</td>`;
            cols += `<td>${s.c[2]?Math.round(s.s[2]/s.c[2]).toLocaleString():"-"}</td>`;
            cols += `<td>${s.c[3]?Math.round(s.s[3]/s.c[3]).toLocaleString():"-"}</td>`;
            cols += `<td>${s.c[4]?Math.round(s.s[4]/s.c[4]).toLocaleString():"-"}</td>`;
            const cut = s.cntCut ? Math.round(s.sumCut/s.cntCut).toLocaleString() : "-";
            return `<tr><td>${m}</td><td style="text-align:left">${c}</td>${cols}<td class="highlight-cut">${cut}</td></tr>`;
        }).join("");
    }

    // [4] í¬ë¡œìŠ¤
    function renderCross() {
        const tbody = document.querySelector("#crossTable tbody");
        const lastDate = rawData[rawData.length-1].Date;
        const data = rawData.filter(d => d.Date === lastDate);
        const map = {};
        data.forEach(d => {
            const k = `${d.Artist} - ${d.Title}`; if(!map[k]) map[k] = { charts: [], minRank: 999 }; map[k].charts.push(d.Chart); if(d.Rank < map[k].minRank) map[k].minRank = d.Rank;
        });
        const crosses = Object.entries(map).filter(([k,v]) => v.charts.length > 1).sort((a,b) => b[1].charts.length - a[1].charts.length);
        tbody.innerHTML = crosses.map(([k, v]) => `<tr onclick="openDetail('${k.split(" - ")[1].replace(/'/g, "\\'")}', '${k.split(" - ")[0].replace(/'/g, "\\'")}')"><td class="song-title">${k}</td><td style="font-weight:bold; color:#6f42c1">${v.charts.length}ê°œ</td><td>${v.charts.join(", ")}</td><td>${v.minRank}ìœ„</td></tr>`).join("");
    }

    // [5] ë¡±ëŸ°
    function renderLongRun() {
        const map = {}; rawData.forEach(d => { const k=`${d.Chart}|${d.Title}|${d.Artist}`; if(!map[k]) map[k]={c:0, r:0}; map[k].c++; map[k].r+=d.Rank; });
        const zombies = Object.entries(map).map(([k,v]) => { const [c,t,a]=k.split("|"); const ar=Math.round(v.r/v.c); const s=Math.round(v.c*1000/ar); return {chart:c, title:t, artist:a, days:v.c, ar, s}; }).sort((a,b)=>b.s-a.s).slice(0,20);
        document.querySelector("#zombieTable tbody").innerHTML = zombies.map(z => `<tr onclick="openDetail('${z.title.replace(/'/g, "\\'")}', '${z.artist.replace(/'/g, "\\'")}')"><td>[${z.chart.split('_')[0]}] ${z.title}</td><td>${z.days}ì¼</td><td>${z.ar}ìœ„</td><td style="color:#2ba640; font-weight:bold">${z.s}</td><td>${z.s>=2000?'ğŸ‘‘ God':(z.s>=1000?'ğŸ§Ÿ Zombie':'ğŸŒ± Rookie')}</td></tr>`).join("");
    }

    function openDetail(title, artist) {
        document.getElementById("detailModal").style.display = "block";
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalArtist").innerText = artist;
        const hist = rawData.filter(d => d.Title === title && d.Artist === artist).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        
        const bestRank = Math.min(...hist.map(d=>d.Rank));
        const peakView = Math.max(...hist.map(d=>d.Views));
        const totalRev = hist.reduce((sum, d) => sum + d.Revenue, 0);

        document.getElementById("mBestRank").innerText = bestRank + "ìœ„";
        document.getElementById("mPeakView").innerText = peakView.toLocaleString();
        document.getElementById("mRevenue").innerText = "â‚©" + totalRev.toLocaleString();

        if(vChart) vChart.destroy(); if(rChart) rChart.destroy();
        const dates = [...new Set(hist.map(d=>d.Date))].sort();
        const charts = [...new Set(hist.map(d=>d.Chart))];
        const colors = ['#E62117', '#36A2EB', '#FFCE56', '#2ba640'];
        const mkDs = (key) => charts.map((c,i) => ({ label: c, data: dates.map(dt => { const item=hist.find(h=>h.Date===dt&&h.Chart===c); return item?item[key]:null; }), borderColor:colors[i%4], fill:false }));
        vChart = new Chart(document.getElementById('viewChart'), { type:'line', data:{labels:dates, datasets:mkDs('Views')}, options:{responsive:true, maintainAspectRatio:false} });
        rChart = new Chart(document.getElementById('rankChart'), { type:'line', data:{labels:dates, datasets:mkDs('Rank')}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{reverse:true}}} });

        document.querySelector("#historyTable tbody").innerHTML = hist.map(d => 
            `<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${d.Views.toLocaleString()}</td><td>${d.Delta>0?'+'+d.Delta:d.Delta}</td><td style="color:var(--green)">â‚©${d.Revenue.toLocaleString()}</td></tr>`).join("");
    }
    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
</script>
</body>
</html>
