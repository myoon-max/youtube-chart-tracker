<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Analytics | Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --primary: #FF3B30; /* Neon Red */
            --primary-glow: rgba(255, 59, 48, 0.6);
            --accent: #32D74B; /* Neon Green */
            --border: #333;
            --chart-grid: #2a2a2a;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
        }
        
        .container { max-width: 1920px; margin: 0 auto; padding-bottom: 100px; }
        h1 { text-align: center; margin-bottom: 40px; font-weight: 900; font-size: 2.2rem; letter-spacing: -1px; text-transform: uppercase; }
        
        /* --- ë¡œê·¸ì¸ --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { width: 400px; padding: 40px; background: #111; border: 1px solid #333; border-radius: 20px; text-align: center; box-shadow: 0 0 40px rgba(255, 59, 48, 0.1); }
        .login-input { width: 100%; padding: 15px; margin-top: 20px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; text-align: center; }
        .login-btn { width: 100%; padding: 15px; margin-top: 15px; background: var(--primary); border: none; color: #fff; font-weight: bold; border-radius: 10px; cursor: pointer; }

        /* --- ë©”ì¸ UI --- */
        #app-content { display: none; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .kpi-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 25px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .kpi-card:hover { border-color: #555; transform: translateY(-3px); transition: 0.3s; }
        .kpi-label { color: var(--text-sub); font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2.2rem; font-weight: 800; color: #fff; }
        .kpi-value.money { color: var(--accent); text-shadow: 0 0 10px rgba(50, 215, 75, 0.3); }
        .kpi-sub { font-size: 0.8rem; color: #666; margin-top: 8px; }

        /* íƒ­ */
        .tabs { display: flex; justify-content: center; gap: 12px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 28px; border: 1px solid #333; background: #111; color: #888; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        /* ì»¨íŠ¸ë¡¤ & ë°•ìŠ¤ */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 25px; margin-bottom: 25px; }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background: #0a0a0a; border-radius: 12px; border: 1px solid #333; }
        .control-group label { color: #aaa; margin-right: 8px; font-weight: bold; font-size: 0.9rem; }
        input, select { background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; }
        
        /* í…Œì´ë¸” */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th { background: #222; color: #fff; padding: 15px; text-align: center; font-weight: 700; border-bottom: 2px solid #444; position: sticky; top: 0; }
        td { padding: 14px; border-bottom: 1px solid #222; text-align: center; color: #ddd; }
        tr:hover { background: #1f1f1f; cursor: pointer; }
        
        /* ë°ì´í„° ì»¬ëŸ¬ë§ */
        .rank-up { color: var(--primary); font-weight: bold; }
        .rank-down { color: #0A84FF; font-weight: bold; }
        .money-text { color: var(--accent); font-family: 'Montserrat'; font-weight: 700; }
        .highlight-cut { background: rgba(255, 59, 48, 0.1); border-left: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
        .sum-row { background: #1a2e1a !important; font-weight: 900; color: #fff; border-bottom: 2px solid var(--accent); }

        /* ëª¨ë‹¬ (ìƒì„¸ë³´ê¸°) */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { 
            background: #161616; margin: 2vh auto; width: 95%; max-width: 1400px; height: 94vh; 
            border: 1px solid #333; border-radius: 20px; display: flex; flex-direction: column; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-header { padding: 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-title h2 { margin: 0; font-size: 1.8rem; color: #fff; }
        .modal-title p { margin: 5px 0 0 0; color: #888; }
        .close-btn { font-size: 32px; color: #666; cursor: pointer; } .close-btn:hover { color: #fff; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }

        /* ê·¸ë˜í”„ ì˜ì—­ */
        .chart-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: #0a0a0a; border: 1px solid #333; border-radius: 12px; padding: 20px; height: 400px; display: flex; flex-direction: column; }
        .chart-header { font-weight: bold; color: #fff; margin-bottom: 15px; font-size: 1.1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* í‘¸í„° ì •ë³´ */
        .footer-info { background: #111; padding: 20px; border-radius: 12px; margin-top: 40px; border: 1px solid #333; font-size: 0.9rem; color: #888; }
        .price-badge { display: inline-block; background: #000; border: 1px solid #444; padding: 4px 10px; border-radius: 4px; margin-right: 10px; color: #ccc; }
        .price-badge span { color: var(--accent); font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div class="login-title">MusicDeal <span>Admin</span></div>
        <p style="color:#666; margin-bottom:30px;">Authorized Access Only</p>
        <input type="password" id="passwordInput" class="login-input" placeholder="Password" onkeyup="if(window.event.keyCode==13){checkLogin()}">
        <button class="login-btn" onclick="checkLogin()">ENTER</button>
        <p id="login-msg" style="color:var(--primary); margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="app-content">
    <header>
        <div class="brand">MUSICDEAL <span>ANALYTICS</span></div>
        <div class="date-badge">DATA DATE: <span id="header-date" style="color:#fff; font-weight:bold">-</span></div>
    </header>

    <div class="summary-grid">
        <div class="kpi-card">
            <span class="kpi-label">ğŸ’° Total Daily Market Revenue</span>
            <div class="kpi-value money" id="total-revenue">-</div>
            <div class="kpi-sub">KR+US Top 100 ì§„ì… ê³¡ ì¼ê°„ ì´ë§¤ì¶œ</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR MV Entry Cut</span>
            <div class="kpi-value" id="kr-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì Top 100 ì§„ì… ìµœì†Œ ì¡°íšŒìˆ˜</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US MV Entry Cut</span>
            <div class="kpi-value" id="us-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì Top 100 ì§„ì… ìµœì†Œ ì¡°íšŒìˆ˜</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily', this)">ğŸ“… ë°ì¼ë¦¬ & ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="openTab('trend', this)">ğŸ“ˆ ì›”ê°„/ì—°ê°„ ì¶”ì´</button>
        <button class="tab-btn" onclick="openTab('cross', this)">ğŸ”— í¬ë¡œìŠ¤ ì°¨íŠ¸</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">âš¡ ì‡¼ì¸  ë°”ì´ëŸ´ ì „ëµ</button>
        <button class="tab-btn" onclick="openTab('long-run', this)">ğŸ§Ÿ ë¡±ëŸ°(ì¢€ë¹„) ì§€ìˆ˜</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ë‚ ì§œ</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
                <div class="control-group"><label>êµ­ê°€</label><select id="countryFilter" onchange="updateChartFilter()"><option value="ALL">ì „ì²´ (Global)</option><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option></select></div>
                <div class="control-group"><label>ì°¨íŠ¸</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´ ì°¨íŠ¸</option></select></div>
                <div style="margin-left:auto;"><input type="text" id="dailySearch" placeholder="ê³¡ëª…/ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." onkeyup="renderDaily()" style="width:250px;"></div>
            </div>
            <div class="table-container">
                <table id="dailyTable">
                    <thead><tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¡°íšŒìˆ˜/ê°œìˆ˜</th><th>ì „ì¼ ëŒ€ë¹„ (Delta)</th><th>ì˜ˆìƒ ìˆ˜ìµ (ì¼ê°„)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="trend" class="tab-content">
        <div class="card">
            <h3 style="color:#fff; margin-bottom:20px;">ğŸ“ˆ ì°¨íŠ¸ë³„ ì§„ì… ì¥ë²½ (ê¸°ê°„ë³„ ëˆ„ì  í‰ê· )</h3>
            <div class="table-container">
                <table id="trendTable">
                    <thead><tr><th>ê¸°ê°„</th><th>ì°¨íŠ¸</th><th>1~10ìœ„</th><th>11~20ìœ„</th><th>21~30ìœ„</th><th>31~40ìœ„</th><th>41~50ìœ„</th><th class="highlight-cut">ì§„ì… ì»· (100ìœ„)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cross" class="tab-content">
        <div class="card">
            <div class="controls">
                <h3 style="margin:0; color:#fff;">ğŸ”— ë©€í‹° ì°¨íŠ¸ ì§„ì… ì•„í‹°ìŠ¤íŠ¸</h3>
                <div style="margin-left:auto;"><input type="text" id="crossSearch" placeholder="ê²€ìƒ‰..." onkeyup="renderCross()" style="width:250px;"></div>
            </div>
            <div class="table-container">
                <table id="crossTable">
                    <thead><tr><th>ì•„í‹°ìŠ¤íŠ¸ - ë…¸ë˜</th><th>ì§„ì… ì°¨íŠ¸ ìˆ˜</th><th>í¬í•¨ëœ ì°¨íŠ¸ ëª©ë¡</th><th>ìµœê³  ìˆœìœ„</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ê¸°ì¤€ì¼</label><input type="date" id="shortsDate" onchange="renderShortsStrategy()"></div>
                <div class="control-group"><label>ëŒ€ìƒ ì°¨íŠ¸</label><select id="shortsChartSelect" onchange="renderShortsStrategy()"><option value="KR_Daily_Top_Shorts">ğŸ‡°ğŸ‡· í•œêµ­ ì‡¼ì¸ </option><option value="US_Daily_Top_Shorts">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì‡¼ì¸ </option></select></div>
            </div>
            <div id="shortsKPI" style="padding:20px; background:#1a1a1a; border:1px solid var(--primary); border-radius:12px; margin-bottom:20px; color:#fff;"></div>
            
            <div style="margin-bottom:30px;">
                <h3 style="color:#fff; margin-bottom:15px;">ğŸ“Š êµ¬ê°„ë³„ ëª©í‘œ ìƒì„±ëŸ‰ (KPI)</h3>
                <div class="table-container"><table id="shortsTable"><thead></thead><tbody></tbody></table></div>
            </div>

            <div class="chart-section">
                <div class="chart-box">
                    <div class="chart-header">ğŸ”¥ Viral Map (ì‚°ì ë„)</div>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-box" style="height:auto; min-height:400px;">
                    <div class="chart-header">ğŸš€ ê¸‰ìƒìŠ¹ ë£¨í‚¤ (í™”ë ¥ Top)</div>
                    <div class="table-container" style="border:none;">
                        <table id="rookieTable"><thead><tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>ì†ë„(ì¼ê°„)</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="long-run" class="tab-content">
        <div class="card">
            <h3 style="color:#fff; margin-bottom:10px;">ğŸ§Ÿ ì¢€ë¹„ ì§€ìˆ˜ (Long-Run Power)</h3>
            <p style="color:#666; margin-bottom:20px;">* ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ì°¨íŠ¸ì—ì„œ ì˜¤ë˜ ì‚´ì•„ë‚¨ëŠ” 'ì—°ê¸ˆ ê³¡'ì…ë‹ˆë‹¤. (ê³„ì‚°: ì²´ë¥˜ì¼ Ã— 1000 Ã· í‰ê· ìˆœìœ„)</p>
            <div class="table-container">
                <table id="zombieTable"><thead><tr><th>ê³¡ëª…</th><th>ì²´ë¥˜ì¼</th><th>í‰ê· ìˆœìœ„</th><th>ë¡±ëŸ°ì ìˆ˜</th><th>ìƒíƒœ</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div class="footer-info">
        <h4 style="color:#fff; margin-bottom:15px;">ğŸ’° Revenue Calculation Logic (2025 Estimates)</h4>
        <div>
            <div class="price-badge">ğŸ‡°ğŸ‡· KR Songs: <span>â‚©5</span></div>
            <div class="price-badge">ğŸ‡°ğŸ‡· KR MV: <span>â‚©2.5</span></div>
            <div class="price-badge">ğŸ‡ºğŸ‡¸ US Songs: <span>â‚©10</span></div>
            <div class="price-badge">ğŸ‡ºğŸ‡¸ US MV: <span>â‚©4</span></div>
        </div>
        <p style="margin-top:10px;">* (ì£¼ì˜) ì‡¼ì¸ (Shorts)ëŠ” ìˆ˜ìµ ë³€ë™ì„±ì´ ì»¤ì„œ ë§¤ì¶œ ê³„ì‚°ì—ì„œ ì œì™¸í•˜ê³  í™”ë ¥ ì§€í‘œë¡œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        <p>* ë³¸ ë°ì´í„°ëŠ” ì¤‘ë³µ ê³„ì‚°ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ <strong>'ì¼ê°„ ì¦ê°€ëŸ‰(Delta)'</strong> ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ìµì„ ì‚°ì¶œí•©ë‹ˆë‹¤.</p>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h2 id="modalTitle">Title</h2>
                <p id="modalArtist">Artist</p>
            </div>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="chart-section">
                <div class="chart-box">
                    <div class="chart-header">ğŸ“Š ì¡°íšŒìˆ˜ / ì‡¼ì¸  ê°œìˆ˜ ì¶”ì´</div>
                    <canvas id="viewChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-header">ğŸ† ìˆœìœ„ ë³€ë™ ì¶”ì´ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)</div>
                    <canvas id="rankChart"></canvas>
                </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:#fff; margin:0;">ğŸ“‹ ìƒì„¸ ì´ë ¥ (Daily History)</h3>
                <select id="modalChartFilter" onchange="filterHistory()" style="width:200px; padding:8px;">
                    <option value="ALL">ì „ì²´ ì°¨íŠ¸ ë³´ê¸°</option>
                </select>
            </div>

            <div class="table-container">
                <table id="historyTable">
                    <thead>
                        <tr style="background:#222; color:#fff;">
                            <th>ë‚ ì§œ</th>
                            <th>ì°¨íŠ¸</th>
                            <th>ìˆœìœ„</th>
                            <th>ìˆ˜ì¹˜(Views)</th>
                            <th>ì¦ê°(Delta)</th>
                            <th>ì¶”ì • ìˆ˜ìµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ” ë¹„ë°€ë²ˆí˜¸ & CSV ë§í¬
    const ACCESS_KEY = "musicdeal2025"; 
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";

    // ğŸ’° ë‹¨ê°€
    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };

    let rawData = [], uniqueCharts = [];
    let currentDetailData = []; // ëª¨ë‹¬ìš© ë°ì´í„°

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let scatterChartInst=null, vChart=null, rChart=null;

    // ë¡œê·¸ì¸
    function checkLogin() {
        if(document.getElementById('passwordInput').value === ACCESS_KEY) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            setTimeout(()=>document.getElementById('app-content').style.opacity='1', 100);
            loadData();
            localStorage.setItem('md_auth', 'true');
        } else {
            document.getElementById('login-msg').innerText = "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
        }
    }
    if(localStorage.getItem('md_auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('app-content').style.opacity = '1';
        loadData();
    }

    function loadData() {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                document.getElementById("header-date").innerText = lastDate;
                updateSummary(lastDate);
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                
                renderDaily(); renderTrend(); renderCross(); renderShortsStrategy(); renderLongRun();
            }
        });
    }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            let vStr = getCol(6).replace(/,/g, "");
            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: getCol(3), Artist: getCol(4), Views: parseInt(vStr) || 0, Delta: 0, Revenue: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        const map = {};
        rawData.forEach(d => {
            const key = `${d.Chart}|${d.Title}|${d.Artist}`;
            if(!map[key]) map[key] = [];
            map[key].push(d);
        });

        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            
            // ì²« ë°ì´í„° ì²˜ë¦¬ (ì‹ ê·œ ì§„ì…)
            let rate = getRate(list[0].Chart);
            list[0].Revenue = Math.round(list[0].Views * rate); // ì²«ë‚ ì€ ì „ì²´ ë·°ë¥¼ ë§¤ì¶œë¡œ (ë˜ëŠ” 0ìœ¼ë¡œ ì •ì±… ê²°ì • ê°€ëŠ¥)
            
            for(let i=1; i<list.length; i++) {
                const diff = (new Date(list[i].Date) - new Date(list[i-1].Date))/(1000*3600*24);
                // 1ì¼ ì°¨ì´ë‚  ë•Œë§Œ Delta ê³„ì‚°
                if(diff === 1) {
                    list[i].Delta = list[i].Views - list[i-1].Views;
                }
                // ë§¤ì¶œì€ Delta(ì¦ê°€ë¶„)ì— ëŒ€í•´ì„œë§Œ ê³„ì‚° (ì¤‘ë³µ ë°©ì§€ í•µì‹¬!)
                rate = getRate(list[i].Chart);
                if(list[i].Delta > 0) {
                    list[i].Revenue = Math.round(list[i].Delta * rate);
                } else {
                    list[i].Revenue = 0; // ì¦ê°€ ì—†ìœ¼ë©´ ë§¤ì¶œ 0
                }
            }
        });
    }

    function getRate(chart) {
        if(chart.includes("Shorts")) return 0; // ì‡¼ì¸  ì œì™¸
        const isKR = chart.includes("KR");
        const isSong = chart.includes("Songs");
        if(isKR) return isSong ? RATES.KR.song : RATES.KR.mv;
        return isSong ? RATES.US.song : RATES.US.mv;
    }

    function updateSummary(date) {
        const todayData = rawData.filter(d => d.Date === date);
        const totalRev = todayData.reduce((sum, d) => sum + d.Revenue, 0);
        document.getElementById("total-revenue").innerText = "â‚©" + totalRev.toLocaleString();
        
        const getCut = (chart) => {
            const cutRank = chart.includes("Trending") ? 20 : (chart.includes("Shorts") ? 50 : 100);
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === cutRank);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    // --- íƒ­ ---
    function openTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // 1. ë°ì¼ë¦¬
    function updateChartFilter() {
        const country = document.getElementById("countryFilter").value;
        const chartSelect = document.getElementById("chartFilter");
        chartSelect.innerHTML = '<option value="ALL">ì „ì²´ ì°¨íŠ¸</option>';
        uniqueCharts.forEach(chart => {
            if(country === "ALL" || chart.startsWith(country)) {
                const opt = document.createElement("option"); opt.value = chart; opt.innerText = chart; chartSelect.appendChild(opt);
            }
        });
        renderDaily();
    }
    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const search = document.getElementById("dailySearch").value.toLowerCase();
        const tbody = document.querySelector("#dailyTable tbody");
        
        let data = rawData.filter(d => d.Date === date);
        if(country !== "ALL") data = data.filter(d => d.Chart.startsWith(country));
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);
        if(search) data = data.filter(d => d.Title.toLowerCase().includes(search) || d.Artist.toLowerCase().includes(search));

        tbody.innerHTML = data.map(d => {
            let delta = d.Delta > 0 ? `<span class="rank-up">â–²${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">â–¼${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            let revStr = d.Revenue > 0 ? `â‚©${d.Revenue.toLocaleString()}` : "-";
            return `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')">
                <td>${d.Chart}</td><td>${d.Rank}</td><td class="song-title">${d.Title}</td><td>${d.Artist}</td>
                <td style="font-weight:bold">${d.Views.toLocaleString()}</td><td>${delta}</td><td class="money-text">${revStr}</td></tr>`;
        }).join("") || `<tr><td colspan="7" style="text-align:center; padding:20px; color:#666;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // 2. íŠ¸ë Œë“œ
    function renderTrend() {
        const tbody = document.querySelector("#trendTable tbody");
        const stats = {};
        rawData.forEach(d => {
            const key = d.Date.substring(0, 7) + "|" + d.Chart;
            if(!stats[key]) stats[key] = { s:[0,0,0,0,0,0], c:[0,0,0,0,0,0], sumCut:0, cntCut:0 };
            const s = stats[key];
            let idx = -1;
            if(d.Rank<=10) idx=0; else if(d.Rank<=20) idx=1; else if(d.Rank<=30) idx=2; else if(d.Rank<=40) idx=3; else if(d.Rank<=50) idx=4; else if(d.Rank<=100) idx=5;
            if(idx>=0) { s.s[idx]+=d.Views; s.c[idx]++; }
            const cutRank = d.Chart.includes("Trending")?20:(d.Chart.includes("Shorts")?50:100);
            if(d.Rank===cutRank) { s.sumCut+=d.Views; s.cntCut++; }
        });
        tbody.innerHTML = Object.keys(stats).sort().reverse().map(k => {
            const [m, c] = k.split("|"); const s = stats[k];
            let cols = ""; 
            for(let i=0; i<6; i++) cols += `<td>${s.c[i]?Math.round(s.s[i]/s.c[i]).toLocaleString():"-"}</td>`;
            const cut = s.cntCut ? Math.round(s.sumCut/s.cntCut).toLocaleString() : "-";
            return `<tr><td>${m}</td><td style="text-align:left">${c}</td>${cols}<td class="highlight-cut">${cut}</td></tr>`;
        }).join("");
    }

    // 3. í¬ë¡œìŠ¤
    function renderCross() {
        const tbody = document.querySelector("#crossTable tbody");
        const search = document.getElementById("crossSearch").value.toLowerCase();
        const lastDate = rawData[rawData.length-1].Date;
        const data = rawData.filter(d => d.Date === lastDate);
        const map = {};
        data.forEach(d => {
            const k = `${d.Artist} - ${d.Title}`; 
            if(!map[k]) map[k] = { charts: [], minRank: 999 }; 
            map[k].charts.push(d.Chart); 
            if(d.Rank < map[k].minRank) map[k].minRank = d.Rank;
        });
        const crosses = Object.entries(map).filter(([k,v]) => v.charts.length > 1).sort((a,b) => b[1].charts.length - a[1].charts.length);
        
        let html = crosses.filter(([k]) => k.toLowerCase().includes(search)).map(([k, v]) => 
            `<tr onclick="openDetail('${k.split(" - ")[1].replace(/'/g, "\\'")}', '${k.split(" - ")[0].replace(/'/g, "\\'")}')">
                <td class="song-title">${k}</td><td style="font-weight:bold; color:var(--primary)">${v.charts.length}ê°œ</td><td>${v.charts.join(", ")}</td><td>${v.minRank}ìœ„</td></tr>`
        ).join("");
        tbody.innerHTML = html || `<tr><td colspan="4" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // 4. ì‡¼ì¸ 
    function renderShortsStrategy() {
        const date = document.getElementById("shortsDate").value;
        const chartName = document.getElementById("shortsChartSelect").value;
        const data = rawData.filter(d => d.Date === date && d.Chart === chartName);
        if(data.length === 0) { document.getElementById("shortsKPI").innerHTML = "ë°ì´í„° ì—†ìŒ"; return; }

        const top10 = data.filter(d => d.Rank <= 10 && d.Delta > 0);
        const avgSpeed = top10.length ? Math.round(top10.reduce((a,b)=>a+b.Delta,0)/top10.length) : 0;
        const cutItem = data.find(d => d.Rank === 50);
        const cutSpeed = cutItem && cutItem.Delta > 0 ? cutItem.Delta : "?";
        document.getElementById("shortsKPI").innerHTML = `<strong>ğŸ’¡ Insight:</strong> Top 10 í‰ê· í™”ë ¥ <span style="color:var(--primary)">+${avgSpeed.toLocaleString()}/ì¼</span> | 50ìœ„ ë°©ì–´ì„  <span style="color:#0a84ff">+${cutSpeed.toLocaleString()}/ì¼</span>`;

        if(scatterChartInst) scatterChartInst.destroy();
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const points = data.filter(d => d.Delta > 0).map(d => ({ x: d.Views, y: d.Delta, title: d.Title, rank: d.Rank }));
        scatterChartInst = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Songs', data: points, backgroundColor: p=>p.raw.rank<=10?'#FF3B30':(p.raw.rank<=50?'#32D74B':'#666') }] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: {type:'logarithmic', title:{display:true, text:'ëˆ„ì '}}, y: {title:{display:true, text:'ì¼ê°„ ìƒì„±'}} }, plugins: { tooltip: { callbacks: { label: c => `${c.raw.rank}ìœ„. ${c.raw.title}` } } } } });

        const avgD = data.reduce((a,b)=>a+(b.Delta>0?b.Delta:0),0) / data.length;
        const rookies = data.filter(d => d.Rank > 20 && d.Delta > avgD).sort((a,b) => b.Delta - a.Delta);
        document.querySelector("#rookieTable tbody").innerHTML = rookies.slice(0, 10).map(d => `<tr onclick="openDetail('${d.Title.replace(/'/g, "\\'")}', '${d.Artist.replace(/'/g, "\\'")}')"><td>${d.Rank}</td><td style="color:#fff">${d.Title}</td><td style="color:var(--primary)">+${d.Delta.toLocaleString()}</td></tr>`).join("");

        const tbody = document.querySelector("#shortsTable tbody");
        let html = "";
        for(let i=0; i<5; i++) {
            const s = i*10+1; const e = (i+1)*10;
            const seg = data.filter(d => d.Rank >= s && d.Rank <= e);
            const avgT = seg.length ? Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length) : 0;
            const dSeg = seg.filter(d => d.Delta > 0);
            const avgD = dSeg.length ? Math.round(dSeg.reduce((a,b)=>a+b.Delta,0)/dSeg.length) : 0;
            html += `<tr><td>${s}~${e}ìœ„</td><td>${avgT.toLocaleString()}</td><td style="color:var(--primary); font-weight:bold">+${avgD.toLocaleString()}</td></tr>`;
        }
        tbody.innerHTML = html;
    }

    // 5. ë¡±ëŸ°
    function renderLongRun() {
        const map = {}; rawData.forEach(d => { const k=`${d.Chart}|${d.Title}|${d.Artist}`; if(!map[k]) map[k]={c:0, r:0}; map[k].c++; map[k].r+=d.Rank; });
        const zombies = Object.entries(map).map(([k,v]) => { const [c,t,a]=k.split("|"); const ar=Math.round(v.r/v.c); const s=Math.round(v.c*1000/ar); return {chart:c, title:t, artist:a, days:v.c, ar, s}; }).sort((a,b)=>b.s-a.s).slice(0,20);
        document.querySelector("#zombieTable tbody").innerHTML = zombies.map(z => `<tr onclick="openDetail('${z.title.replace(/'/g, "\\'")}', '${z.artist.replace(/'/g, "\\'")}')"><td style="color:#fff">${z.title}</td><td>${z.days}ì¼</td><td>${z.ar}ìœ„</td><td style="color:var(--accent); font-weight:bold">${z.s}</td><td>${z.s>=2000?'ğŸ‘‘ God':(z.s>=1000?'ğŸ§Ÿ Zombie':'ğŸŒ± Rookie')}</td></tr>`).join("");
    }

    // ========== ìƒì„¸ ëª¨ë‹¬ & í•„í„° & í•©ê³„ ==========
    function openDetail(title, artist) {
        document.getElementById("detailModal").style.display = "block";
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalArtist").innerText = artist;
        
        // 1. ë°ì´í„° í•„í„°ë§
        currentDetailData = rawData.filter(d => d.Title === title && d.Artist === artist).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        
        // 2. ì°¨íŠ¸ ëª©ë¡ ë“œë¡­ë°•ìŠ¤ ì±„ìš°ê¸°
        const charts = [...new Set(currentDetailData.map(d => d.Chart))].sort();
        const filterSel = document.getElementById("modalChartFilter");
        filterSel.innerHTML = '<option value="ALL">ì „ì²´ ì°¨íŠ¸ ë³´ê¸°</option>';
        charts.forEach(c => {
            const opt = document.createElement("option"); opt.value = c; opt.innerText = c; filterSel.appendChild(opt);
        });

        // 3. ìµœì´ˆ ë Œë”ë§ (ì „ì²´)
        filterHistory();
        
        // 4. ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì „ì²´ ë°ì´í„° ê¸°ì¤€)
        const dates = [...new Set(currentDetailData.map(d=>d.Date))].sort();
        const datasetsV = charts.map((c,i) => ({ label: c, data: dates.map(dt => { const item=currentDetailData.find(h=>h.Date===dt&&h.Chart===c); return item?item.Views:null; }), borderColor:getCol(i), fill:false }));
        const datasetsR = charts.map((c,i) => ({ label: c, data: dates.map(dt => { const item=currentDetailData.find(h=>h.Date===dt&&h.Chart===c); return item?item.Rank:null; }), borderColor:getCol(i), fill:false }));
        
        if(vChart) vChart.destroy(); if(rChart) rChart.destroy();
        vChart = new Chart(document.getElementById('viewChart'), { type:'line', data:{labels:dates, datasets:datasetsV}, options:{responsive:true, maintainAspectRatio:false} });
        rChart = new Chart(document.getElementById('rankChart'), { type:'line', data:{labels:dates, datasets:datasetsR}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{reverse:true}}} });
    }

    function getCol(i) { const cols=['#FF3B30','#32D74B','#0A84FF','#FFD60A','#BF5AF2']; return cols[i%cols.length]; }

    function filterHistory() {
        const filterVal = document.getElementById("modalChartFilter").value;
        const tbody = document.querySelector("#historyTable tbody");
        
        let data = currentDetailData;
        if(filterVal !== "ALL") data = data.filter(d => d.Chart === filterVal);
        
        // í•©ê³„ ê³„ì‚° (ì¤‘ë³µ ì œê±° - Delta í•©ì‚°)
        // ì£¼ì˜: í•„í„°ëœ ë°ì´í„° ë‚´ì—ì„œì˜ í•©ê³„
        const sumDelta = data.reduce((acc, d) => acc + (d.Delta > 0 ? d.Delta : 0), 0);
        const sumRev = data.reduce((acc, d) => acc + d.Revenue, 0);

        // 1. í•©ê³„ í–‰ (ê³ ì •)
        let html = `
            <tr class="sum-row">
                <td colspan="3">âˆ‘ í•©ê³„ (Total)</td>
                <td>ìˆœì¦ê°€: +${sumDelta.toLocaleString()}</td>
                <td>-</td>
                <td style="color:var(--accent)">â‚©${sumRev.toLocaleString()}</td>
            </tr>
        `;

        // 2. ë°ì´í„° í–‰
        html += data.map(d => 
            `<tr>
                <td>${d.Date}</td>
                <td>${d.Chart}</td>
                <td>${d.Rank}</td>
                <td>${d.Views.toLocaleString()}</td>
                <td style="color:${d.Delta>0?'var(--primary)':'inherit'}">${d.Delta>0?'+':''}${d.Delta.toLocaleString()}</td>
                <td style="color:var(--accent)">â‚©${d.Revenue.toLocaleString()}</td>
            </tr>`
        ).join("");
        
        tbody.innerHTML = html;
    }

    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
</script>
</body>
</html>
