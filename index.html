<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicDeal Analytics (All-in-One)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <style>
        :root {
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-main: #1A1A1A;
            --text-sub: #5F6368;
            --primary: #E62117; /* YouTube Red */
            --blue: #1A73E8;
            --green: #1E8E3E; /* Melon Green feel */
            --border: #E0E0E0;
            --shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            min-height: 100vh;
        }
        
        .container { max-width: 1800px; margin: 0 auto; padding: 80px 20px 100px; }

        header { 
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 60px; border-bottom: 1px solid #eee; padding-bottom: 40px; position: relative;
        }
        h1 { 
            margin: 0 0 15px 0; font-weight: 900; font-size: 3rem; 
            letter-spacing: -1px; color: var(--text-main); text-transform: uppercase; 
        }
        h1 span { color: var(--primary); }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .date-badge { 
            display: inline-block; background: #fff; padding: 8px 20px; 
            border-radius: 30px; border: 1px solid var(--border); 
            color: var(--text-sub); font-weight: 600; font-size: 0.95rem;
            box-shadow: var(--shadow);
        }

        .toggle-wrapper {
            display: flex; align-items: center; background: #fff; border: 1px solid var(--border);
            padding: 5px 10px 5px 5px; border-radius: 30px; box-shadow: var(--shadow); cursor: pointer;
        }
        .toggle-wrapper label { font-size: 0.9rem; font-weight: 700; color: #333; margin-left: 8px; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; text-align: center; background: #f9f9f9; }
        .login-btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #app-content { display: none; opacity: 0; transition: opacity 0.5s; }

        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; transition: all 0.3s; }
        .summary-grid.no-revenue { grid-template-columns: repeat(2, 1fr); }

        .kpi-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-label { font-size: 0.85rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .kpi-value { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .kpi-value.money { color: var(--green); }
        .kpi-sub { font-size: 0.8rem; color: #888; margin-top: 5px; }

        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 50px; }
        .tab-btn { padding: 12px 28px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 30px; cursor: pointer; font-weight: 700; font-size: 1rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn.active { background: #333; color: #fff; border-color: #333; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        .card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); padding: 30px; margin-bottom: 30px; border: 1px solid var(--border); }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .control-group label { font-weight: bold; font-size: 0.9rem; margin-right: 8px; color: #333; }
        input, select { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; background: #fff; color: #333; }
        
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; white-space: nowrap; }
        th { background: #F8F9FA; color: #333; padding: 16px; text-align: center; font-weight: 800; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 10; }
        td { padding: 14px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        tr:hover { background-color: #f1f3f5; cursor: pointer; }

        .rank-up { color: #D32F2F; font-weight: bold; background: #FFEBEE; padding: 2px 6px; border-radius: 4px; }
        .rank-down { color: #1976D2; font-weight: bold; background: #E3F2FD; padding: 2px 6px; border-radius: 4px; }
        .money-text { color: var(--green); font-weight: 800; font-family: 'Montserrat'; }
        .sum-row { background: #333 !important; color: #fff !important; font-weight: bold; }

        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: #fff; margin: 2vh auto; width: 90%; max-width: 1300px; height: 92vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 25px 35px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 20px 20px 0 0; }
        .modal-title h2 { margin: 0; font-size: 1.8rem; color: #000; }
        .close-btn { font-size: 36px; color: #aaa; cursor: pointer; } .close-btn:hover { color: #000; }
        .modal-body { padding: 35px; overflow-y: auto; flex: 1; background: #FAFAFA; }
        #detailModal th { background-color: #333 !important; color: #fff !important; }

        .yt-btn { background: #FF0000; color: #fff; padding: 8px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(255,0,0,0.2); transition: background 0.2s; }
        .yt-btn:hover { background: #cc0000; }

        .info-icon { display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; background: #ddd; color: #fff; font-size: 12px; font-weight: bold; margin-left: 6px; cursor: help; position: relative; }
        .info-icon:hover::after { content: attr(data-tooltip); position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 10px 14px; border-radius: 6px; font-size: 0.8rem; white-space: pre-line; width: 320px; z-index: 100; font-weight: normal; line-height: 1.5; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-box { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 20px; height: 400px; display: flex; flex-direction: column; box-shadow: var(--shadow); }
        .chart-header { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; color: #333; border-left: 4px solid var(--primary); padding-left: 12px; }

        .search-wrapper { position: relative; margin-left: auto; width: 300px; }
        .search-wrapper input { width: 100%; padding-left: 40px; border-radius: 20px; border: 1px solid #ddd; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        .footer-info { text-align: center; color: #888; margin-top: 40px; font-size: 0.85rem; padding-top: 20px; border-top: 1px solid #ddd; }
        .price-tag { display: inline-block; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; margin: 0 5px; font-weight: 600; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 class="login-title" style="color:#000; margin-bottom:10px;">MUSICDEAL <span style="color:var(--primary)">ADMIN</span></h2>
        <input type="password" id="passwordInput" class="login-input" placeholder="Access Key" onkeyup="if(window.event.keyCode==13){checkLogin()}">
        <button class="login-btn" onclick="checkLogin()">ì ‘ì†í•˜ê¸°</button>
        <p id="login-msg" style="color:var(--primary); margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="app-content" class="container">
    <header>
        <h1>MUSICDEAL <span>ANALYTICS</span></h1>
        <div class="header-controls">
            <div class="date-badge">ìµœì¢… ì—…ë°ì´íŠ¸: <span id="header-date">-</span></div>
            <div class="toggle-wrapper">
                <label class="switch">
                    <input type="checkbox" id="revenue-toggle" onchange="toggleRevenue()">
                    <span class="slider"></span>
                </label>
                <label for="revenue-toggle">ğŸ’° ìˆ˜ìµ ë¶„ì„</label>
            </div>
        </div>
    </header>

    <div class="summary-grid" id="kpi-container">
        <div class="kpi-card" id="card-market" style="border-top: 4px solid var(--green);">
            <span class="kpi-label">ğŸ’° Market Size (Top 100 Only) <span class="info-icon" data-tooltip="ğŸ“‰ ìœ íŠœë¸Œ Top 100 ê¸°ì¤€ (íƒ€ í”Œë«í¼ ì œì™¸)
            
            [ê³„ì‚° ë¡œì§]
            1. YouTube Daily MV: ì¡°íšŒìˆ˜ Ã— ë‹¨ê°€
            2. YouTube Weekly: (ì¡°íšŒìˆ˜ Ã· 7) Ã— ë‹¨ê°€
            3. YouTube Trending: ì¼ê°„ ì¦ê°ë¶„ Ã— ë‹¨ê°€
            * Melon, Genie, Spotify ë“± íƒ€ í”Œë«í¼ì€ ìˆ˜ìµ ê³„ì‚°ì—ì„œ ì œì™¸ë¨">i</span></span>
            <div class="kpi-value money" id="total-revenue">-</div>
            <div class="kpi-sub">ìœ íŠœë¸Œ ì°¨íŠ¸ ë‚´ ê³¡ë“¤ì˜ ì¼ê°„ ì¶”ì • ë§¤ì¶œ</div>
        </div>
        <div class="kpi-card" id="card-kr">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR Revenue Share</span>
            <div class="kpi-value kr" id="kr-revenue">-</div>
            <div class="kpi-sub">í•œêµ­ ìœ íŠœë¸Œ ì°¨íŠ¸ ë§¤ì¶œ</div>
        </div>
        <div class="kpi-card" id="card-us">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US Revenue Share</span>
            <div class="kpi-value us" id="us-revenue">-</div>
            <div class="kpi-sub">ë¯¸êµ­ ìœ íŠœë¸Œ ì°¨íŠ¸ ë§¤ì¶œ</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡°ğŸ‡· KR MV Entry Cut</span>
            <div class="kpi-value kr" id="kr-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì 100ìœ„ ì¡°íšŒìˆ˜</div>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">ğŸ‡ºğŸ‡¸ US MV Entry Cut</span>
            <div class="kpi-value us" id="us-mv-cut">-</div>
            <div class="kpi-sub">ì˜¤ëŠ˜ì 100ìœ„ ì¡°íšŒìˆ˜</div>
        </div>
        <div class="kpi-card" id="card-dup">
            <span class="kpi-label">âš ï¸ Global Duplicate Blocked</span>
            <div class="kpi-value" id="dup-blocked" style="color:var(--primary)">-</div>
            <div class="kpi-sub">KR/US ì¤‘ë³µ íŠ¸ë Œë”© ì˜ìƒ ìˆ˜</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('daily', this)">ğŸ“… ë°ì¼ë¦¬ & ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="openTab('trend', this)">ğŸ“ˆ ì›”ê°„/ì—°ê°„ ì¶”ì´</button>
        <button class="tab-btn" onclick="openTab('cross', this)">ğŸ”— í¬ë¡œìŠ¤ ì°¨íŠ¸</button>
        <button class="tab-btn" onclick="openTab('shorts-strategy', this)">âš¡ ì‡¼ì¸  ë°”ì´ëŸ´</button>
        <button class="tab-btn" onclick="openTab('long-run', this)">ğŸ§Ÿ ë¡±ëŸ°(ì¢€ë¹„) ì§€ìˆ˜</button>
    </div>

    <div id="daily" class="tab-content active">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ë‚ ì§œ</label><input type="date" id="dailyDate" onchange="renderDaily()"></div>
                <div class="control-group"><label>êµ­ê°€/í”Œë«í¼</label>
                    <select id="countryFilter" onchange="updateChartFilter()">
                        <option value="ALL">ì „ì²´ (All Platforms)</option>
                        <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (YouTube/Melon/Genie)</option>
                        <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (YouTube/Billboard)</option>
                    </select>
                </div>
                <div class="control-group"><label>ì°¨íŠ¸</label><select id="chartFilter" onchange="renderDaily()"><option value="ALL">ì „ì²´ ì°¨íŠ¸</option></select></div>
                <div class="search-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="dailySearch" placeholder="ê³¡ëª… / ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." onkeyup="renderDaily()">
                </div>
            </div>
            <div class="table-container">
                <table id="dailyTable">
                    <thead><tr><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ì œëª©</th><th>ì•„í‹°ìŠ¤íŠ¸</th><th>ì¡°íšŒìˆ˜/ìŠ¤íŠ¸ë¦¬ë°</th><th>ì „ì¼ ëŒ€ë¹„ (Delta)</th><th id="th-daily-rev">ì˜ˆìƒ ìˆ˜ìµ (Daily)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="trend" class="tab-content">
        <div class="card">
            <h3>ğŸ“ˆ êµ¬ê°„ë³„ ì§„ì… í•„ìš” ìˆ˜ì¹˜ (ëˆ„ì  í‰ê· )</h3>
            <div class="table-container"><table id="trendTable"><thead><tr><th>ê¸°ê°„</th><th>ì°¨íŠ¸</th><th>1~10ìœ„</th><th>11~20ìœ„</th><th>21~30ìœ„</th><th>31~40ìœ„</th><th>41~50ìœ„</th><th>ì§„ì… ì»· (100ìœ„)</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="cross" class="tab-content">
        <div class="card">
            <div class="controls"><h3>ğŸ”— ë©€í‹° ì°¨íŠ¸ ì§„ì… ì•„í‹°ìŠ¤íŠ¸</h3><div class="search-wrapper"><span class="search-icon">ğŸ”</span><input type="text" id="crossSearch" placeholder="ê²€ìƒ‰..." onkeyup="renderCross()"></div></div>
            <div class="table-container"><table id="crossTable"><thead><tr><th>ì•„í‹°ìŠ¤íŠ¸ - ë…¸ë˜</th><th>ì§„ì… ì°¨íŠ¸ ìˆ˜</th><th>í¬í•¨ëœ ì°¨íŠ¸ ëª©ë¡</th><th>ìµœê³  ìˆœìœ„</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="shorts-strategy" class="tab-content">
        <div class="card">
            <div class="controls">
                <div class="control-group"><label>ê¸°ì¤€ì¼</label><input type="date" id="shortsDate" onchange="renderShortsStrategy()"></div>
                <div class="control-group"><label>ì°¨íŠ¸</label><select id="shortsChartSelect" onchange="renderShortsStrategy()"><option value="KR_Daily_Top_Shorts">ğŸ‡°ğŸ‡· í•œêµ­ ì‡¼ì¸ </option><option value="US_Daily_Top_Shorts">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì‡¼ì¸ </option></select></div>
                <div style="margin-left:auto;"><button class="tab-btn" style="padding:6px 15px; font-size:0.8rem;" onclick="setShortsPeriod(1, this)">ì¼ê°„</button><button class="tab-btn" style="padding:6px 15px; font-size:0.8rem;" onclick="setShortsPeriod(7, this)">ì£¼ê°„</button></div>
            </div>
            <div id="shortsKPI" style="padding:20px; background:#FFF8E1; border-left:5px solid #FFC107; border-radius:8px; margin-bottom:30px; color:#333;"></div>
            <div class="insight-grid" style="margin-bottom:30px;">
                <div class="chart-box"><div class="chart-header">ğŸ”¥ Viral Map (ì‚°ì ë„)</div><canvas id="scatterChart"></canvas></div>
                <div class="chart-box" style="height:400px;"><div class="chart-header">ğŸš€ ê¸‰ìƒìŠ¹ ë£¨í‚¤ (í™”ë ¥ Top)</div><div style="overflow-y:auto; flex:1;"><table id="rookieTable"><thead><tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>ì†ë„</th></tr></thead><tbody></tbody></table></div></div>
            </div>
            <div class="table-container"><table id="shortsTable"><thead></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="long-run" class="tab-content">
        <div class="card">
            <div class="info-box" style="background:#E3F2FD; border-left:4px solid #2196F3; padding:15px; margin-bottom:20px; color:#0D47A1;"><strong>ğŸ§Ÿ ë¡±ëŸ° ì§€ìˆ˜ (Long-Run Power)</strong><br>ì°¨íŠ¸ì—ì„œ ì–¼ë§ˆë‚˜ ì˜¤ë«ë™ì•ˆ ìƒì¡´í•˜ë©° ì„±ê³¼ë¥¼ ë‚´ëŠ”ê°€ (ê³„ì‚°ì‹: ì²´ë¥˜ì¼ Ã— 1000 Ã· í‰ê·  ìˆœìœ„)</div>
            <div class="table-container"><table id="zombieTable"><thead><tr><th>ê³¡ëª…</th><th>ì²´ë¥˜ì¼</th><th>í‰ê· ìˆœìœ„</th><th>ë¡±ëŸ°ì ìˆ˜</th><th>ìƒíƒœ</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div class="footer-info">
        <h4>ğŸ’° ìˆ˜ìµ ì‚°ì¶œ ê¸°ì¤€ (Top 100 Est.)</h4>
        <div style="margin:10px 0;">
            <span class="price-tag">ğŸ‡°ğŸ‡· Art Track: <span>â‚©5</span></span>
            <span class="price-tag">ğŸ‡°ğŸ‡· MV Long: <span>â‚©2.5</span></span>
            <span class="price-tag">ğŸ‡ºğŸ‡¸ Art Track: <span>â‚©10</span></span>
            <span class="price-tag">ğŸ‡ºğŸ‡¸ MV Long: <span>â‚©4</span></span>
        </div>
        <p>* ë³¸ ë°ì´í„°ëŠ” <b>YouTube Chart</b> ê¸°ì¤€ìœ¼ë¡œë§Œ ìˆ˜ìµì„ ì¶”ì •í•©ë‹ˆë‹¤. (Melon, Genie, Spotify, Billboard ë°ì´í„°ëŠ” ìˆ˜ìµ ê³„ì‚° ì œì™¸)</p>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><h2 id="modalTitle">Title</h2><p id="modalArtist">Artist</p></div>
            <div style="display:flex; align-items:center; gap:20px;">
                <a id="ytLink" href="#" target="_blank" class="yt-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white" style="margin-right:5px;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg> Watch Now
                </a>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                <div class="kpi-card" id="modal-card-rev" style="border-left:5px solid var(--green);">
                    <span class="kpi-label">ğŸ’° ì¶”ì • ëˆ„ì  ìˆ˜ìµ (YouTube Only)</span>
                    <div class="kpi-value money" id="mRevenue">-</div>
                </div>
                <div class="kpi-card"><span class="kpi-label">ğŸ† ìµœê³  ìˆœìœ„</span><div class="kpi-value" id="mBestRank">-</div></div>
                <div class="kpi-card"><span class="kpi-label">ğŸ”¥ ìµœê³  ìˆ˜ì¹˜</span><div class="kpi-value" id="mPeakView">-</div></div>
            </div>
            <div class="insight-grid">
                <div class="chart-box"><div class="chart-header" id="viewChartTitle">ğŸ“Š ì¼ê°„ ì¶”ì´</div><canvas id="viewChart"></canvas></div>
                <div class="chart-box"><div class="chart-header">ğŸ† ìˆœìœ„ ë³€ë™</div><canvas id="rankChart"></canvas></div>
            </div>
            <div class="card" style="margin-top:60px; padding:0; border:none; box-shadow:none;">
                <h3 style="margin-bottom:15px; color:#000;">ğŸ“‹ ìƒì„¸ ì´ë ¥</h3>
                <div class="table-container">
                    <table id="historyTable"><thead><tr><th>ë‚ ì§œ</th><th>ì°¨íŠ¸</th><th>ìˆœìœ„</th><th>ìˆ˜ì¹˜</th><th>ì¦ê°</th><th id="th-hist-rev">ìˆ˜ìµ (Daily)</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const ACCESS_KEY = "musicdeal2025"; 
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRR9sg-5znnm3vm2rpUkfkKE4GeYJnUmtW76-5BzjFNeaYnHZ_jLQe2oSCvQLYc861AEgLUs_nqXJgx/pub?gid=0&single=true&output=csv";
    const RATES = { KR: { song: 5.0, mv: 2.5 }, US: { song: 10.0, mv: 4.0 } };

    let rawData = [], uniqueCharts = [];
    let scatterChartInst=null, vChart=null, rChart=null;
    let shortsPeriod = 1;
    let showRevenue = false; // ê¸°ë³¸ê°’ OFF

    function checkLogin() {
        if(document.getElementById('passwordInput').value === ACCESS_KEY) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            setTimeout(()=>document.getElementById('app-content').style.opacity='1', 100);
            updateVisibility(); 
            loadData();
            localStorage.setItem('md_auth', 'true');
        } else {
            document.getElementById('login-msg').innerText = "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
        }
    }
    if(localStorage.getItem('md_auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('app-content').style.opacity = '1';
        updateVisibility();
        loadData();
    }

    function toggleRevenue() {
        showRevenue = document.getElementById('revenue-toggle').checked;
        updateVisibility();
    }

    function updateVisibility() {
        const kpiContainer = document.getElementById('kpi-container');
        const idsToHide = ['card-market', 'card-kr', 'card-us', 'card-dup'];
        if (showRevenue) {
            kpiContainer.classList.remove('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'block');
        } else {
            kpiContainer.classList.add('no-revenue');
            idsToHide.forEach(id => document.getElementById(id).style.display = 'none');
        }
        const thDaily = document.getElementById('th-daily-rev');
        if(thDaily) thDaily.style.display = showRevenue ? '' : 'none';
        renderDaily();
    }

    function loadData() {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(t=>{
            rawData = parseCSV(t);
            calculateStats();
            if(rawData.length > 0) {
                const lastDate = rawData[rawData.length-1].Date;
                document.getElementById("header-date").innerText = lastDate;
                document.getElementById("dailyDate").value = lastDate;
                document.getElementById("shortsDate").value = lastDate;
                uniqueCharts = [...new Set(rawData.map(d => d.Chart))].sort();
                updateChartFilter();
                updateSummary(lastDate);
                renderDaily(); renderTrend(); renderCross(); renderShortsStrategy(); renderLongRun();
            }
        });
    }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if(!row || row.length < 7) continue;
            const getCol = (idx) => row[idx] ? row[idx].replace(/^"|"$/g, "").trim() : "";
            
            let vStr = getCol(6).replace(/,/g, ""); 
            let vid = getCol(5); 
            let title = getCol(3);
            let artist = getCol(4);
            if(!vid || vid.length < 5) vid = null; 

            data.push({
                Date: getCol(0), Chart: getCol(1), Rank: parseInt(getCol(2)), Title: title, Artist: artist, Video_ID: vid, Views: parseInt(vStr) || 0, Delta: 0, Revenue: 0
            });
        }
        return data.sort((a,b) => new Date(a.Date) - new Date(b.Date));
    }

    function calculateStats() {
        const map = {};
        rawData.forEach(d => {
            const idKey = d.Video_ID ? d.Video_ID : `${d.Title}|${d.Artist}`;
            const key = `${d.Chart}|${idKey}`;
            if(!map[key]) map[key] = []; map[key].push(d);
        });

        Object.values(map).forEach(list => {
            list.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            for(let i=0; i<list.length; i++) {
                const curr = list[i];
                const prev = i > 0 ? list[i-1] : null;
                if(prev) curr.Delta = curr.Views - prev.Views; else curr.Delta = 0; 

                // [ìˆ˜ìµ ê³„ì‚°] ìœ íŠœë¸Œê°€ ì•„ë‹Œ ì°¨íŠ¸ëŠ” ë¬´ì¡°ê±´ 0ì› ì²˜ë¦¬
                const isNonYouTube = curr.Chart.includes("Melon") || curr.Chart.includes("Genie") || curr.Chart.includes("Spotify") || curr.Chart.includes("Billboard");
                
                if(curr.Chart.includes("Shorts") || isNonYouTube) {
                    curr.Revenue = 0;
                } else {
                    let rate = 0;
                    if(curr.Chart.includes("US")) {
                        rate = curr.Chart.includes("Songs") ? RATES.US.song : RATES.US.mv;
                    } else if(curr.Chart.includes("KR")) {
                        rate = curr.Chart.includes("Songs") ? RATES.KR.song : RATES.KR.mv;
                    }

                    if(curr.Chart.includes("Weekly")) {
                        curr.Revenue = Math.round((curr.Views / 7) * rate); 
                    } else if(curr.Chart.includes("Trending")) {
                        curr.Revenue = Math.round(Math.max(0, curr.Delta) * rate); 
                    } else {
                        curr.Revenue = Math.round(curr.Views * rate);
                    }
                }
            }
        });
    }

    function updateSummary(date) {
        const todayData = rawData.filter(d => d.Date === date);
        const trendingMap = {};
        let krSum = 0, usSum = 0;
        let totalMarketSize = 0;
        let duplicateCount = 0;

        todayData.forEach(d => {
            if(d.Revenue === 0) return; // ìœ íŠœë¸Œ ì™¸ ì°¨íŠ¸ ë° Shorts ì œì™¸

            let rev = d.Revenue; 
            if(d.Chart.includes("US")) usSum += rev; else krSum += rev;

            if(d.Chart.includes("Trending")) {
                const idKey = d.Video_ID ? d.Video_ID : `${d.Title}|${d.Artist}`;
                if(!trendingMap[idKey]) {
                    trendingMap[idKey] = rev;
                } else {
                    duplicateCount++;
                    if(rev > trendingMap[idKey]) {
                        trendingMap[idKey] = rev;
                    }
                }
            } else {
                totalMarketSize += rev;
            }
        });

        totalMarketSize += Object.values(trendingMap).reduce((a,b)=>a+b, 0);

        document.getElementById("total-revenue").innerText = "â‚©" + totalMarketSize.toLocaleString();
        document.getElementById("kr-revenue").innerText = "â‚©" + krSum.toLocaleString();
        document.getElementById("us-revenue").innerText = "â‚©" + usSum.toLocaleString();
        document.getElementById("dup-blocked").innerText = duplicateCount + "ê°œ";

        // Entry Cut: ìœ íŠœë¸Œ ì°¨íŠ¸ë§Œ ëŒ€ìƒìœ¼ë¡œ í•¨
        const getCut = (chart) => {
            const cutRank = chart.includes("Trending") ? 20 : (chart.includes("Shorts") ? 50 : 100);
            const item = rawData.find(d => d.Date === date && d.Chart === chart && d.Rank === cutRank);
            return item ? item.Views.toLocaleString() : "-";
        };
        document.getElementById("kr-mv-cut").innerText = getCut("KR_Daily_Top_MV");
        document.getElementById("us-mv-cut").innerText = getCut("US_Daily_Top_MV");
    }

    function openTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    function updateChartFilter() {
        const country = document.getElementById("countryFilter").value;
        const chartSelect = document.getElementById("chartFilter");
        chartSelect.innerHTML = '<option value="ALL">ì „ì²´ ì°¨íŠ¸</option>';
        uniqueCharts.forEach(chart => {
            // [í•„í„° ë¡œì§ ìˆ˜ì •] Melon, Genie -> KR / Billboard -> US / Spotify -> Global or US/KR
            let isMatch = false;
            if(country === "ALL") isMatch = true;
            else if(country === "KR") {
                if(chart.startsWith("KR") || chart.includes("Melon") || chart.includes("Genie") || chart.includes("Spotify_KR")) isMatch = true;
            }
            else if(country === "US") {
                if(chart.startsWith("US") || chart.includes("Billboard") || chart.includes("Spotify_US")) isMatch = true;
            }
            
            if(isMatch) {
                const opt = document.createElement("option"); opt.value = chart; opt.innerText = chart; chartSelect.appendChild(opt);
            }
        });
        renderDaily();
    }

    function renderDaily() {
        const date = document.getElementById("dailyDate").value;
        const country = document.getElementById("countryFilter").value;
        const chartFilter = document.getElementById("chartFilter").value;
        const search = document.getElementById("dailySearch").value.toLowerCase();
        const tbody = document.querySelector("#dailyTable tbody");
        
        let data = rawData.filter(d => d.Date === date);
        
        if(country !== "ALL") {
            if(country === "KR") data = data.filter(d => d.Chart.startsWith("KR") || d.Chart.includes("Melon") || d.Chart.includes("Genie") || d.Chart.includes("Spotify_KR"));
            else if(country === "US") data = data.filter(d => d.Chart.startsWith("US") || d.Chart.includes("Billboard") || d.Chart.includes("Spotify_US"));
        }
        if(chartFilter !== "ALL") data = data.filter(d => d.Chart === chartFilter);
        if(search) data = data.filter(d => d.Title.toLowerCase().includes(search) || d.Artist.toLowerCase().includes(search));

        data.sort((a,b) => {
            if(a.Chart < b.Chart) return -1;
            if(a.Chart > b.Chart) return 1;
            return a.Rank - b.Rank;
        });

        const totalRev = data.reduce((acc, d) => acc + d.Revenue, 0);
        const colSpan = showRevenue ? 6 : 5;
        const totalCell = showRevenue ? `<td style="color:#32D74B">â‚©${totalRev.toLocaleString()}</td>` : '';

        let html = `
            <tr class="sum-row">
                <td colspan="${colSpan}">âˆ‘ ì„ íƒëœ í•­ëª© í•©ê³„</td>
                ${totalCell}
            </tr>
        `;

        html += data.map(d => {
            const idKey = d.Video_ID ? d.Video_ID : `${d.Artist}|${d.Title}`; 
            let delta = d.Delta > 0 ? `<span class="rank-up">â–²${d.Delta.toLocaleString()}</span>` : (d.Delta < 0 ? `<span class="rank-down">â–¼${Math.abs(d.Delta).toLocaleString()}</span>` : "-");
            
            // ì¡°íšŒìˆ˜ ì—†ëŠ” ì°¨íŠ¸ ì²˜ë¦¬ (0ì´ë©´ í•˜ì´í”ˆ)
            let viewStr = d.Views > 0 ? d.Views.toLocaleString() : "-";

            let revCell = "";
            if (showRevenue) {
                // ìˆ˜ìµ 0ì›ì¸ íƒ€ í”Œë«í¼ì€ íë¦¬ê²Œ í‘œì‹œ
                let revStr = d.Revenue > 0 ? `â‚©${d.Revenue.toLocaleString()}` : `<span style='color:#ccc; font-size:0.8em'>-</span>`;
                revCell = `<td class="money-text">${revStr}</td>`;
            }

            return `<tr onclick="openDetail('${idKey}')">
                <td>${d.Chart}</td><td>${d.Rank}</td><td class="song-title">${d.Title}</td><td>${d.Artist}</td><td style="font-weight:bold">${viewStr}</td><td>${delta}</td>${revCell}</tr>`;
        }).join("");
        tbody.innerHTML = html || `<tr><td colspan="7" style="text-align:center; padding:30px; color:#666;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    // Trend, Cross, Shorts, LongRun functions (No logic change needed for view, just handle 0 revenue)
    function renderTrend() {
        const tbody = document.querySelector("#trendTable tbody");
        const stats = {};
        rawData.forEach(d => {
            // [ë°©ì–´] ì°¨íŠ¸ ì„±ê²©ì´ ë„ˆë¬´ ë‹¤ë¥´ë©´ ì œì™¸? ì¼ë‹¨ ë‹¤ ë³´ì—¬ì¤Œ.
            const key = d.Date.substring(0, 7) + "|" + d.Chart;
            if(!stats[key]) stats[key] = { s:[0,0,0,0,0,0], c:[0,0,0,0,0,0], sumCut:0, cntCut:0 };
            const s = stats[key];
            let idx = -1;
            if(d.Rank<=10) idx=0; else if(d.Rank<=30) idx=1; else if(d.Rank<=50) idx=2; else if(d.Rank<=70) idx=3; else if(d.Rank<=100) idx=4;
            if(idx>=0) { s.s[idx]+=d.Views; s.c[idx]++; }
            const cutRank = 50; // ê¸°ë³¸ 50ìœ„
            if(d.Rank===cutRank) { s.sumCut+=d.Views; s.cntCut++; }
        });
        tbody.innerHTML = Object.keys(stats).sort().reverse().map(k => {
            const [m, c] = k.split("|"); const s = stats[k];
            let cols = ""; for(let i=0; i<5; i++) cols += `<td>${s.c[i]?Math.round(s.s[i]/s.c[i]).toLocaleString():"-"}</td>`;
            return `<tr><td>${m}</td><td style="text-align:left">${c}</td>${cols}<td class="highlight-cut">${s.cntCut?Math.round(s.sumCut/s.cntCut).toLocaleString():"-"}</td></tr>`;
        }).join("");
    }

    // Cross, ShortsStrategy, LongRun ... (ìƒëµ ì—†ì´ ê¸°ì¡´ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    function renderCross() {
        const tbody = document.querySelector("#crossTable tbody");
        const search = document.getElementById("crossSearch").value.toLowerCase();
        const lastDate = rawData[rawData.length-1].Date;
        const data = rawData.filter(d => d.Date === lastDate);
        const map = {};
        data.forEach(d => { 
            const k = d.Video_ID ? d.Video_ID : `${d.Artist}|${d.Title}`;
            if(!map[k]) map[k] = { artist: d.Artist, title: d.Title, charts: [], minRank: 999, id: k }; 
            map[k].charts.push(d.Chart); if(d.Rank < map[k].minRank) map[k].minRank = d.Rank; 
        });
        const crosses = Object.values(map).filter(v => v.charts.length > 1).sort((a,b) => b.charts.length - a.charts.length);
        let html = crosses.filter(v => v.title.toLowerCase().includes(search) || v.artist.toLowerCase().includes(search)).map(v => 
            `<tr onclick="openDetail('${v.id}')"><td class="song-title">${v.title} (${v.artist})</td><td style="font-weight:bold; color:var(--primary)">${v.charts.length}ê°œ</td><td>${v.charts.join(", ")}</td><td>${v.minRank}ìœ„</td></tr>`
        ).join("");
        tbody.innerHTML = html || `<tr><td colspan="4" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>`;
    }

    function setShortsPeriod(days, btn) { shortsPeriod = days; renderShortsStrategy(); }
    function renderShortsStrategy() {
        const date = document.getElementById("shortsDate").value;
        const chartName = document.getElementById("shortsChartSelect").value;
        const data = rawData.filter(d => d.Date === date && d.Chart === chartName);
        if(data.length === 0) { document.getElementById("shortsKPI").innerHTML = "ë°ì´í„° ì—†ìŒ"; return; }
        const top10 = data.filter(d => d.Rank <= 10 && d.Delta > 0);
        const avgSpeed = top10.length ? Math.round(top10.reduce((a,b)=>a+b.Delta,0)/top10.length) : 0;
        document.getElementById("shortsKPI").innerHTML = `<strong>ğŸ’¡ Insight:</strong> Top 10 í‰ê· í™”ë ¥ <span style="color:var(--primary)">+${avgSpeed.toLocaleString()}</span> / ì¼`;
        if(scatterChartInst) scatterChartInst.destroy();
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const points = data.filter(d => d.Delta > 0).map(d => ({ x: d.Views, y: d.Delta, title: d.Title, rank: d.Rank }));
        scatterChartInst = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Songs', data: points, backgroundColor: p=>p.raw.rank<=10?'#E62117':(p.raw.rank<=50?'#1A73E8':'#aaa') }] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: {type:'logarithmic', title:{display:true, text:'ëˆ„ì '}}, y: {title:{display:true, text:'ì¼ê°„ ìƒì„±'}} }, plugins: { tooltip: { callbacks: { label: c => `${c.raw.rank}ìœ„. ${c.raw.title}` } } } } });
        const rookies = data.filter(d => d.Rank > 20 && d.Delta > 0).sort((a,b) => b.Delta - a.Delta);
        document.querySelector("#rookieTable tbody").innerHTML = rookies.slice(0, 10).map(d => {
            const idKey = d.Video_ID ? d.Video_ID : `${d.Artist}|${d.Title}`;
            return `<tr onclick="openDetail('${idKey}')"><td>${d.Rank}</td><td style="color:#333">${d.Title}</td><td style="color:var(--primary)">+${(d.Delta*shortsPeriod).toLocaleString()}</td></tr>`;
        }).join("");
        const tbody = document.querySelector("#shortsTable tbody");
        let html = "";
        for(let i=0; i<5; i++) {
            const s = i*10+1; const e = (i+1)*10;
            const seg = data.filter(d => d.Rank >= s && d.Rank <= e);
            const dSeg = seg.filter(d => d.Delta > 0);
            const avgD = dSeg.length ? Math.round(dSeg.reduce((a,b)=>a+b.Delta,0)/dSeg.length) : 0;
            html += `<tr><td>${s}~${e}ìœ„</td><td>${(seg.length?Math.round(seg.reduce((a,b)=>a+b.Views,0)/seg.length):0).toLocaleString()}</td><td style="color:var(--primary); font-weight:bold">+${avgD.toLocaleString()}</td></tr>`;
        }
        tbody.innerHTML = html;
    }

    function renderLongRun() {
        const map = {}; rawData.forEach(d => { 
            const idKey = d.Video_ID ? d.Video_ID : `${d.Artist}|${d.Title}`;
            const k=`${d.Chart}|${idKey}`; 
            if(!map[k]) map[k]={c:0, r:0, t:d.Title, a:d.Artist, v:idKey}; 
            map[k].c++; map[k].r+=d.Rank; 
        });
        const zombies = Object.entries(map).map(([k,v]) => { const [c, vid] = k.split("|"); const ar=Math.round(v.r/v.c); const s=Math.round(v.c*1000/ar); return {chart:c, title:v.t, artist:v.a, days:v.c, ar, s, vid}; }).sort((a,b)=>b.s-a.s).slice(0,20);
        document.querySelector("#zombieTable tbody").innerHTML = zombies.map(z => `<tr onclick="openDetail('${z.vid}')"><td style="color:#333">${z.title}</td><td>${z.days}ì¼</td><td>${z.ar}ìœ„</td><td style="color:var(--blue); font-weight:bold">${z.s}</td><td>${z.s>=2000?'ğŸ‘‘ God':(z.s>=1000?'ğŸ§Ÿ Zombie':'ğŸŒ±')}</td></tr>`).join("");
    }

    function openDetail(idKey) {
        document.getElementById("detailModal").style.display = "block";
        
        const revCard = document.getElementById('modal-card-rev');
        const revTh = document.getElementById('th-hist-rev');
        if(showRevenue) { revCard.style.display = 'block'; revTh.style.display = ''; } 
        else { revCard.style.display = 'none'; revTh.style.display = 'none'; }

        let hist;
        if(idKey.includes("|")) {
            const [artist, title] = idKey.split("|");
            hist = rawData.filter(d => d.Artist === artist && d.Title === title).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        } else {
            hist = rawData.filter(d => d.Video_ID === idKey).sort((a,b)=>new Date(b.Date)-new Date(a.Date));
        }

        if(hist.length === 0) return;
        const info = hist[0];
        document.getElementById("modalTitle").innerText = info.Title;
        document.getElementById("modalArtist").innerText = info.Artist;

        const ytBtn = document.getElementById("ytLink");
        if(info.Video_ID && info.Video_ID.length > 5) {
            ytBtn.href = `https://www.youtube.com/watch?v=${info.Video_ID}`;
            ytBtn.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="white" style="margin-right:5px;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg> Watch Video`;
        } else {
            const query = encodeURIComponent(`${info.Artist} ${info.Title}`);
            ytBtn.href = `https://www.youtube.com/results?search_query=${query}`;
            ytBtn.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="white" style="margin-right:5px;"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> Search on YouTube`;
        }

        const bestRank = Math.min(...hist.map(d=>d.Rank));
        const peakView = Math.max(...hist.map(d=>d.Views));
        
        const dateMap = {};
        hist.forEach(d => {
            if(!dateMap[d.Date]) dateMap[d.Date] = [];
            dateMap[d.Date].push(d);
        });

        let totalRev = 0;
        Object.keys(dateMap).forEach(date => {
            const items = dateMap[date];
            const trendings = items.filter(i => i.Chart.includes("Trending"));
            const others = items.filter(i => !i.Chart.includes("Trending"));
            if (trendings.length > 0) totalRev += Math.max(...trendings.map(t => t.Revenue));
            others.forEach(o => totalRev += o.Revenue);
        });

        document.getElementById("mBestRank").innerText = bestRank + "ìœ„";
        document.getElementById("mPeakView").innerText = peakView.toLocaleString();
        document.getElementById("mRevenue").innerText = "â‚©" + totalRev.toLocaleString();
        
        const isShorts = hist[0].Chart.includes("Shorts");
        document.getElementById("viewChartTitle").innerText = isShorts ? "ğŸ“Š ì‡¼ì¸  ìƒì„±ëŸ‰ ì¶”ì´" : "ğŸ“Š ì¼ê°„ ì¡°íšŒìˆ˜ ì¶”ì´";
        
        if(vChart) vChart.destroy(); if(rChart) rChart.destroy();
        const dates = [...new Set(hist.map(d=>d.Date))].sort();
        const charts = [...new Set(hist.map(d=>d.Chart))];
        const colors = ['#E62117', '#1A73E8', '#F9A825', '#2E7D32'];
        const mkDs = (key) => charts.map((c,i) => ({ label: c, data: dates.map(dt => { const item=hist.find(h=>h.Date===dt&&h.Chart===c); return item?item[key]:null; }), borderColor:colors[i%4], tension:0.4, fill:false, spanGaps: true }));
        vChart = new Chart(document.getElementById('viewChart'), { type:'line', data:{labels:dates, datasets:mkDs('Views')}, options:{responsive:true, maintainAspectRatio:false} });
        rChart = new Chart(document.getElementById('rankChart'), { type:'line', data:{labels:dates, datasets:mkDs('Rank')}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{reverse:true}}} });
        
        document.querySelector("#historyTable tbody").innerHTML = hist.map(d => {
            let delta = d.Delta > 0 ? `+${d.Delta.toLocaleString()}` : (d.Delta < 0 ? `${d.Delta.toLocaleString()}` : "-");
            let viewStr = d.Views > 0 ? d.Views.toLocaleString() : "-";
            
            let revCell = "";
            if (showRevenue) {
                let revStr = d.Revenue > 0 ? `â‚©${d.Revenue.toLocaleString()}` : `<span style='color:#ccc; font-size:0.8em'>-</span>`;
                revCell = `<td style="color:var(--green)">${revStr}</td>`;
            }

            return `<tr><td>${d.Date}</td><td>${d.Chart}</td><td>${d.Rank}</td><td>${viewStr}</td><td style="color:${d.Delta>0?'var(--primary)':'inherit'}">${delta}</td>${revCell}</tr>`;
        }).join("");
    }
    function closeModal() { document.getElementById("detailModal").style.display = "none"; }
    window.onclick = function(e) { if(e.target == document.getElementById("detailModal")) closeModal(); }
</script>
</body>
</html>
